{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1>ä½¿ç”¨è€…å›é¥‹å•å·</h1>

<link rel="stylesheet" href="{% static 'css/feedback_form.css' %}">
<div class="mb-3">
  <label class="form-label">å­—é«”å¤§å°ï¼š</label>
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setFontSize('fs-6')">å°</button>
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setFontSize('fs-5')">ä¸­</button>
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setFontSize('fs-4')">å¤§</button>
</div>

<div id="questionnaire" class="fs-5">
    <form id="questionnaire-form" method="post" action="{% url 'submit_questionnaire' %}">
        {% csrf_token %}
        {% for question in questions %}
            <div class="container left-aligned-container bg-light p-5 text-start">
                <label><strong>{{ forloop.counter }}. {{ question.text }}</strong></label><br>

                {% if question.question_type == 'text' %}
                    <input type="text" name="question_{{ question.id }}" class="form-control">

                {% elif question.question_type == 'rating' %}
                    {% for i in "12345" %}
                        <label class="me-2">
                            <input type="radio" name="question_{{ question.id }}" value="{{ forloop.counter }}">
                            {{ forloop.counter }}
                        </label><br>
                    {% endfor %}

                {% elif question.question_type == 'radio' %}
                    {% for option in question.options.all %}
                        <label class="d-block">
                            <input type="radio" name="question_{{ question.id }}" value="{{ option.text }}">
                            {{ option.text }}
                        </label>
                    {% endfor %}

                {% elif question.question_type == 'checkbox' %}
                    {% for option in question.options.all %}
                        <label class="d-block">
                            <input type="checkbox" name="question_{{ question.id }}" value="{{ option.text }}">
                            {{ option.text }}
                        </label>
                    {% endfor %}

                {% elif question.question_type == 'select' %}
                    <select name="question_{{ question.id }}" class="form-select">
                        {% for option in question.options.all %}
                            <option value="{{ option.text }}">{{ option.text }}</option>
                        {% endfor %}
                    </select>
                {% endif %}
            </div>
        {% endfor %}
    </form>

    <div class="floating-bar-modern">
        <a href="{% url 'home' %}" class="modern-btn secondary">ğŸ  è¿”å›ä¸Šé </a>
        <button type="button" class="modern-btn primary" onclick="confirmSubmit()">ğŸš€ æäº¤å•å·</button>
    </div>
</div>

<!-- å­—é«”èª¿æ•´èˆ‡å–æ¶ˆå–®é¸åŠŸèƒ½ -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let isFormEdited = false;
    const form = document.getElementById("questionnaire-form");

    // âœ… å­—é«”å¤§å°èª¿æ•´åŠŸèƒ½
    window.setFontSize = function(sizeClass) {
      const container = document.getElementById('questionnaire');
      container.classList.remove('fs-4', 'fs-5', 'fs-6');
      container.classList.add(sizeClass);
    };

    // âœ… æ”¯æ´å–æ¶ˆå–®é¸é¸é …ï¼ˆä¸€å®šè¦æ”¾åœ¨ DOMContentLoaded å…§ï¼‰
    form.querySelectorAll('input[type=radio]').forEach(radio => {
      radio.addEventListener('click', function () {
        if (this.wasChecked) {
          this.checked = false;
          this.wasChecked = false;
          isFormEdited = true;  // â¬…ï¸ é€™é‚Šä¹Ÿè¦æ¨™è¨˜ç‚ºå·²ä¿®æ”¹ï¼
        } else {
          const radios = document.getElementsByName(this.name);
          radios.forEach(r => r.wasChecked = false);
          this.wasChecked = true;
        }
      });
    });

    // âœ… æ¨™è¨˜ä½¿ç”¨è€…æ˜¯å¦æœ‰ä¿®æ”¹è¡¨å–®ï¼ˆinput/change éƒ½ç®—ï¼‰
    form.querySelectorAll("input, textarea, select").forEach(el => {
      el.addEventListener("input", () => {
        isFormEdited = true;
      });
      el.addEventListener("change", () => {
        isFormEdited = true;
      });
    });

    // âœ… æ””æˆªåŸå§‹è¡¨å–®æäº¤ï¼Œç§»é™¤é›¢é–‹æç¤º
    form.addEventListener("submit", () => {
      window.onbeforeunload = null;
    });

    // âœ… è‹¥è¡¨å–®å·²ä¿®æ”¹ï¼Œé›¢é–‹æ™‚æç¤º
    window.onbeforeunload = function () {
      if (isFormEdited) {
        return "æ‚¨ç¢ºå®šè¦é›¢é–‹é é¢å—ï¼Ÿç›®å‰å¡«å¯«çš„è³‡æ–™å°‡æœƒéºå¤±ã€‚";
      }
    };
  });

  // âœ… æäº¤ç¢ºèªæç¤ºï¼ˆç¶å®šæµ®å‹•æŒ‰éˆ•ï¼‰
  function confirmSubmit() {
    const form = document.getElementById("questionnaire-form");
    if (confirm("æ‚¨ç¢ºå®šè¦é€å‡ºå•å·å—ï¼Ÿ")) {
        window.onbeforeunload = null;
        form.submit();  // æäº¤å¾Œç”±å¾Œç«¯æ±ºå®šå°å»å“ª
    }
}
</script>

{% endblock %}
