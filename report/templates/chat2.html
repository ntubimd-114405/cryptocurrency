{% extends 'base.html' %}
{% load static %}

{% block title %}AI èŠå¤©{% endblock %}

{% block main %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<div class="chat-container-page1">
  <div class="chat-messages">
    <div class="message bot">
      ğŸ‘‹ æ‚¨å¥½! æ­¡è¿ä½¿ç”¨ <strong>AI Agent</strong>ï¼Œè«‹åœ¨ä¸‹æ–¹è¼¸å…¥æ‚¨çš„å•é¡Œä¸¦é¸æ“‡æ¨¡çµ„é€²è¡Œåˆ†æã€‚
    </div>
  </div>

  <div class="module-select">
    <label><input type="checkbox" value="price"> ğŸ’° åƒ¹æ ¼</label>
    <label><input type="checkbox" value="news"> ğŸ“° æ–°è</label>
    <label><input type="checkbox" value="other"> ğŸ“Š å…¶ä»–ç¶“æ¿Ÿæ•¸æ“š</label>
    <label><input type="checkbox" value="questionnaire"> ğŸ§  å•å·</label>
  </div>

  <div class="chat-input">
    <input list="preset-questions" class="userInput-page1" placeholder="è¼¸å…¥è¨Šæ¯æˆ–é¸æ“‡å•é¡Œ..." />
    <datalist id="preset-questions"></datalist>
    <button class="sendBtn-page1" type="button">é€å‡º ğŸš€</button>
  </div>
</div>

<meta name="csrf-token" content="{{ csrf_token }}">

<style>
/* ==== å¤–å±¤å®¹å™¨ ==== */
.chat-container-page1 {
  width: 95%;
  max-width: 1400px;
  margin: 40px auto;
  background: linear-gradient(145deg, #ffffff, #f0f8ff);
  border: 1px solid #e0e7ff;
  border-radius: 28px;
  box-shadow: 0 10px 30px rgba(0, 102, 255, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.4);
  display: flex;
  flex-direction: column;
  height: 90vh;
  min-height: 600px;
  overflow: hidden;
  padding: 20px 24px;
  font-family: 'Inter', 'Noto Sans TC', sans-serif;
  backdrop-filter: blur(6px);
}

/* æ‰‹æ©Ÿè‡ªé©æ‡‰ */
@media (max-width: 768px) {
  .chat-container-page1 {
    width: 98%;
    height: 90vh;
    border-radius: 16px;
    min-height: 500px;
    padding: 16px;
  }
}

/* ==== è¨Šæ¯å€å¡Š ==== */
.chat-messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  min-height: 200px;
  background: #f9fafc;
  border-radius: 20px;
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.03);
  margin-bottom: 16px;
}

/* æ»¾å‹•æ¢å„ªåŒ– */
.chat-messages::-webkit-scrollbar {
  width: 6px;
}
.chat-messages::-webkit-scrollbar-thumb {
  background: #a5b4fc;
  border-radius: 3px;
}
.chat-messages::-webkit-scrollbar-track {
  background: transparent;
}

/* ==== è¨Šæ¯æ¨£å¼ ==== */
.message {
  margin-bottom: 14px;
  padding: 14px 18px;
  border-radius: 18px;
  max-width: 75%;
  word-wrap: break-word;
  font-size: 15px;
  line-height: 1.6;
  animation: fadeIn 0.25s ease forwards;
  box-shadow: 0 3px 8px rgba(0,0,0,0.04);
}
.message.user {
  background: linear-gradient(135deg, #dce9ff, #cfe8ff);
  align-self: flex-end;
  border: 1px solid #bcd4ff;
}
.message.bot {
  background: linear-gradient(135deg, #e4f4ff, #cdeeff);
  color: #0b3954;
  align-self: flex-start;
  border: 1px solid #b3e5fc;
}
.message.news {
  background: linear-gradient(135deg, #fff8dc, #fff3b0);
  color: #7a5200;
  border: 1px solid #ffe599;
}
.message.questionnaire {
  background: linear-gradient(135deg, #e9ffe5, #d1f7c5);
  color: #1b5e20;
  border: 1px solid #a5d6a7;
}
.message.other {
  background: linear-gradient(135deg, #f6e6ff, #e3ccff);
  color: #4a148c;
  border: 1px solid #ce93d8;
}
.message.summary {
  background: linear-gradient(135deg, #e4f4ff, #cdeeff);
  color: #0b3954;
  align-self: flex-start;
  border: 1px solid #b3e5fc;
}
/* å‡ºå ´å‹•ç•« */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ==== æ¨¡çµ„é¸æ“‡ ==== */
.module-select {
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
  margin-bottom: 12px;
  background: #f1f5f9;
  border-radius: 14px;
  padding: 10px 16px;
  border: 1px solid #e0e7ff;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
}
.module-select label {
  font-size: 15px;
  color: #334155;
  cursor: pointer;
  transition: transform 0.2s;
}
.module-select label:hover {
  transform: scale(1.05);
}
.module-select input[type="checkbox"] {
  accent-color: #3b82f6;
  margin-right: 6px;
  transform: scale(1.2);
}

/* ==== è¼¸å…¥å€ ==== */
.chat-input {
  display: flex;
  align-items: center;
  border-top: 1px solid #dbeafe;
  background: #f9fbff;
  border-radius: 16px;
  padding: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.02);
}
.chat-input input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid #dbeafe;
  border-radius: 20px;
  outline: none;
  font-size: 16px;
  background: #f1f5f9;
  transition: all 0.3s ease;
}
.chat-input input:focus {
  border-color: #3b82f6;
  background: #ffffff;
  box-shadow: 0 0 6px rgba(59,130,246,0.3);
}
.chat-input button {
  background: linear-gradient(135deg, #4facfe, #00c6ff);
  color: white;
  border: none;
  border-radius: 20px;
  padding: 10px 20px;
  font-size: 16px;
  margin-left: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 3px 10px rgba(0,198,255,0.3);
}
.chat-input button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0,198,255,0.4);
}

/* ==== Loading å‹•ç•« ==== */
.message.loading {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: 16px;
  background: #d0f0ff;
  border-radius: 12px;
  padding: 8px 14px;
  color: #0c4a6e;
}
.message.loading .dot {
  animation: blink 1s infinite alternate;
}
@keyframes blink {
  0% { opacity: 0.4; }
  100% { opacity: 1; }
}
.module-tags span {
  background: #e0e0e0;
  border-radius: 8px; /* è¼•åœ“è§’ */
  padding: 2px 6px;
  margin-right: 3px;
  display: inline-block;
}

/* æ¨¡çµ„é¸æ“‡å®¹å™¨ */
.module-select {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

/* æ¨¡çµ„é¸é …é¢¨æ ¼ */
.module-option {
  display: flex;
  align-items: center;
  padding: 6px 12px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  cursor: pointer;
  font-size: 14px;
  transition: 0.2s;
}

.module-option input[type="checkbox"] {
  margin-right: 6px;
  accent-color: #4f9cff; /* checkbox ä¸»è‰² */
}

.module-option:hover {
  background: linear-gradient(135deg, #f0f8ff, #e0f0ff);
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
  transform: translateY(-1px);
}

.userInput-page1 {
  flex: 1;
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid #ccc;
  font-size: 14px;
  outline: none;
  transition: 0.2s;
}

.userInput-page1:focus {
  border-color: #4f9cff;
  box-shadow: 0 0 5px rgba(79,156,255,0.4);
}

/* é€å‡ºæŒ‰éˆ•é¢¨æ ¼ */
.sendBtn-page1 {
  background: linear-gradient(135deg, #4f9cff, #007bff);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 8px 16px;
  cursor: pointer;
  font-weight: 500;
  transition: 0.2s;
}

.sendBtn-page1:hover {
  background: linear-gradient(135deg, #5fb3ff, #3399ff);
  transform: translateY(-1px);
}

.sendBtn-page1:active {
  transform: translateY(1px);
}

/* datalist ä¸‹æ‹‰é¸é …çš„é–“è· */
input[list]::-webkit-calendar-picker-indicator,
input[list]::-webkit-inner-spin-button,
input[list]::-webkit-clear-button {
  display: none;
}
.analyze-content {
  font-family: Inter, sans-serif;
  line-height: 1.6;
  color: #333;
}

.analyze-content .h1 { font-size: 1.8em; font-weight: 700; margin: 16px 0 8px; }
.analyze-content .h2 { font-size: 1.5em; font-weight: 600; margin: 14px 0 6px; }
.analyze-content .h3 { font-size: 1.3em; font-weight: 600; margin: 12px 0 6px; }
.analyze-content .h4 { font-size: 1.1em; font-weight: 500; margin: 10px 0 4px; color: #333; }
.analyze-content .h5,
.analyze-content .h6 { font-size: 1em; font-weight: 500; color: #555; }

.analyze-content .bold { font-weight: bold; }
.analyze-content .italic { font-style: italic; }
.analyze-content .percent { color: #007bff; font-weight: 600; }

.analyze-content blockquote.quote {
  border-left: 4px solid #007bff;
  padding-left: 12px;
  margin: 10px 0;
  color: #555;
  background: #f8f9fa;
  border-radius: 4px;
}

.analyze-content .code-block {
  background: #f5f5f5;
  padding: 10px;
  border-radius: 8px;
  font-family: 'Fira Code', monospace;
  overflow-x: auto;
}

.analyze-content .inline-code {
  background: #eee;
  padding: 2px 5px;
  border-radius: 4px;
  font-family: 'Fira Code', monospace;
}

.analyze-content ul,
.analyze-content ol {
  margin-left: 20px;
  padding-left: 10px;
}

.analyze-content .divider {
  border: none;
  border-top: 2px solid #ddd;
  margin: 12px 0;
}
</style>


<script>
(function(){
  const container = document.querySelector(".chat-container-page1");
  if (!container) return;

  const sendBtn = container.querySelector(".sendBtn-page1");
  const input = container.querySelector(".userInput-page1");
  const messages = container.querySelector(".chat-messages");
  const csrftoken = document.querySelector('[name=csrf-token]').content;


  window.chatCharts = window.chatCharts || [];

  // appendMessage æ”¹æˆæ”¯æ´ loading
function appendMessage(messagesContainer, text, sender, isTag=false, extraData=null,analyze="") {
  const div = document.createElement('div');
  div.className = `message ${sender}`;
  div.classList.add('message');
  const allLoadingDivs = messagesContainer.querySelectorAll('.loading');
  allLoadingDivs.forEach(d => d.remove());


  if (isTag) {
      text = text.replace(/^åˆ†é¡ï¼š/, '').trim();
      const tags = text.split(',').map(t => t.trim()).filter(t => t.length > 0);
      const tagContainer = document.createElement('div');
      tagContainer.className = 'module-tags';

      const labelSpan = document.createElement('span');
      labelSpan.textContent = 'åˆ†é¡ï¼š';
      labelSpan.style.fontWeight = 'bold';
      tagContainer.appendChild(labelSpan);

      if (tags.length > 0) {
          tags.forEach(t => {
              const span = document.createElement('span');
              span.textContent = t;
              tagContainer.appendChild(span);
          });
      } else {
          const span = document.createElement('span');
          span.textContent = 'ç„¡';
          tagContainer.appendChild(span);
      }

      div.appendChild(tagContainer);
  } else if (sender === "user") {
    const p = document.createElement('p');
    p.textContent = text;
    div.appendChild(p);
  } else if (sender === "news") {
      if (text) {
        const p = document.createElement('p');
        p.innerHTML = text; // ç”¨ textContent é¿å… XSS
        div.appendChild(p);
      }
      
      if (extraData) {
        const p2 = document.createElement('p');
        p2.innerHTML = extraData; // ç”¨ textContent é¿å… XSS
        div.appendChild(p2);
      }
      if (analyze) {
        console.log(analyze)
        const p3 = document.createElement('div'); // æ”¹æˆ divï¼Œæ›´å¥½æ§åˆ¶æ¨£å¼
        p3.classList.add("analyze-content");

        let formatted = analyze
          // ä¿ç•™ <br>
          .replace(/&lt;br&gt;/g, "<br>")
          // è™•ç†ç¨‹å¼ç¢¼å€å¡Š ```...```
          .replace(/```([\s\S]*?)```/g, '<pre class="code-block"><code>$1</code></pre>')
          // è¡Œå…§ç¨‹å¼ç¢¼ `...`
          .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
          // ç²—é«”æ–‡å­— **æ–‡å­—**
          .replace(/\*\*(.*?)\*\*/g, '<span class="bold">$1</span>')
          // æ–œé«”æ–‡å­— *æ–‡å­—* æˆ– _æ–‡å­—_
          .replace(/(\*|_)(.*?)\1/g, '<span class="italic">$2</span>')
          // è™•ç† ###### ~ #
          .replace(/(^|<br\s*\/?>)\s*######\s*(.*?)(?=<br|$)/g, '$1<div class="h6">$2</div>')
          .replace(/(^|<br\s*\/?>)\s*#####\s*(.*?)(?=<br|$)/g, '$1<div class="h5">$2</div>')
          .replace(/(^|<br\s*\/?>)\s*####\s*(.*?)(?=<br|$)/g, '$1<div class="h4">$2</div>')
          .replace(/(^|<br\s*\/?>)\s*###\s*(.*?)(?=<br|$)/g, '$1<div class="h3">$2</div>')
          .replace(/(^|<br\s*\/?>)\s*##\s*(.*?)(?=<br|$)/g, '$1<div class="h2">$2</div>')
          .replace(/(^|<br\s*\/?>)\s*#\s*(.*?)(?=<br|$)/g, '$1<div class="h1">$2</div>')
          // è™•ç†å¼•è¨€
          .replace(/^>\s*(.*)$/gm, '<blockquote class="quote">$1</blockquote>')
          // è™•ç†æœ‰åºæ¸…å–®
          .replace(/^\d+\.\s+(.*)$/gm, '<li>$1</li>')
          .replace(/(<li>.*<\/li>)(?!(\s*<li>|\s*<\/ul>))/gm, '<ol>$1</ol>')
          // è™•ç†ç„¡åºæ¸…å–® (- æˆ– *)
          .replace(/^[-*]\s+(.*)$/gm, '<li>$1</li>')
          .replace(/(<li>.*<\/li>)(?!(\s*<li>|\s*<\/ul>))/gm, '<ul>$1</ul>')
          // è™•ç†æ°´å¹³ç·š
          .replace(/^(-{3,}|\*{3,})$/gm, '<hr class="divider">')
          // ç™¾åˆ†æ¯”æ•¸å­—
          .replace(/(\d+(\.\d+)?%)/g, '<span class="percent">$1</span>');

        // å¡«å…¥ HTML
        p3.innerHTML = formatted;

        // æ’å…¥åˆ°ç›®æ¨™å€å¡Š
        div.appendChild(p3);
      }
  } else if (sender === "questionnaire") {
    if (text) {
      const p = document.createElement('p');
      p.innerHTML = text; // ç”¨ textContent é¿å… XSS
      div.appendChild(p);
    }
    
    if (extraData) {
      const p2 = document.createElement('p');
      p2.innerHTML = extraData; // ç”¨ textContent é¿å… XSS
      div.appendChild(p2);
    }
  } else if (sender === 'other') {
    const p = document.createElement('p');
    p.textContent = text;
    div.appendChild(p);


    if (extraData && Object.keys(extraData).length) {
      Object.keys(extraData).forEach(category => {
        const categoryData = extraData[category];
        if (categoryData.length > 0) {


          // å»ºç«‹ canvas
          const canvas = document.createElement('canvas');
          canvas.style.width = "100%";
          canvas.style.height = "300px";
          div.appendChild(canvas);

          // åˆ†çµ„è³‡æ–™
          const grouped = {};
          categoryData.forEach(item => {
            const key = item.symbol || item.indicator || item.metric;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(item);
          });

          // datasets
          const datasets = Object.keys(grouped).map(key => {
            const sorted = grouped[key].sort((a, b) => new Date(a.date) - new Date(b.date));
            return {
              label: key,
              data: sorted.map(d => ({ x: new Date(d.date), y: d.value })), // âœ… ä½¿ç”¨ Date ç‰©ä»¶
              fill: false,
              tension: 0.1,
              borderColor: '#' + Math.floor(Math.random()*16777215).toString(16)
            };
          });

          // å»ºç«‹ Chart
          new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { datasets },
            options: {
              animation: false,
              elements: { line: { tension: 0 } },
              responsive: true,
              plugins: {
                legend: { display: true }
              },
              scales: {
                x: {
                  type: 'time',
                  time: {
                    tooltipFormat: 'yyyy-MM-dd',
                    unit: 'day'
                  },
                  title: { display: true, text: 'æ—¥æœŸ' }
                },
                y: {
                  title: { display: true, text: 'æ•¸å€¼' },
                  beginAtZero: false
                }
              }
            }
          });
        }
      });
    }
    const p2 = document.createElement('div'); // æ”¹æˆ divï¼Œæ›´å¥½æ§åˆ¶æ¨£å¼
    p2.classList.add("analyze-content");

    let formatted = analyze
      // ä¿ç•™ <br>
      .replace(/&lt;br&gt;/g, "<br>")
      // è™•ç†ç¨‹å¼ç¢¼å€å¡Š ```...```
      .replace(/```([\s\S]*?)```/g, '<pre class="code-block"><code>$1</code></pre>')
      // è¡Œå…§ç¨‹å¼ç¢¼ `...`
      .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
      // ç²—é«”æ–‡å­— **æ–‡å­—**
      .replace(/\*\*(.*?)\*\*/g, '<span class="bold">$1</span>')
      // æ–œé«”æ–‡å­— *æ–‡å­—* æˆ– _æ–‡å­—_
      .replace(/(\*|_)(.*?)\1/g, '<span class="italic">$2</span>')
      // è™•ç† ###### ~ #
      .replace(/(^|<br\s*\/?>)\s*######\s*(.*?)(?=<br|$)/g, '$1<div class="h6">$2</div>')
      .replace(/(^|<br\s*\/?>)\s*#####\s*(.*?)(?=<br|$)/g, '$1<div class="h5">$2</div>')
      .replace(/(^|<br\s*\/?>)\s*####\s*(.*?)(?=<br|$)/g, '$1<div class="h4">$2</div>')
      .replace(/(^|<br\s*\/?>)\s*###\s*(.*?)(?=<br|$)/g, '$1<div class="h3">$2</div>')
      .replace(/(^|<br\s*\/?>)\s*##\s*(.*?)(?=<br|$)/g, '$1<div class="h2">$2</div>')
      .replace(/(^|<br\s*\/?>)\s*#\s*(.*?)(?=<br|$)/g, '$1<div class="h1">$2</div>')
      // è™•ç†å¼•è¨€
      .replace(/^>\s*(.*)$/gm, '<blockquote class="quote">$1</blockquote>')
      // è™•ç†æœ‰åºæ¸…å–®
      .replace(/^\d+\.\s+(.*)$/gm, '<li>$1</li>')
      .replace(/(<li>.*<\/li>)(?!(\s*<li>|\s*<\/ul>))/gm, '<ol>$1</ol>')
      // è™•ç†ç„¡åºæ¸…å–® (- æˆ– *)
      .replace(/^[-*]\s+(.*)$/gm, '<li>$1</li>')
      .replace(/(<li>.*<\/li>)(?!(\s*<li>|\s*<\/ul>))/gm, '<ul>$1</ul>')
      // è™•ç†æ°´å¹³ç·š
      .replace(/^(-{3,}|\*{3,})$/gm, '<hr class="divider">')
      // ç™¾åˆ†æ¯”æ•¸å­—
      .replace(/(\d+(\.\d+)?%)/g, '<span class="percent">$1</span>');

    // å¡«å…¥ HTML
    p2.innerHTML = formatted;

    // æ’å…¥åˆ°ç›®æ¨™å€å¡Š
    div.appendChild(p2);

  } else if (sender === "summary") {
    console.log("summary text:", text);
    if (text) {
      const p = document.createElement("p");
      p.classList.add("analyze-content");

      let formatted = text
        // æ¨™é¡Œ ###### ~ #
        .replace(/######\s*(.*)/g, '<div class="h6">$1</div>')
        .replace(/#####\s*(.*)/g, '<div class="h5">$1</div>')
        .replace(/####\s*(.*)/g, '<div class="h4">$1</div>')
        .replace(/###\s*(.*)/g, '<div class="h3">$1</div>')
        .replace(/##\s*(.*)/g, '<div class="h2">$1</div>')
        .replace(/#\s*(.*)/g, '<div class="h1">$1</div>')
        // ç²—é«” **æ–‡å­—**
        .replace(/\*\*(.*?)\*\*/g, '<span class="bold">$1</span>')
        // æ–œé«” *æ–‡å­—* æˆ– _æ–‡å­—_
        .replace(/(\*|_)(.*?)\1/g, '<span class="italic">$2</span>')
        // è¡Œå…§ç¨‹å¼ç¢¼ `...`
        .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
        // ç™¾åˆ†æ¯”é«˜äº®
        .replace(/(\d+(\.\d+)?%)/g, '<span class="percent">$1</span>')
        // å¼•è¨€ >
        .replace(/^>\s*(.*)/gm, '<blockquote class="quote">$1</blockquote>');

      // æœ‰åºæ¸…å–®
      formatted = formatted.replace(/(^|\n)(\d+\..*(\n\d+\..*)*)/g, match => {
        const items = match.trim().split(/\n/).map(line => line.replace(/^\d+\.\s+(.*)/, '<li>$1</li>')).join('');
        return `<ol>${items}</ol>`;
      });

      // ç„¡åºæ¸…å–®
      formatted = formatted.replace(/(^|\n)([-*]\s+.*(\n[-*]\s+.*)*)/g, match => {
        const items = match.trim().split(/\n/).map(line => line.replace(/^[-*]\s+(.*)/, '<li>$1</li>')).join('');
        return `<ul>${items}</ul>`;
      });

      // ç§»é™¤å¤šé¤˜ <br>
      formatted = formatted.replace(/(<\/(ul|ol|div|blockquote)>)<br>/g, "$1");

      p.innerHTML = formatted;
      div.appendChild(p);
  }
  } else if (sender === "loding") {
    div.classList.add('message', 'loading');
    div.textContent = text || "ç”Ÿæˆä¸­";
    const dot = document.createElement('span');
    dot.className = 'dot';
    dot.textContent = '...';
    div.appendChild(dot);
    messagesContainer.appendChild(div);
    return div;

  } else if (sender === "bot") {
    if (extraData && extraData.length) {
      const p = document.createElement('p');
      p.textContent = text;
      div.appendChild(p);

      // ===== Candlestick K ç·šåœ– =====
      const canvas = document.createElement('canvas');
      canvas.style.width = '300px';
      canvas.style.height = '200px';
      div.appendChild(canvas);

      const candleData = extraData.map(item => ({
        x: new Date(item.day.trim()),
        o: parseFloat(item.open),
        h: parseFloat(item.high),
        l: parseFloat(item.low),
        c: parseFloat(item.close)
      }));

      if (canvas.chartInstance) canvas.chartInstance.destroy();

      const paddedCandleData = [
        { x: new Date(candleData[0].x.getTime() - 24*60*60*1000), o: null, h: null, l: null, c: null },
        ...candleData,
        { x: new Date(candleData[candleData.length - 1].x.getTime() + 24*60*60*1000), o: null, h: null, l: null, c: null }
      ];

      const prices = candleData.flatMap(d => [d.h, d.l]);
      const minPrice = Math.min(...prices);
      const maxPrice = Math.max(...prices);
      const coinName = extraData.length ? extraData[0].coin : 'å¹£ç¨®';

      const chart = new Chart(canvas, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: `${coinName} åƒ¹æ ¼`,
            data: paddedCandleData,
            barPercentage: 0.2,
            categoryPercentage: 0.2
          }]
        },
        options: {
          animation: false,
          elements: { line: { tension: 0 } },
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const d = context[0].raw;
                  if (!d || d.o === null) return '';
                  const date = new Date(d.x);
                  return `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥`;
                },
                label: function(context) {
                  const d = context.raw;
                  if (!d || d.o === null) return '';
                  return `é–‹:${d.o} é«˜:${d.h} ä½:${d.l} æ”¶:${d.c}`;
                }
              }
            }
          },
          scales: {
            x: {
            type: 'time',
            time: { unit: 'day', tooltipFormat: 'MM/dd' },
            offset: true,
            ticks: {
              autoSkip: false,
              maxRotation: 0,
              callback: function(value, index, ticks) {
                let dateVal = value;
                if (value instanceof Date) dateVal = value;
                else if (typeof value === 'number') dateVal = new Date(value);
                else if (value && value.raw) dateVal = new Date(value.raw.x);
                return `${dateVal.getMonth()+1}æœˆ${dateVal.getDate()}æ—¥`;
              }
            }
          }
          ,
            y: {
              title: { display: true, text: 'åƒ¹æ ¼ (USD)' },
              beginAtZero: false,
              min: minPrice * 0.995,
              max: maxPrice * 1.005
            }
          }
        }
      });
      canvas.chartInstance = chart;
      window.chatCharts.push(chart);

      // ===== æˆäº¤é‡åœ– =====
      const volCanvas = document.createElement('canvas');
      volCanvas.style.width = '300px';
      volCanvas.style.height = '100px';
      div.appendChild(volCanvas);

      const volChart = new Chart(volCanvas, {
        type: 'bar',
        data: {
          labels: extraData.map(item => new Date(item.day.trim())),
          datasets: [{
            label: 'æˆäº¤é‡',
            data: extraData.map(i => parseFloat(i.volume)),
            backgroundColor: 'rgba(0,123,255,0.5)',
            barPercentage: 0.5
          }]
        },
        options: {
          animation: false,
          elements: { line: { tension: 0 } },
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                title: function(context) {
                  const d = context[0].parsed.x;
                  const date = new Date(d);
                  return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
                },
                label: function(context) {
                  return `æˆäº¤é‡: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'day' },
              ticks: {
                callback: function(value, index, ticks) {
                  const date = new Date(ticks[index].value);
                  return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
                },
                autoSkip: true,
                maxRotation: 0
              }
            },
            y: {
              title: { display: true, text: 'äº¤æ˜“é‡' }
            }
          }
        }
      });
      
      window.chatCharts.push(volChart);
      const p2 = document.createElement('div'); // æ”¹æˆ divï¼Œæ›´å¥½æ§åˆ¶æ¨£å¼
      p2.classList.add("analyze-content");

      let formatted = analyze
        // ä¿ç•™ <br>
        .replace(/&lt;br&gt;/g, "<br>")
        // è™•ç†ç¨‹å¼ç¢¼å€å¡Š ```...```
        .replace(/```([\s\S]*?)```/g, '<pre class="code-block"><code>$1</code></pre>')
        // è¡Œå…§ç¨‹å¼ç¢¼ `...`
        .replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>')
        // ç²—é«”æ–‡å­— **æ–‡å­—**
        .replace(/\*\*(.*?)\*\*/g, '<span class="bold">$1</span>')
        // æ–œé«”æ–‡å­— *æ–‡å­—* æˆ– _æ–‡å­—_
        .replace(/(\*|_)(.*?)\1/g, '<span class="italic">$2</span>')
        // è™•ç† ###### ~ #
        .replace(/(^|<br\s*\/?>)\s*######\s*(.*?)(?=<br|$)/g, '$1<div class="h6">$2</div>')
        .replace(/(^|<br\s*\/?>)\s*#####\s*(.*?)(?=<br|$)/g, '$1<div class="h5">$2</div>')
        .replace(/(^|<br\s*\/?>)\s*####\s*(.*?)(?=<br|$)/g, '$1<div class="h4">$2</div>')
        .replace(/(^|<br\s*\/?>)\s*###\s*(.*?)(?=<br|$)/g, '$1<div class="h3">$2</div>')
        .replace(/(^|<br\s*\/?>)\s*##\s*(.*?)(?=<br|$)/g, '$1<div class="h2">$2</div>')
        .replace(/(^|<br\s*\/?>)\s*#\s*(.*?)(?=<br|$)/g, '$1<div class="h1">$2</div>')
        // è™•ç†å¼•è¨€
        .replace(/^>\s*(.*)$/gm, '<blockquote class="quote">$1</blockquote>')
        // è™•ç†æœ‰åºæ¸…å–®
        .replace(/^\d+\.\s+(.*)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)(?!(\s*<li>|\s*<\/ul>))/gm, '<ol>$1</ol>')
        // è™•ç†ç„¡åºæ¸…å–® (- æˆ– *)
        .replace(/^[-*]\s+(.*)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)(?!(\s*<li>|\s*<\/ul>))/gm, '<ul>$1</ul>')
        // è™•ç†æ°´å¹³ç·š
        .replace(/^(-{3,}|\*{3,})$/gm, '<hr class="divider">')
        // ç™¾åˆ†æ¯”æ•¸å­—
        .replace(/(\d+(\.\d+)?%)/g, '<span class="percent">$1</span>');

      // å¡«å…¥ HTML
      p2.innerHTML = formatted;

      // æ’å…¥åˆ°ç›®æ¨™å€å¡Š
      div.appendChild(p2);
    } else {

      const p = document.createElement('p');
      p.innerHTML = text; // ç”¨ textContent é¿å… XSS
      div.appendChild(p);

    }

  }

  messagesContainer.appendChild(div);
}

  window.agentLoadingDivs = window.agentLoadingDivs || {};

  function sendMessage() {
    const selectedModules = Array.from(container.querySelectorAll(".module-select input:checked"))
      .map(cb => cb.value);
    const text = input.value.trim();
    if (!text) return;


    appendMessage(messages, text, "user");
    input.value = '';

    // åˆå§‹åŒ–æ¯å€‹ agent çš„ç”Ÿæˆä¸­ div
    

    if (window.currentEventSource) {

      window.currentEventSource.close();
    }

    const payload = { user_input: text, selected_modules: selectedModules };


    const es = new EventSource('/report/api/classify/?payload=' + encodeURIComponent(JSON.stringify(payload)));
    window.currentEventSource = es;

    es.onmessage = function(e) {

      try {
        const data = JSON.parse(e.data);

        // é¡¯ç¤ºåˆ†é¡çµæœ
        if (data.classifications) {

          appendMessage(messages, data.classifications.join(', '), 'bot', true);
        }

        if (data.progress && data.result) {
          const ans = data.result;
          const agent = ans.module;


            
          // é¡¯ç¤ºæœ€çµ‚è¨Šæ¯
          if (agent === "price") {
            appendMessage(messages, ans.text, 'bot', false, ans.data,analyze=ans.analyze);
          } else if (agent === "other") {
            appendMessage(messages, ans.text, 'other', false, ans.data,analyze=ans.analyze);
          } else if (agent === "news") {
            appendMessage(messages, ans.text, 'news', false, ans.data,analyze=ans.analyze);
          } else if (agent === "questionnaire") {
            appendMessage(messages, ans.text, 'questionnaire', false, ans.data,analyze=ans.analyze);
          } else if (agent === "loding") { 
            appendMessage(messages, ans.text, 'loding', false, ans.data);
          } else if (agent === "none") { 
            appendMessage(messages, ans.text, 'bot');
          } else {
            appendMessage(messages, ans.text + '<br>' + (ans.data || ''), 'bot');
          }
        }

        // é¡¯ç¤ºæ•´åˆå›è¦†
        if (data.integrated_summary) {

          appendMessage(messages, 'æ•´åˆå›è¦†ï¼š' + data.integrated_summary, 'summary');
        }

      } catch(err) { console.error('è§£æ SSE è¨Šæ¯éŒ¯èª¤', err); }
    };

    es.addEventListener('end', () => {

      es.close();
    });
    es.onerror = () => {

      es.close();
    }
  }



  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(); });

})();

const datalist = document.getElementById('preset-questions');

// å®šç¾©æ›´æ–° datalist å‡½å¼
async function updateDatalist() {
  const selectedModules = Array.from(document.querySelectorAll('.module-select input[type="checkbox"]:checked'))
    .map(c => c.value);

  const params = new URLSearchParams();
  selectedModules.forEach(m => params.append("modules[]", m));

  const response = await fetch(`/report/get_module_suggestions_api?${params.toString()}`);
  const data = await response.json();

  datalist.innerHTML = data.suggestions.map(q => `<option value="${q}">`).join("");
}

// é é¢ä¸€è¼‰å…¥å°±æ›´æ–°ä¸€æ¬¡
updateDatalist();

// checkbox æ”¹è®Šæ™‚ä¹Ÿæ›´æ–°
document.querySelectorAll('.module-select input[type="checkbox"]').forEach(checkbox => {
  checkbox.addEventListener('change', updateDatalist);
});
</script>


{% endblock %}