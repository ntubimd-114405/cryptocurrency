{% extends 'base.html' %}

{% block title %}è™›æ“¬è²¨å¹£è©•è«–å€{% endblock %}

{% block content %}
<style>
    body {
        font-family: 'Roboto', Arial, sans-serif;
        background-color: #f3f4f6;
        color: #333;
        line-height: 1.6;
    }

    .report-container {
        max-width: 900px;
        margin: 40px auto;
        background-color: #ffffff;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .report-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    h1, h2, h3, h5 {
        text-align: center;
    }

    h1 {
        font-size: 2em;
        margin-bottom: 20px;
    }

    h2 {
        font-size: 1.6em;
        border-bottom: 3px solid #4CAF50;
        padding-bottom: 5px;
        margin-top: 40px;
        margin-bottom: 20px;
        color: #444;
    }

    .btn-outline-primary, .btn-primary {
        border-color: #4CAF50;
        color: #4CAF50;
    }

    .btn-outline-primary:hover, .btn-primary:hover {
        background-color: #4CAF50;
        color: #fff;
    }

    .card-img-top {
        border-radius: 8px;
    }

    .list-group-item {
        background-color: #fff;
        border: none;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        padding: 20px;
    }

    .reply {
        margin-top: 1rem;
        padding-left: 20px;
        border-left: 3px solid #4CAF50;
    }

    .reply-form-container {
        background-color: #f9fafb;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    textarea.form-control {
        border-radius: 8px;
        border: 1px solid #ccc;
    }

    .btn-secondary {
        background-color: #ccc;
        border: none;
    }

    hr {
        border: none;
        border-top: 2px solid #e0e0e0;
        margin: 40px 0;
    }

    .sentiment-section {
        background-color: #f9fafb;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        margin-bottom: 40px;
    }

    .text-justify {
        text-align: justify;
        text-justify: inter-word;
    }

    .svg {
        width: 100%;
        max-width: 350px;
        height: 200px;
        display: block;
        margin: 0 auto;
    }

    text {
        font-size: 12px;
        fill: #333;
    }

    .justified-paragraph {
        text-align: justify;
        margin-top: 20px;
        margin-bottom: 20px;
        padding-left: 20px;
        padding-right: 20px;
    }

    .reply-btn {
        margin-top: 10px;
        color: #007bff;
        text-decoration: none;
        cursor: pointer;
    }

    .reply-form button {
        width: 100%;
    }

    .bg-light {
        background-color: #f8f9fa !important;
    }

    .shadow-sm {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .rounded {
        border-radius: 8px;
    }

    .d-flex {
        display: flex;
    }

    .justify-content-between {
        justify-content: space-between;
    }
    
    /* èƒŒæ™¯æµ®å‹•å€å¡Š - åŠé€æ˜ + æ¯›ç»ç’ƒ */
    .floating-bar-modern {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
    padding: 14px 32px;
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    animation: fadeInUp 0.6s ease-out;
    }

    @media (max-width: 768px) {
        .report-container {
            padding: 20px;
        }

        h1 {
            font-size: 1.6em;
        }

        h2 {
            font-size: 1.3em;
        }
    }
</style>
<!-- /* æµ®å‹•æŒ‰éˆ•åˆ— */ -->
<div class="floating-bar-modern">
    <a href="{% url 'news_list' %}" class="modern-btn secondary">
      ğŸ  è¿”å›ä¸Šé 
    </a>
</div>

<div class="report-container">
    

    <h1>{{ article.title }}</h1>
    

    <p class="text-center mt-3">
        <a>æ–°èç™¼å¸ƒæ™‚é–“ï¼š{{ article.time }}</a>
        <a href="{{ article.url }}" target="_blank" class="btn btn-outline-primary">
            ğŸ”— å‰å¾€æ–°èä¾†æº
        </a>
    </p>

    <div class="text-justify">
        <h2>æ–‡ç« æ‘˜è¦</h2>
        {{ article.summary }}
    </div>
    <br><br>
    <div class="d-flex flex-row" style="width: 100%;">
    <!-- Image Section (Left, 70%) -->
    <div style="flex: 0 0 60%; max-width: 60%; padding-right: 10px;">
        {% if article.image_url %}
            <img class="card-img-top" src="{{ article.image_url }}" alt="æ–°èåœ–ç‰‡" style="width: 100%; height: auto;" class="img-fluid rounded">
        {% elif article.website.icon_url %}
            <a href="{{ article.url }}" target="_blank">
                <img src="{{ article.website.icon_url }}" alt="ç¶²ç«™ Logo" style="width: 100%; height: auto;" class="img-fluid rounded">
            </a>
        {% else %}
            <p class="text-center text-muted">ç„¡åœ–ç‰‡</p>
        {% endif %}
    </div>
    
    <!-- Sentiment Analysis Dashboard (Right, 30%) -->
    <div class="sentiment-section" style="flex: 0 0 40%; max-width: 40%; padding-left: 10px;">
        <h5>æƒ…ç·’åˆ†æå„€è¡¨æ¿</h5>
        <p>åˆ†æ•¸ï¼š<span id="score-label">{{ article.sentiment_score }}</span></p>
        <svg viewBox="0 0 200 120" class="svg" style="width: 100%; height: auto;">
            <defs>
                <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="red"/>
                    <stop offset="50%" stop-color="yellow"/>
                    <stop offset="100%" stop-color="green"/>
                </linearGradient>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto">
                    <polygon points="0 0, 9 3.5, 0 7" fill="#222" />
                </marker>
            </defs>
            <path d="M 10 100 A 90 90 0 0 1 190 100" fill="none" stroke="url(#gaugeGradient)" stroke-width="20" />
            <g id="ticks"></g>
            <line id="needle" x1="100" y1="100" x2="100" y2="45" stroke="#222" stroke-width="3" marker-end="url(#arrowhead)" />
            <circle cx="100" cy="100" r="4" fill="#222" />
        </svg>
    </div>
</div>
    

    <div class="content">
        <h2>å…§æ–‡</h2>
        <div id="article-content" class="justified-paragraph text-justify">
            {{ article.content }}
        </div>
    </div>

    <hr>

    <h2>è©•è«–å€</h2>
    {% if comments %}
    <ul class="list-group">
        {% for comment in comments %}
        <li class="list-group-item mb-4 shadow-sm rounded">
            <strong>{{ comment.user.username }}</strong>
            <span class="text-muted">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
            <p>{{ comment.content }}</p>

            <button class="btn btn-sm btn-outline-primary reply-btn" data-parent-id="{{ comment.id }}">å›è¦†</button>

            {% for reply in comment.replies.all %}
            <div class="reply ms-4 mt-2">
                <p><strong>{{ reply.user.username }}</strong>: {{ reply.content }}</p>
                <small class="text-muted">{{ reply.created_at|date:"Y-m-d H:i" }}</small>
            </div>
            {% endfor %}

            <div id="reply-form-container-{{ comment.id }}" class="reply-form-container mt-3" style="display:none;">
                <h3>å›è¦† {{ comment.user.username }}</h3>
                <form method="POST" class="reply-form" data-comment-id="{{ comment.id }}">
                    {% csrf_token %}
                    <textarea name="content" class="form-control mb-2" rows="4" placeholder="è¼¸å…¥å›è¦†..." required></textarea>
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary cancel-btn">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">å›è¦†è¨Šæ¯</button>
                    </div>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="text-center">ç›®å‰æ²’æœ‰è©•è«–ã€‚</p>
    {% endif %}

    <hr>

    {% if user.is_authenticated %}
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h3>æ–°å¢è©•è«–</h3>
            <form method="POST" id="comment-form" class="reply-form-container">
                {% csrf_token %}
                <textarea name="content" class="form-control mb-2" rows="4" placeholder="è¼¸å…¥è©•è«–..." required></textarea>
                <div class="d-flex justify-content-between">
                    <a href="{% url 'news_list' %}" class="btn btn-secondary">è¿”å›</a>
                    <button type="submit" class="btn btn-primary">è©•è«–</button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <p class="text-center">æ‚¨å¿…é ˆç™»å…¥æ‰èƒ½ç•™è¨€ã€‚</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // æƒ…ç·’åˆ†æå„€è¡¨æ¿
    const score = parseFloat('{{ article.sentiment_score }}');
    const scoreLabel = document.getElementById("score-label");
    const needle = document.getElementById("needle");
    const ticksGroup = document.getElementById("ticks");
    const majorTicks = [1, 0.5, 0, -0.5, -1]; // Swapped 1 with -1 and 0.5 with -0.5
    const minorStep = 0.1;

    scoreLabel.textContent = score.toFixed(2);
    const angle = score * 90;
    needle.setAttribute("transform", `rotate(${angle}, 100, 100)`);

    function drawTick(value, length, width, color) {
        // Map displayed value to original position
        const originalValue = (
            value === 1 ? -1 :
            value === -1 ? 1 :
            value === 0.5 ? -0.5 :
            value === -0.5 ? 0.5 :
            value
        );
        const angleDeg = originalValue * 90 + 90;
        const angleRad = angleDeg * Math.PI / 180;
        const x1 = 100 + (90 - length) * Math.cos(angleRad);
        const y1 = 100 - (90 - length) * Math.sin(angleRad);
        const x2 = 100 + 90 * Math.cos(angleRad);
        const y2 = 100 - 90 * Math.sin(angleRad);

        const tick = document.createElementNS("http://www.w3.org/2000/svg", "line");
        tick.setAttribute("x1", x1);
        tick.setAttribute("y1", y1);
        tick.setAttribute("x2", x2);
        tick.setAttribute("y2", y2);
        tick.setAttribute("stroke", color);
        tick.setAttribute("stroke-width", width);
        ticksGroup.appendChild(tick);
    }

    majorTicks.forEach(v => {
        drawTick(v, 10, 2, "#000");
        // Map displayed value to original position for text
        const originalValue = (
            v === 1 ? -1 :
            v === -1 ? 1 :
            v === 0.5 ? -0.5 :
            v === -0.5 ? 0.5 :
            v
        );
        const angleDeg = originalValue * 90 + 90;
        const angleRad = angleDeg * Math.PI / 180;
        const xText = 100 + 65 * Math.cos(angleRad);
        const yText = 100 - 65 * Math.sin(angleRad);

        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", xText);
        text.setAttribute("y", yText + 4);
        text.setAttribute("text-anchor", "middle");
        text.textContent = v.toFixed(1);
        ticksGroup.appendChild(text);
    });

    for (let v = -0.9; v < 1; v += minorStep) {
        if (majorTicks.includes(parseFloat(v.toFixed(1)))) continue;
        drawTick(v, 5, 1, "#666");
    }

    // å›è¦†è¡¨å–®åˆ‡æ›
    document.querySelectorAll('.reply-btn').forEach(button => {
        button.addEventListener('click', function () {
            const parentId = this.getAttribute('data-parent-id');
            document.querySelectorAll('.reply-form-container').forEach(form => {
                form.style.display = 'none';
            });
            const replyFormContainer = document.getElementById(`reply-form-container-${parentId}`);
            replyFormContainer.style.display = 'block';
            replyFormContainer.scrollIntoView({ behavior: 'smooth' });
            replyFormContainer.querySelector('textarea').focus();
        });
    });

    document.querySelectorAll('.cancel-btn').forEach(button => {
        button.addEventListener('click', function () {
            this.closest('.reply-form-container').style.display = 'none';
        });
    });
});


const contentDiv = document.getElementById('article-content');
let content = contentDiv.textContent.replace(/\s+/g, ' ').trim(); // æ¸…ç©ºå¤šé¤˜ç©ºç™½

// åˆ†å¥é‚è¼¯ï¼šäººå·¥èµ°è¨ªå­—å…ƒï¼Œé‡åˆ°çœŸæ­£å¥å°¾å†åˆ‡å‰²
let sentences = [];
let buffer = '';

for (let i = 0; i < content.length; i++) {
    const char = content[i];
    buffer += char;

    // åˆ¤æ–·æ˜¯å¦ç‚ºå¥å°¾æ¨™é»
    if (char === '.' || char === '!' || char === '?' || char === 'ã€‚' || char === 'ï¼' || char === 'ï¼Ÿ') {
        const nextChar = content[i + 1] || '';
        const prevChar = content[i - 1] || '';

        // ä»¥ä¸‹æƒ…æ³ä¸åˆ‡æ®µï¼š
        // 1. å°æ•¸ (3.14)
        if (prevChar.match(/[0-9]/) && nextChar.match(/[0-9]/)) continue;
        // 2. è‹±æ–‡ç¸®å¯« (U.S. / J.K.)
        if (prevChar.match(/[A-Za-z]/) && nextChar.match(/[A-Za-z]/)) continue;
        // 3. çœç•¥è™Ÿ (...)
        if (nextChar === '.') continue;

        // å¦å‰‡èªç‚ºæ˜¯ä¸€å€‹å¥å°¾ï¼Œå­˜å…¥ sentences
        sentences.push(buffer.trim());
        buffer = '';
    }
}

// è‹¥æœ€å¾Œé‚„æœ‰æ®˜ç•™æ–‡å­—ï¼Œè£œä¸Š
if (buffer.trim()) sentences.push(buffer.trim());

// çµ„åˆ HTML
contentDiv.innerHTML = sentences.map(s => `<p>${s}</p>`).join('');

</script>
{% endblock %}