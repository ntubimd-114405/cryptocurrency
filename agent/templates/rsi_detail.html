{% extends "base.html" %}

{% block title %}RSI ç­–ç•¥è©³ç´°é é¢{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>åŠ å¯†è²¨å¹£ K ç·šåœ– - RSI è©³æƒ…</title>
  <style>
    /* === å…¨å±€æ¨£å¼ === */
    body {
        background-color: #f5f5f5;
        color: #333;
        font-family: sans-serif;
    }
    #chartdiv { 
        width: 100%; 
        height: 800px; /* å¢åŠ é«˜åº¦ä»¥å®¹ç´ RSI é¢æ¿ */
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        background: #fff;
    }
    #controls { 
        margin-bottom: 20px; 
        padding: 15px; 
        border-radius: 8px; 
        display: flex; 
        gap: 15px; 
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        color: #333;
    }
    label { font-weight: bold; }
    input { 
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
        background: #fff; 
        color: #333;
    }
    button { 
        padding: 8px 15px;
        border-radius: 4px;
        background-color: #673AB7; /* RSI ä¸»é¡Œè‰²æ”¹ç‚ºç´«è‰² */
        color: white; 
        border: none; 
        cursor: pointer; 
    }
    button:hover { background-color: #512DA8; }
    
    .strategy-panel {
      background: #fff;
      margin: 0 0 20px 0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .strategy-info {
      flex: 2;
      min-width: 300px;
    }
    
    .strategy-info h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      font-size: 1.2rem;
    }

    .strategy-rules {
      list-style: none;
      padding: 0;
      margin: 0;
      color: #555;
      line-height: 1.6;
    }

    .strategy-rules li {
      margin-bottom: 8px;
    }

    /* å¼·èª¿æ–‡å­— */
    .highlight-buy { color: #00C853; font-weight: bold; }
    .highlight-sell { color: #D50000; font-weight: bold; }

    /* åœ–ä¾‹å€åŸŸ */
    .chart-legend {
      flex: 1;
      min-width: 200px;
      background: #fafafa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #666;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      display: inline-block;
      margin-right: 8px;
      border-radius: 2px;
    }

    /* RSI åœ–ä¾‹é¡è‰² */
    .bg-rsi { background-color: #673AB7; } /* ç´«è‰² */
    .bg-overbought { background-color: #e57373; opacity: 0.5; }
    .bg-oversold { background-color: #81c784; opacity: 0.5; }

    .icon-buy { 
      width: 0; height: 0; 
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid #00C853; 
      margin-right: 8px;
    }
    .icon-sell { 
      width: 0; height: 0; 
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 10px solid #D50000; 
      margin-right: 8px;
    }
    .ai-insight-box {
      background: linear-gradient(to right, #f8f9fa, #ffffff);
      border-left: 5px solid #673AB7; /* ç´«è‰²é‚Šæ¡†å‘¼æ‡‰ RSI */
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      line-height: 1.6;
      color: #333;
      text-align: left;
    }
    
    .ai-insight-box strong {
      color: #d35400; 
    }

    /* === æ–°å¢: å›æ¸¬è¡¨æ ¼æ¨£å¼ === */
    .performance-panel {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        margin-top: 20px;
    }
    .summary-cards {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .card {
        flex: 1;
        min-width: 150px;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #eee;
    }
    .card h4 { margin: 0 0 5px 0; color: #666; font-size: 0.9rem; }
    .card .value { font-size: 1.5rem; font-weight: bold; color: #333; }

    table.trade-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }
    table.trade-table th, table.trade-table td {
        padding: 12px;
        text-align: right;
        border-bottom: 1px solid #eee;
    }
    table.trade-table th {
        text-align: right;
        background-color: #fafafa;
        color: #555;
        font-weight: 600;
    }
    /* ç¬¬ä¸€æ¬„æ—¥æœŸé å·¦ */
    table.trade-table th:first-child, table.trade-table td:first-child {
        text-align: left;
    }

    /* ç›ˆè™§é¡è‰² */
    .profit-pos { color: #00C853; font-weight: bold; } /* è³ºéŒ¢ç¶  */
    .profit-neg { color: #D50000; font-weight: bold; } /* è³ éŒ¢ç´… */
  </style>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/stock.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>

<div class="strategy-panel">
  <div class="strategy-info">
    <h3>ç­–ç•¥é‚è¼¯ï¼šRSI ç›¸å°å¼·å¼±æŒ‡æ¨™ (Mean Reversion)</h3>
    <ul class="strategy-rules">
      <li>
        <strong>æ ¸å¿ƒæ¦‚å¿µï¼š</strong> åˆ©ç”¨å‹•èƒ½éœ‡ç›ªæŒ‡æ¨™æ•æ‰å¸‚å ´çš„ã€Œè¶…è²·ã€èˆ‡ã€Œè¶…è³£ã€ç‹€æ…‹ï¼Œé€²è¡Œå‡å€¼å›æ­¸äº¤æ˜“ã€‚
      </li>
      <li>
        <span class="highlight-buy">è²·å…¥è¨Šè™Ÿ (åå½ˆ)ï¼š</span> 
        ç•¶ RSI é€²å…¥ <span style="color:#2e7d32; font-weight:bold;">è¶…è³£å€ (&lt; 30)</span> ä¸¦å‘ä¸Šç©¿è¶Šæ™‚ï¼Œè¦–ç‚ºéç†æ€§æ‹‹å”®çµæŸï¼Œå¯èƒ½åå½ˆã€‚
      </li>
      <li>
        <span class="highlight-sell">è³£å‡ºè¨Šè™Ÿ (å›èª¿)ï¼š</span> 
        ç•¶ RSI é€²å…¥ <span style="color:#c62828; font-weight:bold;">è¶…è²·å€ (&gt; 70)</span> ä¸¦å‘ä¸‹ç©¿è¶Šæ™‚ï¼Œè¦–ç‚ºè²·ç›¤éç†±ï¼Œå¯èƒ½å›èª¿ã€‚
      </li>
    </ul>
  </div>

  <div class="chart-legend">
    <div style="font-weight:bold; margin-bottom:10px;">åœ–è¡¨åœ–ä¾‹</div>
    <div class="legend-item">
      <span class="legend-color bg-rsi"></span> RSI (14) æŒ‡æ¨™ç·š
    </div>
    <div class="legend-item">
      <span class="legend-color bg-overbought"></span> è¶…è²·ç·š (70)
    </div>
    <div class="legend-item">
      <span class="legend-color bg-oversold"></span> è¶…è³£ç·š (30)
    </div>
    <div class="legend-item">
      <span class="icon-buy"></span> è²·å…¥è¨Šè™Ÿ (RSI &uarr; 30)
    </div>
    <div class="legend-item">
      <span class="icon-sell"></span> è³£å‡ºè¨Šè™Ÿ (RSI &darr; 70)
    </div>
  </div>
</div>

<div id="controls">
  <label>é–‹å§‹æ™‚é–“ï¼š
    <input type="datetime-local" id="startDate" />
  </label>
  <label>çµæŸæ™‚é–“ï¼š
    <input type="datetime-local" id="endDate" />
  </label>
  <button id="btnQuery">æŸ¥è©¢å€é–“</button>
  <span id="loadingText" style="margin-left: 10px; color: #666;"></span>
</div>

<div id="chartdiv"></div>

<div class="performance-panel">
    <h3>ğŸ“Š RSI ç­–ç•¥å›æ¸¬ç¸¾æ•ˆå ±å‘Š (ä¾æ“šç•¶å‰æ™‚é–“å€é–“)</h3>
    
    <div class="summary-cards">
        <div class="card">
            <h4>ç¸½äº¤æ˜“æ¬¡æ•¸</h4>
            <div class="value" id="totalTrades">0</div>
        </div>
        <div class="card">
            <h4>å‹ç‡</h4>
            <div class="value" id="winRate">0%</div>
        </div>
        <div class="card">
            <h4>ç¸½å ±é…¬ç‡ (ä¸å«è¤‡åˆ©)</h4>
            <div class="value" id="totalReturn">0.00%</div>
        </div>
    </div>
  
    <table class="trade-table">
        <thead>
            <tr>
                <th>è²·å…¥æ™‚é–“</th>
                <th>è²·å…¥åƒ¹æ ¼</th>
                <th>è³£å‡ºæ™‚é–“</th>
                <th>è³£å‡ºåƒ¹æ ¼</th>
                <th>æ¯å–®æç›Š (%)</th>
                <th>ç‹€æ…‹</th>
            </tr>
        </thead>
        <tbody id="tradeTableBody">
            </tbody>
    </table>
  </div>

<div class="ai-insight-box">
    <p>
      <h2><strong>RSI å‡å€¼å›æ­¸ç­–ç•¥åˆ†æå ±å‘Š</strong></h2>
      <strong>1. ç­–ç•¥æ·±åº¦è§£æï¼š</strong><br>
      RSIï¼ˆç›¸å°å¼·å¼±æŒ‡æ¨™ï¼‰ä½œç‚ºä¸€ç¨®å‹•èƒ½éœ‡ç›ªæŒ‡æ¨™ï¼Œä¸»è¦ç”¨æ–¼è¡¡é‡å¸‚å ´çš„éè²·æˆ–éè³£ç‹€æ…‹ã€‚å…¶æ ¸å¿ƒé‚è¼¯åœ¨æ–¼æ¯”è¼ƒä¸€å€‹ç‰¹å®šæ™‚é–“æ®µå…§çš„ä¸Šæ¼²èˆ‡ä¸‹è·Œå¹…åº¦ï¼Œå½¢æˆä¸€å€‹ä»‹æ–¼0è‡³100ä¹‹é–“çš„å€¼ã€‚å…¶ä¸­ï¼ŒRSIä½æ–¼30ä»£è¡¨å¸‚å ´å¯èƒ½éåº¦æ‹‹å”®ï¼Œå³ã€Œè¶…è³£ã€ï¼Œæ­¤æ™‚è‹¥å‡ºç¾åå½ˆæ©Ÿæœƒï¼ŒæŠ•è³‡è€…å¯è€ƒæ…®å…¥å ´ã€‚è€Œ<å¼·>RSIé«˜æ–¼70å‰‡æš—ç¤ºå¸‚å ´éåº¦è²·å…¥ï¼Œå³ã€Œè¶…è²·ã€ï¼Œå¯å¼•ç™¼å›èª¿é¢¨éšªï¼Œé©åˆè€ƒæ…®è³£å‡ºæ“ä½œã€‚

      é€éè©²ç­–ç•¥ï¼Œäº¤æ˜“è€…èƒ½æœ‰æ•ˆæ•æ‰ã€Œå‡å€¼å›æ­¸ã€çš„è¡Œæƒ…ï¼Œèªè­˜åˆ°å¸‚å ´æƒ…ç·’ä¸ç†æ€§æ™‚æ‰€å¸¶ä¾†çš„äº¤æ˜“æ©Ÿæœƒï¼Œä¸¦åœ¨çŸ­æœŸåƒ¹æ ¼æ³¢å‹•ä¸­å°‹æ‰¾åˆ©æ½¤ã€‚
      <br>
      <strong>2. æŠ•è³‡å¤§å¸«å“²å­¸é€£çµï¼š</strong><br>
      J. Welles Wilder Jr. åœ¨å…¶æå‡ºRSIæ™‚ï¼Œå¼·èª¿äº†åŸºæ–¼åƒ¹æ ¼è¡Œç‚ºèˆ‡å¸‚å ´æƒ…ç·’çš„åˆ†æã€‚å…¶äº¤æ˜“å“²å­¸ä¸­ï¼Œé‡è¦–å¾ç¾¤çœ¾æƒ…ç·’ä¸­ç²åˆ©ï¼Œå…¶ç­–ç•¥å¼·èª¿é€†å‹¢æ“ä½œçš„é‡è¦æ€§ï¼Œä¹Ÿå°±æ˜¯åœ¨ä»–äººææ‡¼æ™‚è²ªå©ªã€‚åœ¨æŠ€è¡“åˆ†æé ˜åŸŸï¼Œé€™èˆ‡è‚¡ç¥å·´è²ç‰¹çš„è§€é»ç›¸å‘¼æ‡‰ï¼šã€Œåˆ¥äººææ‡¼æ™‚æˆ‘è²ªå©ªã€ã€‚

      RSIä½œç‚ºé‡åŒ–å·¥å…·ï¼Œèƒ½å¹«åŠ©æŠ•è³‡è€…å…‹æœè¿½é«˜æ®ºä½çš„äººæ€§å¼±é»ï¼Œå¼•å°ä»–å€‘åœ¨å¸‚å ´æ¥µç«¯æƒ…ç·’ä¸‹ï¼Œéµå¾ªæ•¸æ“šè€Œéæƒ…æ„Ÿè¡Œäº‹ï¼Œå¾è€Œæå‡æ ¹æ“šæŠ€è¡“æŒ‡æ¨™é€²è¡Œç¨ç«‹åˆ¤æ–·çš„èƒ½åŠ›ã€‚
    </p>
</div>

<script>
const initialData = {{ chart_data|safe }};
const coinId = {{ coin_id }};

function toDatetimeLocalString(date) {
  const offset = date.getTimezoneOffset();
  const local = new Date(date.getTime() - offset * 60000);
  return local.toISOString().slice(0, 16);
}

function initDateInputs() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 30);
    document.getElementById('startDate').value = toDatetimeLocalString(start);
    document.getElementById('endDate').value = toDatetimeLocalString(end);
}

// ============================================
//  æ•¸å­¸é‚è¼¯å€ (RSI ç®—æ³•)
// ============================================

function calculateRSI(data, period = 14) {
    if (data.length < period + 1) return [];

    let rsiData = [];
    let gains = [];
    let losses = [];

    // 1. è¨ˆç®—æ¼²è·Œå¹…
    for (let i = 1; i < data.length; i++) {
        let change = data[i].close - data[i - 1].close;
        gains.push(change > 0 ? change : 0);
        losses.push(change < 0 ? Math.abs(change) : 0);
    }

    // 2. è¨ˆç®—åˆå§‹å¹³å‡
    let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
    let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;

    // 3. æ¨ç®—å¾ŒçºŒ RSI (Wilder's Smoothing)
    for (let i = period; i < data.length; i++) {
        let currentGain = gains[i - 1]; 
        let currentLoss = losses[i - 1];

        // Wilder å¹³æ»‘å…¬å¼
        avgGain = ((avgGain * (period - 1)) + currentGain) / period;
        avgLoss = ((avgLoss * (period - 1)) + currentLoss) / period;

        let rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
        let rsi = 100 - (100 / (1 + rs));

        rsiData.push({
            date: data[i].date,
            value: rsi,
            close: data[i].close 
        });
    }
    return rsiData;
}

function calculateRSISignals(rsiData, overbought=70, oversold=30) {
    let signals = [];
    for (let i = 1; i < rsiData.length; i++) {
        let prevRsi = rsiData[i-1].value;
        let currRsi = rsiData[i].value;

        // é»ƒé‡‘äº¤å‰ï¼šRSI å¾ä¸‹æ–¹ç©¿è¶Š 30 (è²·é»)
        if (prevRsi < oversold && currRsi >= oversold) {
            signals.push({
                date: rsiData[i].date,
                value: rsiData[i].close, // è¨Šè™Ÿç•«åœ¨åƒ¹æ ¼ä¸Š
                signalType: "buy",
                description: `RSI ä¸Šç©¿ ${oversold} (è²·å…¥)`
            });
        }
        // æ­»äº¡äº¤å‰ï¼šRSI å¾ä¸Šæ–¹ç©¿è¶Š 70 (è³£é»)
        else if (prevRsi > overbought && currRsi <= overbought) {
            signals.push({
                date: rsiData[i].date,
                value: rsiData[i].close, // è¨Šè™Ÿç•«åœ¨åƒ¹æ ¼ä¸Š
                signalType: "sell",
                description: `RSI ä¸‹ç©¿ ${overbought} (è³£å…¥)`
            });
        }
    }
    return signals;
}

// ============================================
//  æ–°å¢: å›æ¸¬è¨ˆç®—èˆ‡è¡¨æ ¼æ¸²æŸ“é‚è¼¯
// ============================================
function calculateAndRenderPerformance(signals) {
    const tableBody = document.getElementById('tradeTableBody');
    const elTotalTrades = document.getElementById('totalTrades');
    const elWinRate = document.getElementById('winRate');
    const elTotalReturn = document.getElementById('totalReturn');

    tableBody.innerHTML = ""; // æ¸…ç©ºè¡¨æ ¼

    let trades = [];
    let currentBuy = null;
    let totalProfitPercent = 0;
    let winCount = 0;

    // 1. éæ­·è¨Šè™Ÿé…å° (è²·å…¥ -> è³£å‡º)
    signals.forEach(sig => {
        if (sig.signalType === 'buy') {
            // å¦‚æœå·²ç¶“æœ‰å€‰ä½ï¼Œå…ˆå¿½ç•¥æ–°çš„è²·å…¥ (å‡è¨­å–®å‘æŒå€‰)
            if (!currentBuy) {
                currentBuy = sig;
            }
        } else if (sig.signalType === 'sell') {
            if (currentBuy) {
                // çµç®—ä¸€ç­†äº¤æ˜“
                let entryPrice = currentBuy.value;
                let exitPrice = sig.value;
                let profitPercent = ((exitPrice - entryPrice) / entryPrice) * 100;

                trades.push({
                    entryDate: new Date(currentBuy.date), 
                    entryPrice: entryPrice,
                    exitDate: new Date(sig.date),
                    exitPrice: exitPrice,
                    profit: profitPercent
                });

                // ç´¯åŠ æ•¸æ“š
                totalProfitPercent += profitPercent;
                if (profitPercent > 0) winCount++;

                // æ¸…ç©ºæ‰‹ä¸Šçš„å–®
                currentBuy = null;
            }
        }
    });

    // 2. æ›´æ–°ç¸½çµå¡ç‰‡
    let tradeCount = trades.length;
    elTotalTrades.textContent = tradeCount;
    elWinRate.textContent = tradeCount > 0 ? ((winCount / tradeCount) * 100).toFixed(1) + "%" : "0%";
    
    // æ ¹æ“šæ­£è² è¨­å®šç¸½å ±é…¬é¡è‰²
    elTotalReturn.textContent = totalProfitPercent.toFixed(2) + "%";
    elTotalReturn.className = "value " + (totalProfitPercent >= 0 ? "profit-pos" : "profit-neg");

    // 3. æ¸²æŸ“è¡¨æ ¼ HTML (åè½‰é™£åˆ—ï¼Œè®“æœ€æ–°çš„äº¤æ˜“é¡¯ç¤ºåœ¨æœ€ä¸Šé¢)
    trades.reverse().forEach(trade => {
        let row = document.createElement('tr');
        
        // æ ¼å¼åŒ–æ™‚é–“ (MM-DD HH:mm)
        const fmtDate = (d) => `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        
        let profitClass = trade.profit >= 0 ? "profit-pos" : "profit-neg";
        let profitSign = trade.profit >= 0 ? "+" : "";

        row.innerHTML = `
            <td>${fmtDate(trade.entryDate)}</td>
            <td>${trade.entryPrice.toFixed(2)}</td>
            <td>${fmtDate(trade.exitDate)}</td>
            <td>${trade.exitPrice.toFixed(2)}</td>
            <td class="${profitClass}">${profitSign}${trade.profit.toFixed(2)}%</td>
            <td>${trade.profit >= 0 ? "âœ… ç²åˆ©" : "âŒ è™§æ"}</td>
        `;
        tableBody.appendChild(row);
    });
}


am5.ready(function() {
  var root = am5.Root.new("chartdiv");
  root.setThemes([am5themes_Animated.new(root)]);

  var stockChart = root.container.children.push(am5stock.StockChart.new(root, {}));

  // === 1. ä¸»é¢æ¿ (Kç·š + è¨Šè™Ÿ) ===
  var mainPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    wheelY: "zoomX",
    height: am5.percent(60),
    layout: root.verticalLayout
  }));

  var dateAxisMain = mainPanel.xAxes.push(am5xy.DateAxis.new(root, {
    baseInterval: { timeUnit: "minute", count: 1 },
    renderer: am5xy.AxisRendererX.new(root, {}),
    tooltip: am5.Tooltip.new(root, {})
  }));

  var valueAxis = mainPanel.yAxes.push(am5xy.ValueAxis.new(root, {
    renderer: am5xy.AxisRendererY.new(root, { pan: "zoom" }),
    tooltip: am5.Tooltip.new(root, {})
  }));

  var candleSeries = mainPanel.series.push(am5xy.CandlestickSeries.new(root, {
    name: "åƒ¹æ ¼",
    clustered: false,
    openValueYField: "open",
    highValueYField: "high",
    lowValueYField: "low",
    valueYField: "close",
    valueXField: "date",
    xAxis: dateAxisMain,
    yAxis: valueAxis
  }));

  // è¨­å®šå·è»¸
  mainPanel.set("scrollbarX", am5.Scrollbar.new(root, { orientation: "horizontal" }));

  // ç­–ç•¥è¨Šè™Ÿ Series (ç•«ç®­é ­)
  var signalSeries = mainPanel.series.push(am5xy.LineSeries.new(root, {
      name: "ç­–ç•¥è¨Šè™Ÿ",
      valueYField: "value",
      valueXField: "date",
      xAxis: dateAxisMain,
      yAxis: valueAxis,
      stroke: undefined 
  }));

  // è¨Šè™Ÿæ¨£å¼ (ç®­é ­)
  signalSeries.bullets.push(function (root, series, dataItem) {
      var context = dataItem.dataContext;
      var arrowSize = 30; 
      var strokeColor = am5.color(0xffffff);
      var strokeWidth = 2;

      if (context.signalType === "buy") {
          return am5.Bullet.new(root, {
              sprite: am5.Triangle.new(root, {
                  fill: am5.color(0x00E676),
                  stroke: strokeColor,
                  strokeWidth: strokeWidth,
                  width: arrowSize, height: arrowSize,
                  rotation: 0,
                  centerY: am5.p50, centerX: am5.p50,
                  tooltipText: context.description
              })
          });
      } else if (context.signalType === "sell") {
          return am5.Bullet.new(root, {
              sprite: am5.Triangle.new(root, {
                  fill: am5.color(0xFF1744),
                  stroke: strokeColor,
                  strokeWidth: strokeWidth,
                  width: arrowSize, height: arrowSize,
                  rotation: 180,
                  centerY: am5.p50, centerX: am5.p50,
                  tooltipText: context.description
              })
          });
      }
  });

  // === 2. RSI é¢æ¿ ===
  var rsiPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
      wheelX: "panX",
      height: am5.percent(20), 
      layout: root.verticalLayout,
      paddingTop: 5
  }));

  var rsiValueAxis = rsiPanel.yAxes.push(am5xy.ValueAxis.new(root, {
      renderer: am5xy.AxisRendererY.new(root, { pan: "zoom" }),
      min: 0,
      max: 100, 
      strictMinMax: true
  }));

  var rsiDateAxis = rsiPanel.xAxes.push(am5xy.DateAxis.new(root, {
      baseInterval: { timeUnit: "minute", count: 1 },
      renderer: am5xy.AxisRendererX.new(root, { visible: false }), 
      tooltip: am5.Tooltip.new(root, {})
  }));
  
  rsiDateAxis.groupData = true; 

  var rsiSeries = rsiPanel.series.push(am5xy.LineSeries.new(root, {
      name: "RSI",
      valueYField: "value",
      valueXField: "date",
      xAxis: rsiDateAxis,
      yAxis: rsiValueAxis,
      stroke: am5.color(0x673AB7), 
      strokeWidth: 2
  }));

  // åŠ å…¥ RSI 70/30 åƒè€ƒç·š
  var rangeOverbought = rsiValueAxis.createAxisRange(rsiValueAxis.makeDataItem({ value: 70 }));
  rangeOverbought.get("grid").setAll({ stroke: am5.color(0xFF1744), strokeOpacity: 0.5, strokeDasharray: [5, 5] });
  rangeOverbought.get("label").setAll({ text: "70", fill: am5.color(0xFF1744), visible: true });

  var rangeOversold = rsiValueAxis.createAxisRange(rsiValueAxis.makeDataItem({ value: 30 }));
  rangeOversold.get("grid").setAll({ stroke: am5.color(0x00E676), strokeOpacity: 0.5, strokeDasharray: [5, 5] });
  rangeOversold.get("label").setAll({ text: "30", fill: am5.color(0x00E676), visible: true });


  // === 3. æˆäº¤é‡é¢æ¿ ===
  var volumePanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    height: am5.percent(20),
    layout: root.verticalLayout
  }));
  var volumeAxis = volumePanel.yAxes.push(am5xy.ValueAxis.new(root, { renderer: am5xy.AxisRendererY.new(root, { inside: true }) }));
  var dateAxisVolume = volumePanel.xAxes.push(am5xy.DateAxis.new(root, { baseInterval: { timeUnit: "minute", count: 1 }, renderer: am5xy.AxisRendererX.new(root, { visible: false }) }));
  var volumeSeries = volumePanel.series.push(am5xy.ColumnSeries.new(root, {
    valueXField: "date", valueYField: "volume", xAxis: dateAxisVolume, yAxis: volumeAxis
  }));
  
  volumeSeries.columns.template.adapters.add("fill", function(fill, target) {
    var dataItem = target.dataItem;
    if (dataItem) { 
        return dataItem.dataContext.close > dataItem.dataContext.open ? am5.color(0xff0000) : am5.color(0x00aa00); 
    }
    return fill;
  });

  // === è³‡æ–™æ›´æ–°å‡½æ•¸ ===
  function updateChartData(data) {
      if (!data || data.length === 0) { alert("ç„¡è³‡æ–™"); return; }
      
      // 1. è¨­å®š K ç·šèˆ‡æˆäº¤é‡
      candleSeries.data.setAll(data);
      volumeSeries.data.setAll(data);

      // 2. è¨ˆç®— RSI
      let rsiData = calculateRSI(data, 14);
      rsiSeries.data.setAll(rsiData);

      // 3. è¨ˆç®—ä¸¦è¨­å®šè¨Šè™Ÿ
      let signals = calculateRSISignals(rsiData, 70, 30);
      signalSeries.data.setAll(signals);

      // 4. è¨ˆç®—å›æ¸¬ç¸¾æ•ˆ (æ–°å¢æ­¤è¡Œ)
      calculateAndRenderPerformance(signals);
  }

  async function fetchCoinHistory(coinId, start, end) {
    const url = new URL(`/coin-history/${coinId}/`, window.location.origin);
    url.searchParams.append("start", start.toISOString());
    url.searchParams.append("end", end.toISOString());
    try {
        document.getElementById('loadingText').textContent = "è¼‰å…¥ä¸­...";
        const resp = await fetch(url);
        const json = await resp.json();
        document.getElementById('loadingText').textContent = "";
        return json.data;
    } catch (e) {
        console.error(e);
        return [];
    }
  }

  if (initialData && initialData.length > 0) { updateChartData(initialData); }
  initDateInputs();
  document.getElementById('btnQuery').addEventListener('click', async () => {
    const start = new Date(document.getElementById('startDate').value);
    const end = new Date(document.getElementById('endDate').value);
    const newData = await fetchCoinHistory(coinId, start, end);
    updateChartData(newData);
  });

});
</script>
</body>
</html>
{% endblock %}