{% extends "base.html" %}

{% block title %}RSI 策略詳細頁面{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>加密貨幣 K 線圖 - RSI 詳情</title>
  <style>
    /* === 全局樣式 === */
    body {
        background-color: #f5f5f5;
        color: #333;
        font-family: sans-serif;
    }
    #chartdiv { 
        width: 100%; 
        height: 800px; /* 增加高度以容納 RSI 面板 */
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        background: #fff;
    }
    #controls { 
        margin-bottom: 20px; 
        padding: 15px; 
        border-radius: 8px; 
        display: flex; 
        gap: 15px; 
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        color: #333;
    }
    label { font-weight: bold; }
    input { 
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
        background: #fff; 
        color: #333;
    }
    button { 
        padding: 8px 15px;
        border-radius: 4px;
        background-color: #673AB7; /* RSI 主題色改為紫色 */
        color: white; 
        border: none; 
        cursor: pointer; 
    }
    button:hover { background-color: #512DA8; }
    
    .strategy-panel {
      background: #fff;
      margin: 0 0 20px 0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .strategy-info {
      flex: 2;
      min-width: 300px;
    }
    
    .strategy-info h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      font-size: 1.2rem;
    }

    .strategy-rules {
      list-style: none;
      padding: 0;
      margin: 0;
      color: #555;
      line-height: 1.6;
    }

    .strategy-rules li {
      margin-bottom: 8px;
    }

    /* 強調文字 */
    .highlight-buy { color: #00C853; font-weight: bold; }
    .highlight-sell { color: #D50000; font-weight: bold; }

    /* 圖例區域 */
    .chart-legend {
      flex: 1;
      min-width: 200px;
      background: #fafafa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #666;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      display: inline-block;
      margin-right: 8px;
      border-radius: 2px;
    }

    /* RSI 圖例顏色 */
    .bg-rsi { background-color: #673AB7; } /* 紫色 */
    .bg-overbought { background-color: #e57373; opacity: 0.5; }
    .bg-oversold { background-color: #81c784; opacity: 0.5; }

    .icon-buy { 
      width: 0; height: 0; 
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid #00C853; 
      margin-right: 8px;
    }
    .icon-sell { 
      width: 0; height: 0; 
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 10px solid #D50000; 
      margin-right: 8px;
    }
    .ai-insight-box {
      background: linear-gradient(to right, #f8f9fa, #ffffff);
      border-left: 5px solid #673AB7; /* 紫色邊框呼應 RSI */
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      line-height: 1.6;
      color: #333;
      text-align: left;
    }
    
    .ai-insight-box h3 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 1.3rem;
    }
    .ai-insight-box strong {
      color: #d35400; 
    }
  </style>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/stock.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>

<div class="strategy-panel">
  <div class="strategy-info">
    <h3>策略邏輯：RSI 相對強弱指標 (Mean Reversion)</h3>
    <ul class="strategy-rules">
      <li>
        <strong>核心概念：</strong> 利用動能震盪指標捕捉市場的「超買」與「超賣」狀態，進行均值回歸交易。
      </li>
      <li>
        <span class="highlight-buy">買入訊號 (反彈)：</span> 
        當 RSI 進入 <span style="color:#2e7d32; font-weight:bold;">超賣區 (&lt; 30)</span> 並向上穿越時，視為非理性拋售結束，可能反彈。
      </li>
      <li>
        <span class="highlight-sell">賣出訊號 (回調)：</span> 
        當 RSI 進入 <span style="color:#c62828; font-weight:bold;">超買區 (&gt; 70)</span> 並向下穿越時，視為買盤過熱，可能回調。
      </li>
    </ul>
  </div>

  <div class="chart-legend">
    <div style="font-weight:bold; margin-bottom:10px;">圖表圖例</div>
    <div class="legend-item">
      <span class="legend-color bg-rsi"></span> RSI (14) 指標線
    </div>
    <div class="legend-item">
      <span class="legend-color bg-overbought"></span> 超買線 (70)
    </div>
    <div class="legend-item">
      <span class="legend-color bg-oversold"></span> 超賣線 (30)
    </div>
    <div class="legend-item">
      <span class="icon-buy"></span> 買入訊號 (RSI &uarr; 30)
    </div>
    <div class="legend-item">
      <span class="icon-sell"></span> 賣出訊號 (RSI &darr; 70)
    </div>
  </div>
</div>

<div id="controls">
  <label>開始時間：
    <input type="datetime-local" id="startDate" />
  </label>
  <label>結束時間：
    <input type="datetime-local" id="endDate" />
  </label>
  <button id="btnQuery">查詢區間</button>
  <span id="loadingText" style="margin-left: 10px; color: #666;"></span>
</div>

<div id="chartdiv"></div>

<div class="ai-insight-box">
    {{ ai_analysis|safe }}
</div>

<script>
const initialData = {{ chart_data|safe }};
const coinId = {{ coin_id }};

function toDatetimeLocalString(date) {
  const offset = date.getTimezoneOffset();
  const local = new Date(date.getTime() - offset * 60000);
  return local.toISOString().slice(0, 16);
}

function initDateInputs() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 30);
    document.getElementById('startDate').value = toDatetimeLocalString(start);
    document.getElementById('endDate').value = toDatetimeLocalString(end);
}

// ============================================
//  數學邏輯區 (RSI 算法)
// ============================================

/**
 * 計算 RSI
 * @param {Array} data - K線數據
 * @param {Number} period - 週期 (預設14)
 */
function calculateRSI(data, period = 14) {
    if (data.length < period + 1) return [];

    let rsiData = [];
    let gains = [];
    let losses = [];

    // 1. 計算漲跌幅
    for (let i = 1; i < data.length; i++) {
        let change = data[i].close - data[i - 1].close;
        gains.push(change > 0 ? change : 0);
        losses.push(change < 0 ? Math.abs(change) : 0);
    }

    // 2. 計算初始平均
    let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
    let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;

    // 3. 推算後續 RSI (Wilder's Smoothing)
    // 初始 RSI 點位對應的是 data[period]
    for (let i = period; i < data.length; i++) {
        let currentGain = gains[i - 1]; // 因為 gains 索引比 data 少 1
        let currentLoss = losses[i - 1];

        // Wilder 平滑公式
        avgGain = ((avgGain * (period - 1)) + currentGain) / period;
        avgLoss = ((avgLoss * (period - 1)) + currentLoss) / period;

        let rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
        let rsi = 100 - (100 / (1 + rs));

        rsiData.push({
            date: data[i].date,
            value: rsi,
            close: data[i].close // 保留收盤價以便後續畫訊號
        });
    }
    return rsiData;
}

/**
 * 計算 RSI 買賣訊號 (穿越策略)
 */
function calculateRSISignals(rsiData, overbought=70, oversold=30) {
    let signals = [];
    for (let i = 1; i < rsiData.length; i++) {
        let prevRsi = rsiData[i-1].value;
        let currRsi = rsiData[i].value;

        // 黃金交叉：RSI 從下方穿越 30 (買點)
        if (prevRsi < oversold && currRsi >= oversold) {
            signals.push({
                date: rsiData[i].date,
                value: rsiData[i].close, // 訊號畫在價格上
                signalType: "buy",
                description: `RSI 上穿 ${oversold} (買入)`
            });
        }
        // 死亡交叉：RSI 從上方穿越 70 (賣點)
        else if (prevRsi > overbought && currRsi <= overbought) {
            signals.push({
                date: rsiData[i].date,
                value: rsiData[i].close, // 訊號畫在價格上
                signalType: "sell",
                description: `RSI 下穿 ${overbought} (賣入)`
            });
        }
    }
    return signals;
}


am5.ready(function() {
  var root = am5.Root.new("chartdiv");
  root.setThemes([am5themes_Animated.new(root)]);

  var stockChart = root.container.children.push(am5stock.StockChart.new(root, {}));

  // === 1. 主面板 (K線 + 訊號) ===
  var mainPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    wheelY: "zoomX",
    height: am5.percent(60), // 主圖佔 60%
    layout: root.verticalLayout
  }));

  var dateAxisMain = mainPanel.xAxes.push(am5xy.DateAxis.new(root, {
    baseInterval: { timeUnit: "minute", count: 1 },
    renderer: am5xy.AxisRendererX.new(root, {}),
    tooltip: am5.Tooltip.new(root, {})
  }));

  var valueAxis = mainPanel.yAxes.push(am5xy.ValueAxis.new(root, {
    renderer: am5xy.AxisRendererY.new(root, { pan: "zoom" }),
    tooltip: am5.Tooltip.new(root, {})
  }));

  var candleSeries = mainPanel.series.push(am5xy.CandlestickSeries.new(root, {
    name: "價格",
    clustered: false,
    openValueYField: "open",
    highValueYField: "high",
    lowValueYField: "low",
    valueYField: "close",
    valueXField: "date",
    xAxis: dateAxisMain,
    yAxis: valueAxis
  }));

  // 設定卷軸
  mainPanel.set("scrollbarX", am5.Scrollbar.new(root, { orientation: "horizontal" }));

  // 策略訊號 Series (畫箭頭)
  var signalSeries = mainPanel.series.push(am5xy.LineSeries.new(root, {
      name: "策略訊號",
      valueYField: "value",
      valueXField: "date",
      xAxis: dateAxisMain,
      yAxis: valueAxis,
      stroke: undefined 
  }));

  // 訊號樣式 (箭頭)
  signalSeries.bullets.push(function (root, series, dataItem) {
      var context = dataItem.dataContext;
      var arrowSize = 30; 
      var strokeColor = am5.color(0xffffff);
      var strokeWidth = 2;

      if (context.signalType === "buy") {
          return am5.Bullet.new(root, {
              sprite: am5.Triangle.new(root, {
                  fill: am5.color(0x00E676),
                  stroke: strokeColor,
                  strokeWidth: strokeWidth,
                  width: arrowSize, height: arrowSize,
                  rotation: 0,
                  centerY: am5.p50, centerX: am5.p50,
                  tooltipText: context.description
              })
          });
      } else if (context.signalType === "sell") {
          return am5.Bullet.new(root, {
              sprite: am5.Triangle.new(root, {
                  fill: am5.color(0xFF1744),
                  stroke: strokeColor,
                  strokeWidth: strokeWidth,
                  width: arrowSize, height: arrowSize,
                  rotation: 180,
                  centerY: am5.p50, centerX: am5.p50,
                  tooltipText: context.description
              })
          });
      }
  });

  // === 2. RSI 面板 (新增) ===
  var rsiPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
      wheelX: "panX",
      height: am5.percent(20), // RSI 佔 20%
      layout: root.verticalLayout,
      paddingTop: 5
  }));

  var rsiValueAxis = rsiPanel.yAxes.push(am5xy.ValueAxis.new(root, {
      renderer: am5xy.AxisRendererY.new(root, { pan: "zoom" }),
      min: 0,
      max: 100, // RSI 固定 0-100
      strictMinMax: true
  }));

  var rsiDateAxis = rsiPanel.xAxes.push(am5xy.DateAxis.new(root, {
      baseInterval: { timeUnit: "minute", count: 1 },
      renderer: am5xy.AxisRendererX.new(root, { visible: false }), // 隱藏時間軸文字
      tooltip: am5.Tooltip.new(root, {})
  }));
  
  // 連結 X 軸連動縮放
  rsiDateAxis.groupData = true; 
  // 同步縮放
  // Note: amCharts 5 Stock Chart 自動處理 Panel 同步，只需確保都在 stockChart.panels 中

  var rsiSeries = rsiPanel.series.push(am5xy.LineSeries.new(root, {
      name: "RSI",
      valueYField: "value",
      valueXField: "date",
      xAxis: rsiDateAxis,
      yAxis: rsiValueAxis,
      stroke: am5.color(0x673AB7), // 紫色線
      strokeWidth: 2
  }));

  // 加入 RSI 70/30 參考線
  var rangeOverbought = rsiValueAxis.createAxisRange(rsiValueAxis.makeDataItem({ value: 70 }));
  rangeOverbought.get("grid").setAll({ stroke: am5.color(0xFF1744), strokeOpacity: 0.5, strokeDasharray: [5, 5] });
  rangeOverbought.get("label").setAll({ text: "70", fill: am5.color(0xFF1744), visible: true });

  var rangeOversold = rsiValueAxis.createAxisRange(rsiValueAxis.makeDataItem({ value: 30 }));
  rangeOversold.get("grid").setAll({ stroke: am5.color(0x00E676), strokeOpacity: 0.5, strokeDasharray: [5, 5] });
  rangeOversold.get("label").setAll({ text: "30", fill: am5.color(0x00E676), visible: true });


  // === 3. 成交量面板 (保持) ===
  var volumePanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    height: am5.percent(20), // 成交量佔 20%
    layout: root.verticalLayout
  }));
  var volumeAxis = volumePanel.yAxes.push(am5xy.ValueAxis.new(root, { renderer: am5xy.AxisRendererY.new(root, { inside: true }) }));
  var dateAxisVolume = volumePanel.xAxes.push(am5xy.DateAxis.new(root, { baseInterval: { timeUnit: "minute", count: 1 }, renderer: am5xy.AxisRendererX.new(root, { visible: false }) }));
  var volumeSeries = volumePanel.series.push(am5xy.ColumnSeries.new(root, {
    valueXField: "date", valueYField: "volume", xAxis: dateAxisVolume, yAxis: volumeAxis
  }));
  
  volumeSeries.columns.template.adapters.add("fill", function(fill, target) {
    var dataItem = target.dataItem;
    if (dataItem) { 
        return dataItem.dataContext.close > dataItem.dataContext.open ? am5.color(0xff0000) : am5.color(0x00aa00); 
    }
    return fill;
  });

  // === 資料更新函數 ===
  function updateChartData(data) {
      if (!data || data.length === 0) { alert("無資料"); return; }
      
      // 1. 設定 K 線與成交量
      candleSeries.data.setAll(data);
      volumeSeries.data.setAll(data);

      // 2. 計算 RSI
      let rsiData = calculateRSI(data, 14);
      rsiSeries.data.setAll(rsiData);

      // 3. 計算並設定訊號
      // 注意：rsiData 包含 'close' 價格，我們用它來定位箭頭高度
      let signals = calculateRSISignals(rsiData, 70, 30);
      signalSeries.data.setAll(signals);
  }

  async function fetchCoinHistory(coinId, start, end) {
    const url = new URL(`/coin-history/${coinId}/`, window.location.origin);
    url.searchParams.append("start", start.toISOString());
    url.searchParams.append("end", end.toISOString());
    try {
        document.getElementById('loadingText').textContent = "載入中...";
        const resp = await fetch(url);
        const json = await resp.json();
        document.getElementById('loadingText').textContent = "";
        return json.data;
    } catch (e) {
        console.error(e);
        return [];
    }
  }

  if (initialData && initialData.length > 0) { updateChartData(initialData); }
  initDateInputs();
  document.getElementById('btnQuery').addEventListener('click', async () => {
    const start = new Date(document.getElementById('startDate').value);
    const end = new Date(document.getElementById('endDate').value);
    const newData = await fetchCoinHistory(coinId, start, end);
    updateChartData(newData);
  });

});
</script>
</body>
</html>
{% endblock %}