{% extends 'base.html' %}

{% block title %}{{ questionnaire.title }}{% endblock %}
{% load static %}
{% block content %}
<style>
.font-size-inherit {
  font-size: inherit !important;
}

/* èƒŒæ™¯æµ®å‹•å€å¡Š - åŠé€æ˜ + æ¯›ç»ç’ƒ */
.floating-bar-modern {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 20px;
  padding: 14px 32px;
  background: rgba(255, 255, 255, 0.4);
  backdrop-filter: blur(20px);
  border-radius: 24px;
  box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
  z-index: 9999;
  animation: fadeInUp 0.6s ease-out;
}

/* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
.modern-btn {
  padding: 14px 28px;
  font-size: 18px;
  font-weight: bold;
  border-radius: 16px;
  border: none;
  transition: all 0.3s ease;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
}

/* ä¸»è¡Œå‹•æŒ‰éˆ•ï¼šæµè¡Œç´«â†’è—æ¼¸å±¤ + é™°å½± + å¾®å‹•ç•« */
.modern-btn.primary {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  color: white;
}
.modern-btn.primary:hover {
  transform: scale(1.05) translateY(-3px);
  box-shadow: 0 6px 24px rgba(99, 102, 241, 0.5);
}

/* æ¬¡è¦æŒ‰éˆ•ï¼šä¸­æ€§è‰²ï¼‹é‚Šæ¡†ï¼‹hover è®Šæ·¡ */
.modern-btn.secondary {
  background-color: #f9fafb;
  color: #374151;
  border: 1px solid #d1d5db;
}
.modern-btn.secondary:hover {
  background-color: #e5e7eb;
  transform: translateY(-2px);
}

/* æ‰‹æ©Ÿ RWD */
@media (max-width: 600px) {
  .floating-bar-modern {
    flex-direction: column;
    width: calc(100% - 32px);
    padding: 20px;
  }
  .modern-btn {
    width: 100%;
    justify-content: center;
  }
}

/* é€²å ´å‹•ç•« */
@keyframes fadeInUp {
  from {
    transform: translateX(-50%) translateY(30px);
    opacity: 0;
  }
  to {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
}
</style>

<h1>{{ questionnaire.title }}</h1>
{% if questionnaire.description %}
<p>{{ questionnaire.description }}</p>
{% endif %}

<!-- å­—é«”å¤§å°æ§åˆ¶æŒ‰éˆ• -->
<div class="mb-3">
  <label class="form-label">å­—é«”å¤§å°ï¼š</label>
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setFontSize('fs-6')">å°</button>
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setFontSize('fs-5')">ä¸­</button>
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setFontSize('fs-4')">å¤§</button>
</div>



<!-- å•å·è¡¨å–®å€å¡Š -->
<div id="questionnaire" class="fs-5">
<form id="questionnaire-form" method="post">
    {% csrf_token %}
    {% for item in questions_with_answers %}
        {% with question=item.question selected_ids=item.selected_ids %}
        <div class="container left-aligned-container bg-light p-5 text-start">      

            <p class="fw-bold font-size-inherit">{{ question.order }}. {{ question.content }} 
            {% if question.question_type == 'multiple' %}
                (è¤‡é¸é¡Œ)
            {% endif %}
            </p>
            <!-- åœ–ç‰‡ -->
            {% if question.id == 6 %}
              <div class="mt-3 text-right">
                <img src="{% static 'images/map.png' %}" alt="åœ°åœ–" class="img-fluid" style="max-width: 400px;">
              </div>
            {% endif %}

            {% if question.question_type == 'single' %}
                {% for option in question.answer_options.all %}
                    <label>
                        <input type="radio" name="question_{{ question.id }}" value="{{ option.id }}"
                               {% if option.id in selected_ids %}checked{% endif %}>
                        {{ option.content }}
                    </label><br>
                {% endfor %}

            {% elif question.question_type == 'multiple' %}
                {% for option in question.answer_options.all %}
                    <label>
                        <input type="checkbox" name="question_{{ question.id }}" value="{{ option.id }}"
                               {% if option.id in selected_ids %}checked{% endif %}>
                        {{ option.content }}
                    </label><br>
                {% endfor %}

            {% elif question.question_type == 'text' %}
                <textarea name="question_{{ question.id }}" rows="3" class="form-control"></textarea>
            {% endif %}
        </div>
        {% endwith %}
    {% endfor %}
</form>
<!-- æµ®å‹•æŒ‰éˆ•å€ -->
<div class="floating-bar-modern">
    <a href="{% url 'agent:questionnaire_list' %}" class="modern-btn secondary">
      ğŸ  è¿”å›ä¸Šé 
    </a>
    <button type="button" class="modern-btn primary" onclick="confirmSubmit()">
      ğŸš€ æäº¤å•å·
    </button>
</div>
</div>

<!-- å­—é«”èª¿æ•´èˆ‡å–æ¶ˆå–®é¸åŠŸèƒ½ -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    let isFormEdited = false;
    const form = document.getElementById("questionnaire-form");

    // âœ… å­—é«”å¤§å°èª¿æ•´åŠŸèƒ½
    window.setFontSize = function(sizeClass) {
      const container = document.getElementById('questionnaire');
      container.classList.remove('fs-4', 'fs-5', 'fs-6');
      container.classList.add(sizeClass);
    };

    // âœ… æ”¯æ´å–æ¶ˆå–®é¸é¸é …ï¼ˆä¸€å®šè¦æ”¾åœ¨ DOMContentLoaded å…§ï¼‰
    form.querySelectorAll('input[type=radio]').forEach(radio => {
      radio.addEventListener('click', function () {
        if (this.wasChecked) {
          this.checked = false;
          this.wasChecked = false;
          isFormEdited = true;  // â¬…ï¸ é€™é‚Šä¹Ÿè¦æ¨™è¨˜ç‚ºå·²ä¿®æ”¹ï¼
        } else {
          const radios = document.getElementsByName(this.name);
          radios.forEach(r => r.wasChecked = false);
          this.wasChecked = true;
        }
      });
    });

    // âœ… æ¨™è¨˜ä½¿ç”¨è€…æ˜¯å¦æœ‰ä¿®æ”¹è¡¨å–®ï¼ˆinput/change éƒ½ç®—ï¼‰
    form.querySelectorAll("input, textarea, select").forEach(el => {
      el.addEventListener("input", () => {
        isFormEdited = true;
      });
      el.addEventListener("change", () => {
        isFormEdited = true;
      });
    });

    // âœ… æ””æˆªåŸå§‹è¡¨å–®æäº¤ï¼Œç§»é™¤é›¢é–‹æç¤º
    form.addEventListener("submit", () => {
      window.onbeforeunload = null;
    });

    // âœ… è‹¥è¡¨å–®å·²ä¿®æ”¹ï¼Œé›¢é–‹æ™‚æç¤º
    window.onbeforeunload = function () {
      if (isFormEdited) {
        return "æ‚¨ç¢ºå®šè¦é›¢é–‹é é¢å—ï¼Ÿç›®å‰å¡«å¯«çš„è³‡æ–™å°‡æœƒéºå¤±ã€‚";
      }
    };
  });

  // âœ… æäº¤ç¢ºèªæç¤ºï¼ˆç¶å®šæµ®å‹•æŒ‰éˆ•ï¼‰
  function confirmSubmit() {
    const form = document.getElementById("questionnaire-form");
    if (confirm("æ‚¨ç¢ºå®šè¦é€å‡ºå•å·å—ï¼Ÿ")) {
      window.onbeforeunload = null;
      form.submit();
    }
  }
</script>


{% endblock %}
