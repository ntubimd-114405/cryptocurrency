{% extends 'base.html' %}

{% load static %}
{% block title %}å•å·é¦–é {% endblock %}

{% block content %}
{% load humanize %}
<link rel="stylesheet" href="{% static 'css/question_list.css' %}">

<h1>å•å·é¦–é </h1>
<hr>
    <div>
        <button class="analysis" id="analysisBtn">
            <span>
                <a href="{% url 'agent:analysis_result_view' %}" style="color: #fff;">åŸ·è¡Œç¸½åˆ†æ</a>
            </span>
        </button>
        <div id="tooltip">
            ç‰¹åˆ¥æé†’ï¼šå•å·ç¬¬ 2ã€3ã€4ã€9 é¡Œå°‡ç”¨ä¾†è¨ˆç®—æ‚¨çš„é¢¨éšªå±¬æ€§åˆ†æ•¸ï¼Œè«‹å‹™å¿…ä»”ç´°å¡«å¯«ã€‚
        </div>
    </div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<!-- Canvas -->
<table class="table table-bordered align-middle text-center">
    <thead class="table-light">
        <tr>
            <th class="text-center" style="width: 20%;">å•å·åç¨±&nbsp;(é»æ“Šå•å·åç¨±é–‹å§‹å¡«å¯«)</th>
            <th class="text-center" style="width: 15%;">æœ€å¾Œå¡«å¯«æ™‚é–“</th>
            <th class="text-center" style="width: 10%;">é€²åº¦</th>
            <th class="text-center" style="width: 15%;">æ“ä½œ</th>
        </tr>
    </thead>
    <tbody>
        {% for item in data %}
        <tr>
            <td class="tooltip table table-bordered align-middle text-start" style = "text-indent: 3em;">
                <a href="{% url 'agent:questionnaire_detail' item.questionnaire.id %}">
                    {{ item.questionnaire.id }}. {{ item.questionnaire.title }}
                </a>
                
                {% if item.questionnaire.description %}
                <span class="tooltip-text">{{ item.questionnaire.description }}</span>
                {% endif %}
            </td>
            
            <td style="width: 15%;">
                {% if item.last_completed %}
                {{ item.last_completed|date:"Y-m-d H:i" }}
                {% else %}
                å°šæœªå¡«å¯«
                {% endif %}
            </td>
            
            <td style="width: 10%;">
                <div class="progress" style="height: 20px; position: relative;">
                    <div class="progress-bar 
                        {% if item.progress == 100 %}
                            bg-success
                        {% elif item.progress >= 50 %}
                            bg-info
                        {% elif item.progress > 0 %}
                            bg-warning
                        {% else %}
                            bg-transparent
                        {% endif %}" 
                        role="progressbar" 
                        style="width: {{ item.progress }}%;" 
                        aria-valuenow="{{ item.progress }}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                    <span
                        style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 0.9rem;">
                        {{ item.progress }}%
                    </span>
                </div>
            </td>
            
            <td style="white-space: nowrap; width: 15%;">
                <div class="d-inline-flex gap-2 justify-content-center">
                    <form action="{% url 'agent:reset_questionnaire_answers' item.questionnaire.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç­”æ¡ˆä¸¦é‡æ–°å¡«å¯«å—ï¼Ÿ');">
                            é‡æ–°å¡«å¯«æ­¤å•å·
                        </button>
                    </form>
                </div>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6">ç›®å‰æ²’æœ‰å•å·</td>
        </tr>
        {% endfor %}
    </tbody>

</table>


{% if know %}
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true"
    data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <!-- æ¨™é¡Œ -->
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-primary" id="infoModalLabel">é‡è¦æé†’</h5>
            </div>

            <!-- èªªæ˜æ–‡å­— -->
            <div class="modal-body px-3 text-start">
                <p class="mb-3">
                <p style="text-indent: 1em;">
                    äº†è§£æ‚¨æ˜¯å“ªä¸€é¡å‹çš„æŠ•è³‡äººï¼Œæ˜¯æˆåŠŸè¦åŠƒæŠ•è³‡çš„ç¬¬ä¸€æ­¥ã€‚é€éé€™ä»½å•å·ï¼Œæ‚¨å°‡èƒ½æ·±å…¥èªè­˜è‡ªå·±çš„<span class="fw-semibold">é¢¨éšªæ‰¿å—èƒ½åŠ›</span>ã€<span
                        class="fw-semibold">æŠ•è³‡æœŸé™</span>èˆ‡<span class="fw-semibold">ç›®æ¨™</span>ã€‚
                </p>
                <p style="text-indent: 1em;">
                    é›–ç„¶é€™ä»½å•å·æ˜¯èˆ‡è²¡å‹™é¡§å•æºé€šçš„è‰¯å¥½èµ·é»ï¼Œä½†å®ƒä¸¦ä¸å–ä»£<span class="fw-semibold">å°ˆæ¥­é¡§å•æ‰€é€²è¡Œçš„å…¨é¢é¢¨éšªè©•ä¼°</span>ã€‚
                </p>
                </p>

                <div class="alert alert-warning mb-3 text-start">
                    <strong>ç‰¹åˆ¥æé†’ï¼š</strong> å•å·ç¬¬ <strong>2ã€3ã€4ã€9</strong> é¡Œå°‡ç”¨ä¾†è¨ˆç®—æ‚¨çš„é¢¨éšªå±¬æ€§åˆ†æ•¸ï¼Œè«‹å‹™å¿…ä»”ç´°å¡«å¯«ã€‚
                </div>
                <p class="fw-bold text-success mb-3 text-center">
                    é–‹å§‹å¡«å¯«ï¼Œè®“æˆ‘å€‘ä¸€èµ·æ‰“é€ ç¬¦åˆæ‚¨éœ€æ±‚çš„æŠ•è³‡ç­–ç•¥ï¼
                </p>

                <!-- å‹¾é¸æ¡† -->
                <div class="form-check d-flex justify-content-center align-items-center mt-4">
                    <input class="form-check-input me-2" type="checkbox" id="agreeCheck">
                    <label class="form-check-label fw-semibold mb-0" for="agreeCheck">
                        æˆ‘äº†è§£
                    </label>
                </div>
            </div>

            <!-- åº•éƒ¨æŒ‰éˆ• -->
            <form method="post" class="modal-footer w-100 d-flex justify-content-center">
                {% csrf_token %}
                <button type="submit" name="know_confirm" 
                id="btnUnderstand" 
                class="btn btn-primary w-100" 
                disabled 
                data-bs-dismiss="modal">
                ç¢ºå®š
            </button>
            </form>
        </div>
    </div>
</div>
{% endif %}



<script src="{% static 'js/question_list.js' %}"></script>

<script>
    const agreeCheck = document.getElementById("agreeCheck");
    const btnUnderstand = document.getElementById("btnUnderstand");

    agreeCheck.addEventListener("change", function () {
        btnUnderstand.disabled = !this.checked;
    });

    // é»ç¢ºå®šå°±é—œé–‰ Modal
    btnUnderstand.addEventListener("click", function () {
        const modal = bootstrap.Modal.getInstance(document.getElementById('infoModal'));
        modal.hide();
    });

document.addEventListener("DOMContentLoaded", function () {
  const checkbox = document.getElementById("agreeCheck");
  const btn = document.getElementById("btnUnderstand");

  checkbox.addEventListener("change", function () {
    btn.disabled = !checkbox.checked;
  });

  btn.addEventListener("click", function () {
    fetch("", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: "know_confirm=1"
    }).then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          // é—œé–‰ Modal
          const modal = bootstrap.Modal.getInstance(document.getElementById("infoModal"));
          modal.hide();
          // ğŸ”¹ ä¸»å‹•åˆ·æ–°é é¢ï¼Œç¾åœ¨æ˜¯ GET ç‹€æ…‹ï¼Œä¸æœƒè·³æç¤º
          window.location.reload();
        }
      });
  });

  const infoModal = new bootstrap.Modal(document.getElementById("infoModal"));
  infoModal.show();
  });
</script>


{% endblock %}