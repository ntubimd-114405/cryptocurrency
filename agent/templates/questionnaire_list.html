{% extends 'base.html' %}

{% load static %}
{% block title %}å•å·é¦–é {% endblock %}

{% block content %}
{% load humanize %}
<link rel="stylesheet" href="{% static 'css/question_list.css' %}">

<h1>å•å·é¦–é </h1>

<div class="modal-body" id="floatingTextContent">
    <!-- JS æœƒæŠŠå…§å®¹æ’é€²ä¾† -->
</div>
<div id="floatingTextTarget" class="container mt-4" style="display: none;"></div>

<div style="display: flex; gap: 10px;">
    <div style="width: 250px; height: 250px;">
        <h4>é€²åº¦å®Œæˆæ¯”ä¾‹</h4>
        <canvas id="completionChart"></canvas>
    </div>
    <div style="width: 250px; height: 250px;"></div>
    <div style="width: 250px; height: 250px;">
        <h4>ChatGptç¸½åˆ†æå ±å‘Š</h4>
        <button class="analysis">
            <span>
                <a href="{% url 'agent:analysis_result_view' %}" style="color: #fff;">
                    åŸ·è¡Œç¸½åˆ†æ
                </a>
            </span>
        </button>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ğŸ”¹ ç¸½åˆ†ææŒ‰éˆ•å€å¡Š -->

<button class="analysis">
    <span>
        <a href="{% url 'agent:history' %}" style="color: #fff;">
            å ±è¡¨
        </a>
    </span>
    
</button>

<h2>å•å·å®Œæˆé•·æ¢åœ–</h2>

<!-- Canvas -->
<table class="table table-bordered align-middle text-center">
    <thead class="table-light">
        <tr>
            <th>å•å·ç·¨è™Ÿ</th>
            <th>å•å·åç¨±</th>
            <th>ä¸Šæ¬¡å¡«å¯«æ™‚é–“</th>
            <th>å¡«å¯«é€²åº¦</th>
            <th>æ“ä½œ</th>
            <th>ChatGpt</th>
        </tr>
    </thead>
    <tbody>
        {% for item in data %}
        <tr>
            <td>{{ item.questionnaire.id }}</td>
            <td class="tooltip table table-bordered align-middle text-center">
                {{ item.questionnaire.title }}

                {% if item.questionnaire.description %}
                <span class="tooltip-text">{{ item.questionnaire.description }}</span>
                {% endif %}
            </td>
            <td>
                {% if item.last_completed %}
                {{ item.last_completed|date:"Y-m-d H:i" }}
                {% else %}
                å°šæœªå¡«å¯«
                {% endif %}
            </td>
            <td>
                <div class="progress" style="height: 20px; position: relative;">
                    <div class="progress-bar 
                        {% if item.progress == 100 %}
                            bg-success
                        {% elif item.progress >= 50 %}
                            bg-info
                        {% elif item.progress > 0 %}
                            bg-warning
                        {% else %}
                            bg-transparent
                        {% endif %}" role="progressbar" style="width: {{ item.progress }}%;"
                        aria-valuenow="{{ item.progress }}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                    <!-- æ–‡å­—å›ºå®šé¡¯ç¤ºåœ¨ä¸­é–“ -->
                    <span
                        style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 0.9rem;">
                        {{ item.progress }}%
                    </span>
                </div>
            </td>
            <td style="white-space: nowrap; width: 1%;">
                <div class="d-inline-flex gap-2 justify-content-center">
                    <a class="btn btn-primary btn-sm"
                        href="{% url 'agent:questionnaire_detail' item.questionnaire.id %}">
                        é–‹å§‹/ç¹¼çºŒå¡«å¯«
                    </a>
                    <a>|</a>
                    <form action="{% url 'agent:reset_questionnaire_answers' item.questionnaire.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç­”æ¡ˆä¸¦é‡æ–°å¡«å¯«å—ï¼Ÿ');">
                            é‡æ–°å¡«å¯«æ­¤å•å·
                        </button>
                    </form>
                </div>
            </td>
            <td>
                <a href="{% url 'agent:analyze_questionnaire' item.questionnaire.id %}">
                    åˆ†æ
                </a>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6">ç›®å‰æ²’æœ‰å•å·</td>
        </tr>
        {% endfor %}
    </tbody>
</table>



<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true"
    data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <!-- æ¨™é¡Œ -->
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-primary" id="infoModalLabel">é‡è¦æé†’</h5>
            </div>

            <!-- èªªæ˜æ–‡å­— -->
            <div class="modal-body px-3 text-start">
                <p class="mb-3">
                <p style="text-indent: 1em;">
                    äº†è§£æ‚¨æ˜¯å“ªä¸€é¡å‹çš„æŠ•è³‡äººï¼Œæ˜¯æˆåŠŸè¦åŠƒæŠ•è³‡çš„ç¬¬ä¸€æ­¥ã€‚é€éé€™ä»½å•å·ï¼Œæ‚¨å°‡èƒ½æ·±å…¥èªè­˜è‡ªå·±çš„<span class="fw-semibold">é¢¨éšªæ‰¿å—èƒ½åŠ›</span>ã€<span
                        class="fw-semibold">æŠ•è³‡æœŸé™</span>èˆ‡<span class="fw-semibold">ç›®æ¨™</span>ã€‚
                </p>
                <p style="text-indent: 1em;">
                    é›–ç„¶é€™ä»½å•å·æ˜¯èˆ‡è²¡å‹™é¡§å•æºé€šçš„è‰¯å¥½èµ·é»ï¼Œä½†å®ƒä¸¦ä¸å–ä»£<span class="fw-semibold">å°ˆæ¥­é¡§å•æ‰€é€²è¡Œçš„å…¨é¢é¢¨éšªè©•ä¼°</span>ã€‚
                </p>
                </p>

                <div class="alert alert-warning mb-3 text-start">
                    <strong>ç‰¹åˆ¥æé†’ï¼š</strong> å•å·ç¬¬ <strong>2ã€3ã€4ã€9</strong> é¡Œå°‡ç”¨ä¾†è¨ˆç®—æ‚¨çš„é¢¨éšªå±¬æ€§åˆ†æ•¸ï¼Œè«‹å‹™å¿…ä»”ç´°å¡«å¯«ã€‚
                </div>
                <p class="fw-bold text-success mb-3 text-center">
                    é–‹å§‹å¡«å¯«ï¼Œè®“æˆ‘å€‘ä¸€èµ·æ‰“é€ ç¬¦åˆæ‚¨éœ€æ±‚çš„æŠ•è³‡ç­–ç•¥ï¼
                </p>

                <!-- å‹¾é¸æ¡† -->
                <div class="form-check d-flex justify-content-center align-items-center mt-4">
                    <input class="form-check-input me-2" type="checkbox" id="agreeCheck">
                    <label class="form-check-label fw-semibold mb-0" for="agreeCheck">
                        æˆ‘äº†è§£
                    </label>
                </div>
            </div>

            <!-- åº•éƒ¨æŒ‰éˆ• -->
            <div class="modal-footer">
                <button type="button" id="btnUnderstand" class="btn btn-primary w-100" disabled>ç¢ºå®š</button>
            </div>

        </div>
    </div>
</div>



<script src="{% static 'js/question_list.js' %}"></script>

<script>
    const overallProgress = {{ overall_progress }};

    const ctx = document.getElementById('completionChart').getContext('2d');

    const completionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['å·²å®Œæˆ', 'æœªå®Œæˆ'],
            datasets: [{
                data: [overallProgress, 100 - overallProgress],
                backgroundColor: ['#4CAF50', '#E0E0E0'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: {
                    display: true,
                    labels: { color: '#333' }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return context.label + ': ' + context.parsed + '%';
                        }
                    }
                },
            }
        },
        plugins: [{
            id: 'centerText',
            beforeDraw(chart, args, options) {
                const { ctx, width, height } = chart;
                ctx.save();

                const fontSize = (height / 114).toFixed(2);
                ctx.font = fontSize + "em sans-serif";
                ctx.textBaseline = "middle";
                ctx.textAlign = "center";  // æ–‡å­—æ°´å¹³ç½®ä¸­

                const lines = ["å®Œæˆåº¦", overallProgress + "%"];
                const lineHeight = 35;  // è¡Œè·ï¼Œå¯èª¿æ•´

                const centerX = width / 2;
                const centerY = height / 1.75;

                // å…©è¡Œæ–‡å­—ä¸Šä¸‹æ’åˆ—ï¼Œä¸­é–“å°é½Š
                lines.forEach((line, i) => {
                    ctx.fillText(line, centerX, centerY - lineHeight / 2 + i * lineHeight);
                });

                ctx.restore();
            }
        }]
    });

    const agreeCheck = document.getElementById("agreeCheck");
    const btnUnderstand = document.getElementById("btnUnderstand");

    agreeCheck.addEventListener("change", function () {
        btnUnderstand.disabled = !this.checked;
    });

    // é»ç¢ºå®šå°±é—œé–‰ Modal
    btnUnderstand.addEventListener("click", function () {
        const modal = bootstrap.Modal.getInstance(document.getElementById('infoModal'));
        modal.hide();
    });
</script>


{% endblock %}