{% extends "base.html" %}

{% block title %}ç­–ç•¥è©³ç´°é é¢{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>åŠ å¯†è²¨å¹£ K ç·šåœ– - EMA è©³æƒ…</title>
  <style>
    /* === ä¿®æ”¹ 1: CSS æ”¹å›æ·ºè‰²ç³» === */
    body {
        background-color: #f5f5f5; /* æ•´å€‹ç¶²é èƒŒæ™¯æ·ºç° */
        color: #333;
        font-family: sans-serif;
    }
    #chartdiv { 
        width: 100%; 
        height: 600px; 
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    #controls { 
        margin-bottom: 20px; 
        padding: 15px; 
        border-radius: 8px; 
        display: flex; 
        gap: 15px; 
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        color: #333; /* æ–‡å­—æ·±è‰² */
    }
    label { font-weight: bold; }
    /* è¼¸å…¥æ¡†æ¨£å¼èª¿æ•´ç‚ºæ¨™æº–æ·ºè‰² */
    input { 
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
        background: #fff; 
        color: #333;
    }
    button { 
        padding: 8px 15px;
        border-radius: 4px;
        background-color: #2962FF; 
        color: white; 
        border: none; 
        cursor: pointer; 
    }
    button:hover { background-color: #1e4bb5; }
    .strategy-panel {
      background: #fff;
      margin: 0 0 20px 0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between; /* å·¦å³åˆ†ä½ˆ */
      flex-wrap: wrap;
      gap: 20px;
    }

    .strategy-info {
      flex: 2;
      min-width: 300px;
    }
    
    .strategy-info h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      font-size: 1.2rem;
    }

    .strategy-rules {
      list-style: none;
      padding: 0;
      margin: 0;
      color: #555;
      line-height: 1.6;
    }

    .strategy-rules li {
      margin-bottom: 8px;
    }

    /* å¼·èª¿æ–‡å­— */
    .highlight-buy { color: #00C853; font-weight: bold; }
    .highlight-sell { color: #D50000; font-weight: bold; }

    /* åœ–ä¾‹å€åŸŸ */
    .chart-legend {
      flex: 1;
      min-width: 200px;
      background: #fafafa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #666;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      display: inline-block;
      margin-right: 8px;
      border-radius: 2px;
    }

    /* åœ–ä¾‹é¡è‰²å°æ‡‰æ‚¨çš„ JS è¨­å®š */
    .bg-ema20 { background-color: #ff9900; }
    .bg-ema50 { background-color: #2962FF; }
    .icon-buy { 
      width: 0; height: 0; 
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid #00C853; /* ç¶ è‰²å‘ä¸Šä¸‰è§’å½¢ */
      margin-right: 8px;
    }
    .icon-sell { 
      width: 0; height: 0; 
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 10px solid #D50000; /* ç´…è‰²å‘ä¸‹ä¸‰è§’å½¢ */
      margin-right: 8px;
    }
    .ai-insight-box {
      background: linear-gradient(to right, #f8f9fa, #ffffff);
      border-left: 5px solid #2962FF; /* æ·±è—è‰²é‚Šæ¡†å‘¼æ‡‰ EMA */
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      line-height: 1.6;
      color: #333;
      text-align: left;
    }
    
    .ai-insight-box strong {
      color: #d35400; /* å¼·èª¿æ–‡å­—ç”¨æ·±æ©˜è‰² */
    }
    /* === æ–°å¢: å›æ¸¬è¡¨æ ¼æ¨£å¼ === */
    .performance-panel {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        margin-top: 20px;
    }
    .summary-cards {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .card {
        flex: 1;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #eee;
    }
    .card h4 { margin: 0 0 5px 0; color: #666; font-size: 0.9rem; }
    .card .value { font-size: 1.5rem; font-weight: bold; color: #333; }

    table.trade-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }
    table.trade-table th, table.trade-table td {
        padding: 12px;
        text-align: right; /* æ•¸å­—é å³ */
        border-bottom: 1px solid #eee;
    }
    table.trade-table th {
        text-align: right;
        background-color: #fafafa;
        color: #555;
        font-weight: 600;
    }
    /* ç¬¬ä¸€æ¬„æ—¥æœŸé å·¦ */
    table.trade-table th:first-child, table.trade-table td:first-child {
        text-align: left;
    }

    /* ç›ˆè™§é¡è‰² */
    .profit-pos { color: #00C853; font-weight: bold; } /* è³ºéŒ¢ç¶  */
    .profit-neg { color: #D50000; font-weight: bold; } /* è³ éŒ¢ç´… */
  </style>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/stock.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>



<div class="strategy-panel">
  <div class="strategy-info">
    <h3>ç­–ç•¥é‚è¼¯ï¼šEMA é›™å‡ç·šäº¤å‰</h3>
    <ul class="strategy-rules">
      <li>
        <strong>æ ¸å¿ƒæ¦‚å¿µï¼š</strong> åˆ©ç”¨çŸ­æœŸèˆ‡é•·æœŸè¶¨å‹¢ç·šçš„äº¤å‰ä¾†åˆ¤æ–·å¸‚å ´è½‰æŠ˜ã€‚
      </li>
      <li>
        <span class="highlight-buy">è²·å…¥è¨Šè™Ÿ (é»ƒé‡‘äº¤å‰)ï¼š</span> 
        ç•¶ <span style="color:#ff9900; font-weight:bold;">EMA 20 (çŸ­ç·š)</span> 
        å‘ä¸Šçªç ´ <span style="color:#2962FF; font-weight:bold;">EMA 50 (é•·ç·š)</span> æ™‚ï¼Œè¦–ç‚ºä¸Šæ¼²è¶¨å‹¢é–‹å§‹ã€‚
      </li>
      <li>
        <span class="highlight-sell">è³£å‡ºè¨Šè™Ÿ (æ­»äº¡äº¤å‰)ï¼š</span> 
        ç•¶ <span style="color:#ff9900; font-weight:bold;">EMA 20 (çŸ­ç·š)</span> 
        å‘ä¸‹è·Œç ´ <span style="color:#2962FF; font-weight:bold;">EMA 50 (é•·ç·š)</span> æ™‚ï¼Œè¦–ç‚ºä¸‹è·Œè¶¨å‹¢é–‹å§‹ã€‚
      </li>
    </ul>
  </div>

  <div class="chart-legend">
    <div style="font-weight:bold; margin-bottom:10px;">åœ–è¡¨åœ–ä¾‹</div>
    <div class="legend-item">
      <span class="legend-color bg-ema20"></span> EMA 20 (çŸ­æœŸå‡ç·š)
    </div>
    <div class="legend-item">
      <span class="legend-color bg-ema50"></span> EMA 50 (é•·æœŸå‡ç·š)
    </div>
    <div class="legend-item">
      <span class="icon-buy"></span> è²·å…¥è¨Šè™Ÿ
    </div>
    <div class="legend-item">
      <span class="icon-sell"></span> è³£å‡ºè¨Šè™Ÿ
    </div>
  </div>
</div>

<div id="controls">
  <label>é–‹å§‹æ™‚é–“ï¼š
    <input type="datetime-local" id="startDate" />
  </label>
  <label>çµæŸæ™‚é–“ï¼š
    <input type="datetime-local" id="endDate" />
  </label>
  <button id="btnQuery">æŸ¥è©¢å€é–“</button>
  <span id="loadingText" style="margin-left: 10px; color: #666;"></span>
</div>

<div id="chartdiv"></div>

<div class="performance-panel">
  <h3>ğŸ“Š ç­–ç•¥å›æ¸¬ç¸¾æ•ˆå ±å‘Š (ä¾æ“šç•¶å‰æ™‚é–“å€é–“)</h3>
  
  <div class="summary-cards">
      <div class="card">
          <h4>ç¸½äº¤æ˜“æ¬¡æ•¸</h4>
          <div class="value" id="totalTrades">0</div>
      </div>
      <div class="card">
          <h4>å‹ç‡</h4>
          <div class="value" id="winRate">0%</div>
      </div>
      <div class="card">
          <h4>ç¸½å ±é…¬ç‡ (ä¸å«è¤‡åˆ©)</h4>
          <div class="value" id="totalReturn">0.00%</div>
      </div>
  </div>

  <table class="trade-table">
      <thead>
          <tr>
              <th>è²·å…¥æ™‚é–“</th>
              <th>è²·å…¥åƒ¹æ ¼</th>
              <th>è³£å‡ºæ™‚é–“</th>
              <th>è³£å‡ºåƒ¹æ ¼</th>
              <th>æ¯å–®æç›Š (%)</th>
              <th>ç‹€æ…‹</th>
          </tr>
      </thead>
      <tbody id="tradeTableBody">
          </tbody>
  </table>
</div>

<div class="ai-insight-box">
    <p>
      <h2><strong>EMA é›™å‡ç·šäº¤å‰ç­–ç•¥åˆ†æå ±å‘Š</strong></h2>
      <strong>1. ç­–ç•¥æ·±åº¦è§£æï¼š</strong><br>
      EMA (æŒ‡æ•¸ç§»å‹•å¹³å‡) é›™å‡ç·šäº¤å‰ç­–ç•¥çš„æ ¸å¿ƒé‚è¼¯åœ¨æ–¼åˆ©ç”¨çŸ­æœŸèˆ‡é•·æœŸå‡ç·šä¹‹é–“çš„äº¤äº’é—œä¿‚ä¾†åˆ¤æ–·å¸‚å ´çš„è¶¨å‹¢å‹•èƒ½ã€‚ç•¶çŸ­æœŸå‡ç·š EMA 20 ä¸Šç©¿é•·æœŸå‡ç·š EMA 50 æ™‚ï¼Œå¸‚å ´èƒ½é‡é¡¯ç¤ºå‡ºä¸Šæ¼²è¶¨å‹¢ï¼Œé€™è¢«ç¨±ç‚ºã€Œé»ƒé‡‘äº¤å‰ã€ï¼Œæ„å‘³è‘—å¤šé ­å¸‚å ´é–‹å§‹å½¢æˆï¼›ç›¸åï¼Œç•¶çŸ­æœŸå‡ç·šä¸‹ç©¿é•·æœŸå‡ç·šï¼Œç”¢ç”Ÿã€Œæ­»äº¡äº¤å‰ã€ï¼Œå‰‡é¡¯ç¤ºå‡ºæŠ‘åˆ¶çš„è³£å£“ï¼Œè¨±å¤šäº¤æ˜“è€…æœƒé¸æ“‡è³£å‡ºã€‚

      EMA ç›¸è¼ƒæ–¼ SMA (ç°¡å–®ç§»å‹•å¹³å‡) çš„ä¸€å¤§å„ªå‹¢åœ¨æ–¼å…¶å°è¿‘æœŸåƒ¹æ ¼è®Šå‹•çš„æ•æ„Ÿåº¦ã€‚EMA æ›´åŠ é‡è¦–æœ€æ–°çš„åƒ¹æ ¼ä¿¡æ¯ï¼Œä½¿å…¶èƒ½åœ¨è¿…é€Ÿè®ŠåŒ–çš„å¸‚å ´ç’°å¢ƒä¸­æ›´å¿«åæ‡‰ï¼Œæä¾›æ›´å…·å‰ç»æ€§çš„äº¤æ˜“ä¿¡è™Ÿã€‚é€™å°æ–¼æ•æ‰å¿«é€Ÿç™¼ç”Ÿçš„è¶¨å‹¢è®ŠåŒ–è‡³é—œé‡è¦ã€‚
      <br>
      <strong>2. æŠ•è³‡å¤§å¸«å“²å­¸é€£çµï¼š</strong><br>
      è‘—åæŠ•è³‡å¤§å¸«ä¿ç¾…Â·éƒ½é¸Â·ç“Šæ–¯ï¼ˆPaul Tudor Jonesï¼‰ä»¥å…¶è¶¨å‹¢è·Ÿéš¨ç­–ç•¥èˆ‡å¼·èª¿å¸‚å ´è¡Œç‚ºçš„å“²å­¸è€Œèåã€‚ä»–æ›¾èªªéï¼šã€Œæˆ‘ä¸é—œå¿ƒå»å¹´çš„åƒ¹æ ¼ã€‚ã€é€™å¥è©±å¼·èª¿äº†å°ˆæ³¨æ–¼ç•¶å‰å¸‚å ´è¶¨å‹¢çš„é‡è¦æ€§ã€‚

      éƒ½é¸çš„äº¤æ˜“å“²å­¸èˆ‡ EMA é›™å‡ç·šäº¤å‰ç­–ç•¥ç•°æ›²åŒå·¥ï¼Œå› ç‚ºé€™ä¸€ç­–ç•¥æ˜ç¢ºåœ°é€éè¿½è¹¤å¸‚å ´è¶¨å‹¢ä¾†æŒ‡å°è²·è³£æ±ºç­–ã€‚ç„¡è«–æ˜¯é©—è­‰è¶¨å‹¢æŒçºŒæ€§é‚„æ˜¯åˆ¤æ–·è½‰æŠ˜é»ï¼ŒEMA ç­–ç•¥éƒ½åœç¹è‘—åŸºæ–¼å¸‚å ´å¯¦éš›èµ°å‹¢çš„æ±ºç­–ï¼Œé€™èˆ‡éƒ½é¸å¼·èª¿çš„æœ‰æ•ˆæ‡‰å°å¸‚å ´å‹•æ…‹çš„æ€è·¯å®Œç¾å¥‘åˆã€‚
  </p>
</div>

<script>
const initialData = {{ chart_data|safe }};
const coinId = {{ coin_id }};

function toDatetimeLocalString(date) {
  const offset = date.getTimezoneOffset();
  const local = new Date(date.getTime() - offset * 60000);
  return local.toISOString().slice(0, 16);
}

function initDateInputs() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 30);
    document.getElementById('startDate').value = toDatetimeLocalString(start);
    document.getElementById('endDate').value = toDatetimeLocalString(end);
}

// ============================================
//  æ•¸å­¸é‚è¼¯å€ (ä¿æŒä¸è®Š)
// ============================================

function calculateEMA(data, period) {
    let k = 2 / (period + 1);
    let emaData = [];
    if (data.length > 0) {
        let ema = data[0].close; 
        for (let i = 0; i < data.length; i++) {
            let close = data[i].close;
            ema = close * k + ema * (1 - k);
            emaData.push({
                date: data[i].date,
                value: ema,
                close: close 
            });
        }
    }
    return emaData;
}

function calculateCrossovers(shortEmaData, longEmaData) {
    let signals = [];
    let len = Math.min(shortEmaData.length, longEmaData.length);
    for (let i = 1; i < len; i++) {
        let prevShort = shortEmaData[i-1].value;
        let prevLong = longEmaData[i-1].value;
        let currShort = shortEmaData[i].value;
        let currLong = longEmaData[i].value;
        
        if (prevShort <= prevLong && currShort > currLong) {
            signals.push({
                date: shortEmaData[i].date,
                value: shortEmaData[i].close,
                signalType: "buy",
                description: "é»ƒé‡‘äº¤å‰ (è²·å…¥)"
            });
        }
        else if (prevShort >= prevLong && currShort < currLong) {
            signals.push({
                date: shortEmaData[i].date,
                value: shortEmaData[i].close,
                signalType: "sell",
                description: "æ­»äº¡äº¤å‰ (è³£å‡º)"
            });
        }
    }
    return signals;
}

function calculateAndRenderPerformance(signals) {
    const tableBody = document.getElementById('tradeTableBody');
    const elTotalTrades = document.getElementById('totalTrades');
    const elWinRate = document.getElementById('winRate');
    const elTotalReturn = document.getElementById('totalReturn');

    tableBody.innerHTML = ""; // æ¸…ç©ºè¡¨æ ¼

    let trades = [];
    let currentBuy = null;
    let totalProfitPercent = 0;
    let winCount = 0;

    // 1. éæ­·è¨Šè™Ÿé…å° (è²·å…¥ -> è³£å‡º)
    signals.forEach(sig => {
        if (sig.signalType === 'buy') {
            // å¦‚æœå·²ç¶“æœ‰å€‰ä½ï¼Œå…ˆå¿½ç•¥æ–°çš„è²·å…¥ (é€™è£¡å‡è¨­å–®å‘æŒå€‰)
            if (!currentBuy) {
                currentBuy = sig;
            }
        } else if (sig.signalType === 'sell') {
            if (currentBuy) {
                // çµç®—ä¸€ç­†äº¤æ˜“
                let entryPrice = currentBuy.value;
                let exitPrice = sig.value;
                let profitPercent = ((exitPrice - entryPrice) / entryPrice) * 100;

                trades.push({
                    entryDate: new Date(currentBuy.date), // è½‰æˆ Date ç‰©ä»¶æ–¹ä¾¿æ ¼å¼åŒ–
                    entryPrice: entryPrice,
                    exitDate: new Date(sig.date),
                    exitPrice: exitPrice,
                    profit: profitPercent
                });

                // ç´¯åŠ æ•¸æ“š
                totalProfitPercent += profitPercent;
                if (profitPercent > 0) winCount++;

                // æ¸…ç©ºæ‰‹ä¸Šçš„å–®
                currentBuy = null;
            }
        }
    });

    // 2. æ›´æ–°ç¸½çµå¡ç‰‡
    let tradeCount = trades.length;
    elTotalTrades.textContent = tradeCount;
    elWinRate.textContent = tradeCount > 0 ? ((winCount / tradeCount) * 100).toFixed(1) + "%" : "0%";
    
    // æ ¹æ“šæ­£è² è¨­å®šç¸½å ±é…¬é¡è‰²
    elTotalReturn.textContent = totalProfitPercent.toFixed(2) + "%";
    elTotalReturn.className = "value " + (totalProfitPercent >= 0 ? "profit-pos" : "profit-neg");

    // 3. æ¸²æŸ“è¡¨æ ¼ HTML
    // åè½‰é™£åˆ—ï¼Œè®“æœ€æ–°çš„äº¤æ˜“é¡¯ç¤ºåœ¨æœ€ä¸Šé¢
    trades.reverse().forEach(trade => {
        let row = document.createElement('tr');
        
        // æ ¼å¼åŒ–æ™‚é–“ (MM-DD HH:mm)
        const fmtDate = (d) => `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        
        let profitClass = trade.profit >= 0 ? "profit-pos" : "profit-neg";
        let profitSign = trade.profit >= 0 ? "+" : "";

        row.innerHTML = `
            <td>${fmtDate(trade.entryDate)}</td>
            <td>${trade.entryPrice.toFixed(2)}</td>
            <td>${fmtDate(trade.exitDate)}</td>
            <td>${trade.exitPrice.toFixed(2)}</td>
            <td class="${profitClass}">${profitSign}${trade.profit.toFixed(2)}%</td>
            <td>${trade.profit >= 0 ? "âœ… ç²åˆ©" : "âŒ è™§æ"}</td>
        `;
        tableBody.appendChild(row);
    });
}


am5.ready(function() {
  var root = am5.Root.new("chartdiv");
  root.setThemes([am5themes_Animated.new(root)]);

  var stockChart = root.container.children.push(am5stock.StockChart.new(root, {}));

  var mainPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    wheelY: "zoomX",
    height: am5.percent(70),
    layout: root.verticalLayout
  }));

  var dateAxisMain = mainPanel.xAxes.push(am5xy.DateAxis.new(root, {
    baseInterval: { timeUnit: "minute", count: 1 },
    renderer: am5xy.AxisRendererX.new(root, {}),
    tooltip: am5.Tooltip.new(root, {})
  }));

  var valueAxis = mainPanel.yAxes.push(am5xy.ValueAxis.new(root, {
    renderer: am5xy.AxisRendererY.new(root, { pan: "zoom" }),
    tooltip: am5.Tooltip.new(root, {})
  }));

  var candleSeries = mainPanel.series.push(am5xy.CandlestickSeries.new(root, {
    name: "åƒ¹æ ¼",
    clustered: false,
    openValueYField: "open",
    highValueYField: "high",
    lowValueYField: "low",
    valueYField: "close",
    valueXField: "date",
    xAxis: dateAxisMain,
    yAxis: valueAxis
  }));

  // === ä¿®æ”¹ 2: è£œå›æ‹‰æ¡¿ (Scrollbar) ===
  // åœ¨ä¸»é¢æ¿ä¸‹æ–¹åŠ å…¥æ°´å¹³æ²å‹•è»¸
  mainPanel.set("scrollbarX", am5.Scrollbar.new(root, {
    orientation: "horizontal"
  }));

  // EMA 20
  var emaShortSeries = mainPanel.series.push(am5xy.LineSeries.new(root, {
      name: "EMA 20",
      valueYField: "value",
      valueXField: "date",
      xAxis: dateAxisMain,
      yAxis: valueAxis,
      stroke: am5.color(0xff9900), // æ”¹ç¨å¾®æ·±ä¸€é»çš„æ©˜é»ƒï¼Œç™½åº•è¼ƒæ¸…æ¥š
      strokeWidth: 2
  }));

  // EMA 50
  var emaLongSeries = mainPanel.series.push(am5xy.LineSeries.new(root, {
      name: "EMA 50",
      valueYField: "value",
      valueXField: "date",
      xAxis: dateAxisMain,
      yAxis: valueAxis,
      stroke: am5.color(0x2962FF), // æ”¹æ·±è—è‰²ï¼Œç™½åº•è¼ƒæ¸…æ¥š
      strokeWidth: 2
  }));

  // ç­–ç•¥è¨Šè™Ÿ
  var signalSeries = mainPanel.series.push(am5xy.LineSeries.new(root, {
      name: "ç­–ç•¥è¨Šè™Ÿ",
      valueYField: "value",
      valueXField: "date",
      xAxis: dateAxisMain,
      yAxis: valueAxis,
      stroke: undefined 
  }));

  // â–¼â–¼â–¼â–¼â–¼â–¼ ä¿®æ”¹é–‹å§‹ â–¼â–¼â–¼â–¼â–¼â–¼
  signalSeries.bullets.push(function (root, series, dataItem) {
      var context = dataItem.dataContext;
      
      // è¨­å®šå…±ç”¨çš„æ¨£å¼è®Šæ•¸ï¼Œæ–¹ä¾¿èª¿æ•´
      var arrowSize = 30; // å°ºå¯¸ï¼šå¾ 15 æ”¹ç‚º 30ï¼Œéå¸¸å¤§ä¸”æ˜é¡¯
      var strokeColor = am5.color(0xffffff); // é‚Šæ¡†ï¼šç™½è‰²
      var strokeWidth = 2; // é‚Šæ¡†ç²—ç´°

      if (context.signalType === "buy") {
          return am5.Bullet.new(root, {
              sprite: am5.Triangle.new(root, {
                  fill: am5.color(0x00E676), // äº®ç¶ è‰² (æ›´è¢å…‰ä¸€é»)
                  stroke: strokeColor,
                  strokeWidth: strokeWidth,
                  width: arrowSize, 
                  height: arrowSize,
                  rotation: 0,
                  centerY: am5.p50, 
                  centerX: am5.p50,
                  tooltipText: "è²·å…¥è¨Šè™Ÿ" // æ»‘é¼ ç§»ä¸Šå»é¡¯ç¤ºæ–‡å­—
              })
          });
      } else if (context.signalType === "sell") {
          return am5.Bullet.new(root, {
              sprite: am5.Triangle.new(root, {
                  fill: am5.color(0xFF1744), // äº®ç´…è‰² (æ›´è¢å…‰ä¸€é»)
                  stroke: strokeColor,
                  strokeWidth: strokeWidth,
                  width: arrowSize, 
                  height: arrowSize,
                  rotation: 180,
                  centerY: am5.p50, 
                  centerX: am5.p50,
                  tooltipText: "è³£å‡ºè¨Šè™Ÿ" // æ»‘é¼ ç§»ä¸Šå»é¡¯ç¤ºæ–‡å­—
              })
          });
      }
  });
  // â–²â–²â–²â–²â–²â–² ä¿®æ”¹çµæŸ â–²â–²â–²â–²â–²â–²

  // æˆäº¤é‡éƒ¨åˆ†
  var volumePanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    height: am5.percent(30),
    layout: root.verticalLayout
  }));
  var volumeAxis = volumePanel.yAxes.push(am5xy.ValueAxis.new(root, { renderer: am5xy.AxisRendererY.new(root, { inside: true }) }));
  var dateAxisVolume = volumePanel.xAxes.push(am5xy.DateAxis.new(root, { baseInterval: { timeUnit: "minute", count: 1 }, renderer: am5xy.AxisRendererX.new(root, { visible: false }) }));
  var volumeSeries = volumePanel.series.push(am5xy.ColumnSeries.new(root, {
    valueXField: "date", valueYField: "volume", xAxis: dateAxisVolume, yAxis: volumeAxis
  }));
  
  // ç¢ºä¿ K ç·šè·Œæ™‚æˆäº¤é‡ä¹Ÿæ˜¯ç¶ è‰²/ç´…è‰²æ­£ç¢ºå°æ‡‰
  volumeSeries.columns.template.adapters.add("fill", function(fill, target) {
    var dataItem = target.dataItem;
    if (dataItem) { 
        // æ¼²ç´…è·Œç¶  (å°ç£ç¿’æ…£)ï¼Œè‹¥è¦åœ‹éš›ç‰ˆ (æ¼²ç¶ è·Œç´…) è«‹è‡ªè¡Œäº¤æ›é¡è‰²
        return dataItem.dataContext.close > dataItem.dataContext.open ? am5.color(0xff0000) : am5.color(0x00aa00); 
    }
    return fill;
  });

  // è³‡æ–™æ›´æ–°å‡½æ•¸
  function updateChartData(data) {
    if (!data || data.length === 0) { alert("ç„¡è³‡æ–™"); return; }
    
    // 1. æ›´æ–°åœ–è¡¨æ•¸æ“š (Kç·šã€æˆäº¤é‡)
    candleSeries.data.setAll(data);
    volumeSeries.data.setAll(data);

    // 2. è¨ˆç®— EMA
    let emaShortData = calculateEMA(data, 20);
    let emaLongData = calculateEMA(data, 50);
    emaShortSeries.data.setAll(emaShortData);
    emaLongSeries.data.setAll(emaLongData);

    // 3. è¨ˆç®—è¨Šè™Ÿ
    let signals = calculateCrossovers(emaShortData, emaLongData);
    signalSeries.data.setAll(signals);

    // === æ–°å¢é€™è¡Œï¼šè¨ˆç®—ä¸¦æ›´æ–°è¡¨æ ¼ ===
    calculateAndRenderPerformance(signals);
}

  async function fetchCoinHistory(coinId, start, end) {
    const url = new URL(`/coin-history/${coinId}/`, window.location.origin);
    url.searchParams.append("start", start.toISOString());
    url.searchParams.append("end", end.toISOString());
    try {
        document.getElementById('loadingText').textContent = "è¼‰å…¥ä¸­...";
        const resp = await fetch(url);
        const json = await resp.json();
        document.getElementById('loadingText').textContent = "";
        return json.data;
    } catch (e) {
        console.error(e);
        return [];
    }
  }

  if (initialData && initialData.length > 0) { updateChartData(initialData); }
  initDateInputs();
  document.getElementById('btnQuery').addEventListener('click', async () => {
    const start = new Date(document.getElementById('startDate').value);
    const end = new Date(document.getElementById('endDate').value);
    const newData = await fetchCoinHistory(coinId, start, end);
    updateChartData(newData);
  });

});
</script>
</body>
</html>
{% endblock %}