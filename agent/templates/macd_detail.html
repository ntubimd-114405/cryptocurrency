{% extends "base.html" %}

{% block title %}MACD ç­–ç•¥è©³ç´°é é¢{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>åŠ å¯†è²¨å¹£ K ç·šåœ– - MACD è©³æƒ…</title>
  <style>
    /* === å…¨åŸŸæ¨£å¼è¨­å®š === */
    body {
        background-color: #f5f5f5;
        color: #333;
        font-family: sans-serif;
    }
    #chartdiv { 
        width: 100%; 
        height: 800px; /* åŠ é«˜é«˜åº¦ä»¥å®¹ç´ MACD é¢æ¿ */
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    #controls { 
        margin-bottom: 20px; 
        padding: 15px; 
        border-radius: 8px; 
        display: flex; 
        gap: 15px; 
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        color: #333;
    }
    label { font-weight: bold; }
    input { 
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
        background: #fff; 
        color: #333;
    }
    button { 
        padding: 8px 15px;
        border-radius: 4px;
        background-color: #2962FF; 
        color: white; 
        border: none; 
        cursor: pointer; 
    }
    button:hover { background-color: #1e4bb5; }
    
    /* === ç­–ç•¥è³‡è¨Šé¢æ¿æ¨£å¼ === */
    .strategy-panel {
      background: #fff;
      margin: 0 0 20px 0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .strategy-info {
      flex: 2;
      min-width: 300px;
    }
    
    .strategy-info h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      font-size: 1.2rem;
    }

    .strategy-rules {
      list-style: none;
      padding: 0;
      margin: 0;
      color: #555;
      line-height: 1.6;
    }

    .strategy-rules li {
      margin-bottom: 8px;
    }

    /* å¼·èª¿æ–‡å­— */
    .highlight-buy { color: #00C853; font-weight: bold; }
    .highlight-sell { color: #D50000; font-weight: bold; }

    /* åœ–ä¾‹å€åŸŸ */
    .chart-legend {
      flex: 1;
      min-width: 200px;
      background: #fafafa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #666;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      display: inline-block;
      margin-right: 8px;
      border-radius: 2px;
    }

    /* MACD åœ–ä¾‹é¡è‰² */
    .bg-dif { background-color: #2962FF; } /* å¿«ç·šè—è‰² */
    .bg-dem { background-color: #FF6D00; } /* è¨Šè™Ÿç·šæ©˜è‰² */
    .bg-hist-pos { background-color: #00C853; }
    .bg-hist-neg { background-color: #D50000; }

    .icon-buy { 
      width: 0; height: 0; 
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid #00C853; 
      margin-right: 8px;
    }
    .icon-sell { 
      width: 0; height: 0; 
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 10px solid #D50000; 
      margin-right: 8px;
    }

    /* AI åˆ†æå€å¡Š */
    .ai-insight-box {
      background: linear-gradient(to right, #f8f9fa, #ffffff);
      border-left: 5px solid #673AB7; /* MACD ç”¨ç´«è‰²ç³»å€éš” */
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      line-height: 1.6;
      color: #333;
      text-align: left;
    }
    
    .ai-insight-box strong {
      color: #673AB7; 
    }

    /* === æ–°å¢: å›æ¸¬è¡¨æ ¼æ¨£å¼ === */
    .performance-panel {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        margin-top: 20px;
    }
    .summary-cards {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .card {
        flex: 1;
        min-width: 150px;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid #eee;
    }
    .card h4 { margin: 0 0 5px 0; color: #666; font-size: 0.9rem; }
    .card .value { font-size: 1.5rem; font-weight: bold; color: #333; }

    table.trade-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }
    table.trade-table th, table.trade-table td {
        padding: 12px;
        text-align: right;
        border-bottom: 1px solid #eee;
    }
    table.trade-table th {
        text-align: right;
        background-color: #fafafa;
        color: #555;
        font-weight: 600;
    }
    /* ç¬¬ä¸€æ¬„æ—¥æœŸé å·¦ */
    table.trade-table th:first-child, table.trade-table td:first-child {
        text-align: left;
    }

    /* ç›ˆè™§é¡è‰² */
    .profit-pos { color: #00C853; font-weight: bold; } /* è³ºéŒ¢ç¶  */
    .profit-neg { color: #D50000; font-weight: bold; } /* è³ éŒ¢ç´… */
  </style>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/stock.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>

<div class="strategy-panel">
  <div class="strategy-info">
    <h3>ç­–ç•¥é‚è¼¯ï¼šMACD è¶¨å‹¢å‹•èƒ½æŒ‡æ¨™</h3>
    <ul class="strategy-rules">
      <li>
        <strong>åƒæ•¸è¨­å®šï¼š</strong> å¿«ç·š Fast EMA (12)ã€æ…¢ç·š Slow EMA (26)ã€è¨Šè™Ÿç·š Signal (9)ã€‚
      </li>
      <li>
        <span class="highlight-buy">è²·å…¥è¨Šè™Ÿ (é»ƒé‡‘äº¤å‰)ï¼š</span> 
        ç•¶ <span style="color:#2962FF; font-weight:bold;">DIF å¿«ç·š</span> 
        å‘ä¸Šçªç ´ <span style="color:#FF6D00; font-weight:bold;">DEM è¨Šè™Ÿç·š</span>ï¼Œä¸”æŸ±ç‹€åœ–ç”±è² è½‰æ­£ã€‚
      </li>
      <li>
        <span class="highlight-sell">è³£å‡ºè¨Šè™Ÿ (æ­»äº¡äº¤å‰)ï¼š</span> 
        ç•¶ <span style="color:#2962FF; font-weight:bold;">DIF å¿«ç·š</span> 
        å‘ä¸‹è·Œç ´ <span style="color:#FF6D00; font-weight:bold;">DEM è¨Šè™Ÿç·š</span>ï¼Œä¸”æŸ±ç‹€åœ–ç”±æ­£è½‰è² ã€‚
      </li>
    </ul>
  </div>

  <div class="chart-legend">
    <div style="font-weight:bold; margin-bottom:10px;">MACD åœ–ä¾‹</div>
    <div class="legend-item">
      <span class="legend-color bg-dif"></span> DIF (å¿«æ…¢ç·šå·®)
    </div>
    <div class="legend-item">
      <span class="legend-color bg-dem"></span> DEM (è¨Šè™Ÿç·š)
    </div>
    <div class="legend-item">
      <span class="legend-color bg-hist-pos"></span> æŸ±ç‹€åœ– (å¤šé ­)
    </div>
    <div class="legend-item">
      <span class="legend-color bg-hist-neg"></span> æŸ±ç‹€åœ– (ç©ºé ­)
    </div>
    <div class="legend-item">
      <span class="icon-buy"></span> è²·å…¥è¨Šè™Ÿ
    </div>
    <div class="legend-item">
      <span class="icon-sell"></span> è³£å‡ºè¨Šè™Ÿ
    </div>
  </div>
</div>

<div id="controls">
  <label>é–‹å§‹æ™‚é–“ï¼š
    <input type="datetime-local" id="startDate" />
  </label>
  <label>çµæŸæ™‚é–“ï¼š
    <input type="datetime-local" id="endDate" />
  </label>
  <button id="btnQuery">æŸ¥è©¢å€é–“</button>
  <span id="loadingText" style="margin-left: 10px; color: #666;"></span>
</div>

<div id="chartdiv"></div>

<div class="performance-panel">
    <h3>ğŸ“Š MACD ç­–ç•¥å›æ¸¬ç¸¾æ•ˆå ±å‘Š (ä¾æ“šç•¶å‰æ™‚é–“å€é–“)</h3>
    
    <div class="summary-cards">
        <div class="card">
            <h4>ç¸½äº¤æ˜“æ¬¡æ•¸</h4>
            <div class="value" id="totalTrades">0</div>
        </div>
        <div class="card">
            <h4>å‹ç‡</h4>
            <div class="value" id="winRate">0%</div>
        </div>
        <div class="card">
            <h4>ç¸½å ±é…¬ç‡ (ä¸å«è¤‡åˆ©)</h4>
            <div class="value" id="totalReturn">0.00%</div>
        </div>
    </div>
  
    <table class="trade-table">
        <thead>
            <tr>
                <th>è²·å…¥æ™‚é–“</th>
                <th>è²·å…¥åƒ¹æ ¼</th>
                <th>è³£å‡ºæ™‚é–“</th>
                <th>è³£å‡ºåƒ¹æ ¼</th>
                <th>æ¯å–®æç›Š (%)</th>
                <th>ç‹€æ…‹</th>
            </tr>
        </thead>
        <tbody id="tradeTableBody">
            </tbody>
    </table>
  </div>

<div class="ai-insight-box">
    <p>
      <h2><strong>MACD è¶¨å‹¢å‹•èƒ½ç­–ç•¥åˆ†æå ±å‘Š</strong></h2>
      <strong>1. ç­–ç•¥æ·±åº¦è§£æï¼š</strong><br>
      MACDï¼ˆæŒ‡æ•¸å¹³æ»‘ç•°åŒç§»å‹•å¹³å‡ç·šï¼‰ç­–ç•¥é€éä¸‰æ¢ç·šçš„ç›¸äº’é—œä¿‚ï¼Œèƒ½æœ‰æ•ˆæ•æ‰å¸‚å ´çš„ã€Œè¶¨å‹¢æ–¹å‘ã€èˆ‡ã€Œå‹•èƒ½å¼·å¼±ã€ã€‚å¿«é€ŸæŒ‡æ•¸ç§»å‹•å¹³å‡ç·šï¼ˆå¿«ç·šï¼‰èˆ‡æ…¢é€ŸæŒ‡æ•¸ç§»å‹•å¹³å‡ç·šï¼ˆæ…¢ç·šï¼‰ä¹‹é–“çš„å·®è·ï¼ˆDIFï¼‰åæ˜ äº†ç•¶å‰è¶¨å‹¢çš„å¼·åº¦ï¼Œè€Œå®ƒå€‘èˆ‡è¨Šè™Ÿç·šï¼ˆDEMï¼‰ä¹‹é–“çš„äº¤å‰å‰‡æä¾›äº†é€²å‡ºå ´çš„è¨Šè™Ÿã€‚

      ç•¶DIFå‘ä¸Šçªç ´DEMæ™‚ï¼Œå½¢æˆé»ƒé‡‘äº¤å‰ï¼Œæ„å‘³è‘—è¶¨å‹¢å¯èƒ½è½‰ç‚ºä¸Šå‡ï¼›ç›¸åï¼Œè‹¥DIFå‘ä¸‹è·Œç ´DEMï¼Œå‰‡ç‚ºæ­»äº¡äº¤å‰ï¼Œé ç¤ºè‘—ä¸‹è·Œè¶¨å‹¢çš„å½¢æˆã€‚é€™è®“æŠ•è³‡è€…èƒ½å¤ ä¸åƒ…æŒæ¡è¶¨å‹¢çš„æ–¹å‘ï¼Œé‚„èƒ½åˆ¤æ–·å‹•èƒ½çš„å¼·å¼±ã€‚

      åŒæ™‚ï¼ŒæŸ±ç‹€åœ–ï¼ˆHistogramï¼‰çš„æ“´å¤§èˆ‡ç¸®å°å°å¸‚å ´å¿ƒç†è®ŠåŒ–å…·æœ‰æŒ‡ç¤ºæ„ç¾©ã€‚ç•¶æŸ±ç‹€åœ–èµ°ç”±è² è½‰æ­£ï¼Œé¡¯ç¤ºç©ºé ­åŠ›é“çš„è¡°ç«­ï¼Œè€Œå¤šé ­å‹•èƒ½é–‹å§‹å¢å¼·ï¼›åä¹‹ï¼ŒæŸ±ç‹€åœ–ç¸®å°å¯èƒ½é ç¤ºå¤šé ­å‹•èƒ½çš„ç–²å¼±ç”šè‡³è½‰å‘ç©ºé ­ã€‚
      <br>
      <strong>2. æŠ•è³‡å¤§å¸«å“²å­¸é€£çµï¼š</strong><br>
      MACDçš„ç™¼æ˜è€…Gerald Appelå¼·èª¿æŠ€è¡“åˆ†ææ‡‰èƒ½æœ‰æ•ˆå¹«åŠ©æŠ•è³‡è€…è­˜åˆ¥å¸‚å ´å‹•æ…‹ã€‚ä»–æ‰€æå€¡çš„ç­–ç•¥ä¸åƒ…åƒ…æ˜¯ä¾è³´å–®ä¸€æŒ‡æ¨™ï¼Œè€Œæ˜¯çµåˆå¤šå€‹æŒ‡æ¨™å…±åŒåˆ¤æ–·å¸‚å ´è¶¨å‹¢ï¼Œé€™ä¹Ÿä¿ƒé€²äº†MACDåœ¨å¯¦éš›äº¤æ˜“ä¸­çš„æ‡‰ç”¨ã€‚

      æ­¤å¤–ï¼Œè‘—åæŠ•è³‡å¤§å¸«Alexander Elderåœ¨å…¶è‘—ä½œã€Šæ“ä½œç”Ÿæ¶¯ä¸æ˜¯å¤¢ã€‹ä¸­ä»‹ç´¹çš„ã€Œä¸‰é‡æ¿¾ç¶²ç³»çµ±ã€ä¹Ÿæåˆ°ï¼ŒMACDå¯ä½œç‚ºé‡è¦çš„å‹•èƒ½æŒ‡æ¨™ä¾†éæ¿¾å¸‚å ´é›œè¨Šï¼Œé¿å…èª¤åˆ¤è¶¨å‹¢ã€‚ç›¸æ¯”æ–¼å–®ç´”çš„ç§»å‹•å¹³å‡ç·šï¼ŒMACDçµåˆäº†å‹•èƒ½çš„è®ŠåŒ–ï¼Œä½¿å¾—äº¤æ˜“ä¿¡è™Ÿæ›´åŠ ç²¾ç¢ºèˆ‡å¯é ã€‚
    </p>
</div>

<script>
const initialData = {{ chart_data|safe }};
const coinId = {{ coin_id }};

function toDatetimeLocalString(date) {
  const offset = date.getTimezoneOffset();
  const local = new Date(date.getTime() - offset * 60000);
  return local.toISOString().slice(0, 16);
}

function initDateInputs() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 30);
    document.getElementById('startDate').value = toDatetimeLocalString(start);
    document.getElementById('endDate').value = toDatetimeLocalString(end);
}

// ============================================
//  MACD æ•¸å­¸é‚è¼¯å€
// ============================================

// é€šç”¨çš„ EMA è¨ˆç®—å‡½æ•¸
function calculateEMAGeneric(data, period, field) {
    let k = 2 / (period + 1);
    let emaArray = []; 
    let resultData = []; 
    
    if (data.length > 0) {
        let firstVal = data[0][field]; 
        if(firstVal === undefined) firstVal = 0;

        let ema = firstVal;
        
        for (let i = 0; i < data.length; i++) {
            let val = data[i][field];
            if(val !== undefined && val !== null) {
                ema = val * k + ema * (1 - k);
            }
            emaArray.push(ema);
            resultData.push({
                date: data[i].date,
                value: ema
            });
        }
    }
    return { values: emaArray, data: resultData };
}

// è¨ˆç®— MACD
function calculateMACD(data, fastPeriod=12, slowPeriod=26, signalPeriod=9) {
    // 1. è¨ˆç®— Fast EMA (12)
    const fastEMA = calculateEMAGeneric(data, fastPeriod, "close").values;
    // 2. è¨ˆç®— Slow EMA (26)
    const slowEMA = calculateEMAGeneric(data, slowPeriod, "close").values;
    
    // 3. è¨ˆç®— DIF = Fast - Slow
    let difData = [];
    for(let i=0; i<data.length; i++){
        let dif = fastEMA[i] - slowEMA[i];
        difData.push({
            date: data[i].date,
            dif: dif,       
            close: data[i].close 
        });
    }

    // 4. è¨ˆç®— DEM (Signal Line) = EMA(DIF, 9)
    const demValues = calculateEMAGeneric(difData, signalPeriod, "dif").values;

    // 5. çµ„åˆæœ€çµ‚è³‡æ–™ (å« Histogram)
    let macdResult = [];
    for(let i=0; i<data.length; i++){
        let dif = difData[i].dif;
        let dem = demValues[i];
        let hist = dif - dem;
        
        macdResult.push({
            date: data[i].date,
            dif: dif,
            dem: dem,
            histogram: hist,
            close: data[i].close
        });
    }
    return macdResult;
}

// è¨ˆç®—äº¤å‰è¨Šè™Ÿ (æ ¹æ“š MACD çµæœ)
function calculateMACDCrossovers(macdData) {
    let signals = [];
    for (let i = 1; i < macdData.length; i++) {
        let prevDif = macdData[i-1].dif;
        let prevDem = macdData[i-1].dem;
        let currDif = macdData[i].dif;
        let currDem = macdData[i].dem;
        
        // é»ƒé‡‘äº¤å‰: DIF å‘ä¸Šçªç ´ DEM
        if (prevDif <= prevDem && currDif > currDem) {
            signals.push({
                date: macdData[i].date,
                value: macdData[i].close, // è¨Šè™Ÿç•«åœ¨ K ç·šæ”¶ç›¤åƒ¹ä¸Š
                signalType: "buy",
                description: "MACD é»ƒé‡‘äº¤å‰"
            });
        }
        // æ­»äº¡äº¤å‰: DIF å‘ä¸‹è·Œç ´ DEM
        else if (prevDif >= prevDem && currDif < currDem) {
            signals.push({
                date: macdData[i].date,
                value: macdData[i].close,
                signalType: "sell",
                description: "MACD æ­»äº¡äº¤å‰"
            });
        }
    }
    return signals;
}

// ============================================
//  æ–°å¢: å›æ¸¬è¨ˆç®—èˆ‡è¡¨æ ¼æ¸²æŸ“é‚è¼¯
// ============================================
function calculateAndRenderPerformance(signals) {
    const tableBody = document.getElementById('tradeTableBody');
    const elTotalTrades = document.getElementById('totalTrades');
    const elWinRate = document.getElementById('winRate');
    const elTotalReturn = document.getElementById('totalReturn');

    tableBody.innerHTML = ""; // æ¸…ç©ºè¡¨æ ¼

    let trades = [];
    let currentBuy = null;
    let totalProfitPercent = 0;
    let winCount = 0;

    // 1. éæ­·è¨Šè™Ÿé…å° (è²·å…¥ -> è³£å‡º)
    signals.forEach(sig => {
        if (sig.signalType === 'buy') {
            // å¦‚æœå·²ç¶“æœ‰å€‰ä½ï¼Œå…ˆå¿½ç•¥æ–°çš„è²·å…¥ (å‡è¨­å–®å‘æŒå€‰)
            if (!currentBuy) {
                currentBuy = sig;
            }
        } else if (sig.signalType === 'sell') {
            if (currentBuy) {
                // çµç®—ä¸€ç­†äº¤æ˜“
                let entryPrice = currentBuy.value;
                let exitPrice = sig.value;
                let profitPercent = ((exitPrice - entryPrice) / entryPrice) * 100;

                trades.push({
                    entryDate: new Date(currentBuy.date), 
                    entryPrice: entryPrice,
                    exitDate: new Date(sig.date),
                    exitPrice: exitPrice,
                    profit: profitPercent
                });

                // ç´¯åŠ æ•¸æ“š
                totalProfitPercent += profitPercent;
                if (profitPercent > 0) winCount++;

                // æ¸…ç©ºæ‰‹ä¸Šçš„å–®
                currentBuy = null;
            }
        }
    });

    // 2. æ›´æ–°ç¸½çµå¡ç‰‡
    let tradeCount = trades.length;
    elTotalTrades.textContent = tradeCount;
    elWinRate.textContent = tradeCount > 0 ? ((winCount / tradeCount) * 100).toFixed(1) + "%" : "0%";
    
    // æ ¹æ“šæ­£è² è¨­å®šç¸½å ±é…¬é¡è‰²
    elTotalReturn.textContent = totalProfitPercent.toFixed(2) + "%";
    elTotalReturn.className = "value " + (totalProfitPercent >= 0 ? "profit-pos" : "profit-neg");

    // 3. æ¸²æŸ“è¡¨æ ¼ HTML (åè½‰é™£åˆ—ï¼Œè®“æœ€æ–°çš„äº¤æ˜“é¡¯ç¤ºåœ¨æœ€ä¸Šé¢)
    trades.reverse().forEach(trade => {
        let row = document.createElement('tr');
        
        // æ ¼å¼åŒ–æ™‚é–“ (MM-DD HH:mm)
        const fmtDate = (d) => `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        
        let profitClass = trade.profit >= 0 ? "profit-pos" : "profit-neg";
        let profitSign = trade.profit >= 0 ? "+" : "";

        row.innerHTML = `
            <td>${fmtDate(trade.entryDate)}</td>
            <td>${trade.entryPrice.toFixed(2)}</td>
            <td>${fmtDate(trade.exitDate)}</td>
            <td>${trade.exitPrice.toFixed(2)}</td>
            <td class="${profitClass}">${profitSign}${trade.profit.toFixed(2)}%</td>
            <td>${trade.profit >= 0 ? "âœ… ç²åˆ©" : "âŒ è™§æ"}</td>
        `;
        tableBody.appendChild(row);
    });
}


am5.ready(function() {
  var root = am5.Root.new("chartdiv");
  root.setThemes([am5themes_Animated.new(root)]);

  var stockChart = root.container.children.push(am5stock.StockChart.new(root, {}));

  // =================================
  // 1. ä¸»é¢æ¿ (Kç·šåœ–)
  // =================================
  var mainPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    wheelY: "zoomX",
    height: am5.percent(50), 
    layout: root.verticalLayout
  }));

  var dateAxisMain = mainPanel.xAxes.push(am5xy.DateAxis.new(root, {
    baseInterval: { timeUnit: "minute", count: 1 },
    renderer: am5xy.AxisRendererX.new(root, {}),
    tooltip: am5.Tooltip.new(root, {})
  }));

  var valueAxis = mainPanel.yAxes.push(am5xy.ValueAxis.new(root, {
    renderer: am5xy.AxisRendererY.new(root, { pan: "zoom" }),
    tooltip: am5.Tooltip.new(root, {})
  }));

  var candleSeries = mainPanel.series.push(am5xy.CandlestickSeries.new(root, {
    name: "åƒ¹æ ¼",
    clustered: false,
    openValueYField: "open",
    highValueYField: "high",
    lowValueYField: "low",
    valueYField: "close",
    valueXField: "date",
    xAxis: dateAxisMain,
    yAxis: valueAxis
  }));

  // æ²å‹•è»¸
  mainPanel.set("scrollbarX", am5.Scrollbar.new(root, {
    orientation: "horizontal"
  }));

  // è¨Šè™Ÿåœ–å±¤ (ç•«åœ¨ä¸»åœ–ä¸Š)
  var signalSeries = mainPanel.series.push(am5xy.LineSeries.new(root, {
      name: "MACD è¨Šè™Ÿ",
      valueYField: "value",
      valueXField: "date",
      xAxis: dateAxisMain,
      yAxis: valueAxis,
      stroke: undefined 
  }));

  // è¨­å®šè¨Šè™Ÿåœ–ç¤º
  signalSeries.bullets.push(function (root, series, dataItem) {
      var context = dataItem.dataContext;
      var arrowSize = 30;
      var strokeColor = am5.color(0xffffff);
      var strokeWidth = 2;

      if (context.signalType === "buy") {
          return am5.Bullet.new(root, {
              sprite: am5.Triangle.new(root, {
                  fill: am5.color(0x00E676), 
                  stroke: strokeColor,
                  strokeWidth: strokeWidth,
                  width: arrowSize, 
                  height: arrowSize,
                  rotation: 0,
                  centerY: am5.p50, 
                  centerX: am5.p50,
                  tooltipText: "MACD é»ƒé‡‘äº¤å‰ (è²·å…¥)"
              })
          });
      } else if (context.signalType === "sell") {
          return am5.Bullet.new(root, {
              sprite: am5.Triangle.new(root, {
                  fill: am5.color(0xFF1744),
                  stroke: strokeColor,
                  strokeWidth: strokeWidth,
                  width: arrowSize, 
                  height: arrowSize,
                  rotation: 180,
                  centerY: am5.p50, 
                  centerX: am5.p50,
                  tooltipText: "MACD æ­»äº¡äº¤å‰ (è³£å‡º)"
              })
          });
      }
  });

  // =================================
  // 2. MACD é¢æ¿ (ç¨ç«‹)
  // =================================
  var macdPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    height: am5.percent(30), // ä½” 30% é«˜åº¦
    layout: root.verticalLayout
  }));

  var valueAxisMacd = macdPanel.yAxes.push(am5xy.ValueAxis.new(root, {
    renderer: am5xy.AxisRendererY.new(root, { pan: "zoom" })
  }));

  var dateAxisMacd = macdPanel.xAxes.push(am5xy.DateAxis.new(root, {
    baseInterval: { timeUnit: "minute", count: 1 },
    renderer: am5xy.AxisRendererX.new(root, { visible: false }), 
    tooltip: am5.Tooltip.new(root, {})
  }));

  // æŸ±ç‹€åœ– (Histogram)
  var histSeries = macdPanel.series.push(am5xy.ColumnSeries.new(root, {
    name: "Histogram",
    valueYField: "histogram",
    valueXField: "date",
    xAxis: dateAxisMacd,
    yAxis: valueAxisMacd,
    clustered: false
  }));

  // æŸ±ç‹€åœ–é¡è‰² (æ­£ç¶ è² ç´…)
  histSeries.columns.template.adapters.add("fill", function(fill, target) {
    var dataItem = target.dataItem;
    if (dataItem) {
      return dataItem.get("valueY") >= 0 ? am5.color(0x00C853) : am5.color(0xD50000);
    }
    return fill;
  });
  histSeries.columns.template.adapters.add("stroke", function(fill, target) {
    var dataItem = target.dataItem;
    if (dataItem) {
      return dataItem.get("valueY") >= 0 ? am5.color(0x00C853) : am5.color(0xD50000);
    }
    return fill;
  });

  // DIF å¿«ç·š (è—è‰²)
  var difSeries = macdPanel.series.push(am5xy.LineSeries.new(root, {
      name: "DIF",
      valueYField: "dif",
      valueXField: "date",
      xAxis: dateAxisMacd,
      yAxis: valueAxisMacd,
      stroke: am5.color(0x2962FF),
      strokeWidth: 2
  }));

  // DEM è¨Šè™Ÿç·š (æ©˜è‰²)
  var demSeries = macdPanel.series.push(am5xy.LineSeries.new(root, {
      name: "DEM",
      valueYField: "dem",
      valueXField: "date",
      xAxis: dateAxisMacd,
      yAxis: valueAxisMacd,
      stroke: am5.color(0xFF6D00),
      strokeWidth: 2
  }));

  // =================================
  // 3. æˆäº¤é‡é¢æ¿
  // =================================
  var volumePanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    height: am5.percent(20), // ä½” 20% é«˜åº¦
    layout: root.verticalLayout
  }));
  var volumeAxis = volumePanel.yAxes.push(am5xy.ValueAxis.new(root, { renderer: am5xy.AxisRendererY.new(root, { inside: true }) }));
  var dateAxisVolume = volumePanel.xAxes.push(am5xy.DateAxis.new(root, { baseInterval: { timeUnit: "minute", count: 1 }, renderer: am5xy.AxisRendererX.new(root, { visible: false }) }));
  var volumeSeries = volumePanel.series.push(am5xy.ColumnSeries.new(root, {
    valueXField: "date", valueYField: "volume", xAxis: dateAxisVolume, yAxis: volumeAxis
  }));
  
  volumeSeries.columns.template.adapters.add("fill", function(fill, target) {
    var dataItem = target.dataItem;
    if (dataItem) { 
        return dataItem.dataContext.close > dataItem.dataContext.open ? am5.color(0xff0000) : am5.color(0x00aa00); 
    }
    return fill;
  });

  // =================================
  // è³‡æ–™æ›´æ–°èˆ‡ API ä¸²æ¥
  // =================================
  function updateChartData(data) {
      if (!data || data.length === 0) { alert("ç„¡è³‡æ–™"); return; }
      
      // 1. è¨­å®š K ç·šèˆ‡æˆäº¤é‡
      candleSeries.data.setAll(data);
      volumeSeries.data.setAll(data);

      // 2. è¨ˆç®— MACD
      let macdData = calculateMACD(data, 12, 26, 9);
      
      // 3. è¨­å®š MACD é¢æ¿è³‡æ–™
      difSeries.data.setAll(macdData);
      demSeries.data.setAll(macdData);
      histSeries.data.setAll(macdData);

      // 4. è¨ˆç®—ä¸¦è¨­å®šäº¤å‰è¨Šè™Ÿ
      let signals = calculateMACDCrossovers(macdData);
      signalSeries.data.setAll(signals);

      // 5. è¨ˆç®—å›æ¸¬ç¸¾æ•ˆ (æ–°å¢)
      calculateAndRenderPerformance(signals);
  }

  async function fetchCoinHistory(coinId, start, end) {
    const url = new URL(`/coin-history/${coinId}/`, window.location.origin);
    url.searchParams.append("start", start.toISOString());
    url.searchParams.append("end", end.toISOString());
    try {
        document.getElementById('loadingText').textContent = "è¼‰å…¥ä¸­...";
        const resp = await fetch(url);
        const json = await resp.json();
        document.getElementById('loadingText').textContent = "";
        return json.data;
    } catch (e) {
        console.error(e);
        return [];
    }
  }

  if (initialData && initialData.length > 0) { updateChartData(initialData); }
  initDateInputs();
  document.getElementById('btnQuery').addEventListener('click', async () => {
    const start = new Date(document.getElementById('startDate').value);
    const end = new Date(document.getElementById('endDate').value);
    const newData = await fetchCoinHistory(coinId, start, end);
    updateChartData(newData);
  });

});
</script>
</body>
</html>
{% endblock %}