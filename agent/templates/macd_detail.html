{% extends "base.html" %}

{% block title %}MACD 策略詳細頁面{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>加密貨幣 K 線圖 - MACD 詳情</title>
  <style>
    /* === 全域樣式設定 === */
    body {
        background-color: #f5f5f5;
        color: #333;
        font-family: sans-serif;
    }
    #chartdiv { 
        width: 100%; 
        height: 800px; /* 加高高度以容納 MACD 面板 */
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    #controls { 
        margin-bottom: 20px; 
        padding: 15px; 
        border-radius: 8px; 
        display: flex; 
        gap: 15px; 
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        color: #333;
    }
    label { font-weight: bold; }
    input { 
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
        background: #fff; 
        color: #333;
    }
    button { 
        padding: 8px 15px;
        border-radius: 4px;
        background-color: #2962FF; 
        color: white; 
        border: none; 
        cursor: pointer; 
    }
    button:hover { background-color: #1e4bb5; }
    
    /* === 策略資訊面板樣式 === */
    .strategy-panel {
      background: #fff;
      margin: 0 0 20px 0;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }

    .strategy-info {
      flex: 2;
      min-width: 300px;
    }
    
    .strategy-info h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      font-size: 1.2rem;
    }

    .strategy-rules {
      list-style: none;
      padding: 0;
      margin: 0;
      color: #555;
      line-height: 1.6;
    }

    .strategy-rules li {
      margin-bottom: 8px;
    }

    /* 強調文字 */
    .highlight-buy { color: #00C853; font-weight: bold; }
    .highlight-sell { color: #D50000; font-weight: bold; }

    /* 圖例區域 */
    .chart-legend {
      flex: 1;
      min-width: 200px;
      background: #fafafa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #eee;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #666;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      display: inline-block;
      margin-right: 8px;
      border-radius: 2px;
    }

    /* MACD 圖例顏色 */
    .bg-dif { background-color: #2962FF; } /* 快線藍色 */
    .bg-dem { background-color: #FF6D00; } /* 訊號線橘色 */
    .bg-hist-pos { background-color: #00C853; }
    .bg-hist-neg { background-color: #D50000; }

    .icon-buy { 
      width: 0; height: 0; 
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid #00C853; 
      margin-right: 8px;
    }
    .icon-sell { 
      width: 0; height: 0; 
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 10px solid #D50000; 
      margin-right: 8px;
    }

    /* AI 分析區塊 */
    .ai-insight-box {
      background: linear-gradient(to right, #f8f9fa, #ffffff);
      border-left: 5px solid #673AB7; /* MACD 用紫色系區隔 */
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      line-height: 1.6;
      color: #333;
      text-align: left;
    }
    
    .ai-insight-box h3 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 1.3rem;
    }
    .ai-insight-box strong {
      color: #673AB7; 
    }
  </style>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/stock.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>

<div class="strategy-panel">
  <div class="strategy-info">
    <h3>策略邏輯：MACD 趨勢動能指標</h3>
    <ul class="strategy-rules">
      <li>
        <strong>參數設定：</strong> 快線 Fast EMA (12)、慢線 Slow EMA (26)、訊號線 Signal (9)。
      </li>
      <li>
        <span class="highlight-buy">買入訊號 (黃金交叉)：</span> 
        當 <span style="color:#2962FF; font-weight:bold;">DIF 快線</span> 
        向上突破 <span style="color:#FF6D00; font-weight:bold;">DEM 訊號線</span>，且柱狀圖由負轉正。
      </li>
      <li>
        <span class="highlight-sell">賣出訊號 (死亡交叉)：</span> 
        當 <span style="color:#2962FF; font-weight:bold;">DIF 快線</span> 
        向下跌破 <span style="color:#FF6D00; font-weight:bold;">DEM 訊號線</span>，且柱狀圖由正轉負。
      </li>
    </ul>
  </div>

  <div class="chart-legend">
    <div style="font-weight:bold; margin-bottom:10px;">MACD 圖例</div>
    <div class="legend-item">
      <span class="legend-color bg-dif"></span> DIF (快慢線差)
    </div>
    <div class="legend-item">
      <span class="legend-color bg-dem"></span> DEM (訊號線)
    </div>
    <div class="legend-item">
      <span class="legend-color bg-hist-pos"></span> 柱狀圖 (多頭)
    </div>
    <div class="legend-item">
      <span class="legend-color bg-hist-neg"></span> 柱狀圖 (空頭)
    </div>
    <div class="legend-item">
      <span class="icon-buy"></span> 買入訊號
    </div>
    <div class="legend-item">
      <span class="icon-sell"></span> 賣出訊號
    </div>
  </div>
</div>

<div id="controls">
  <label>開始時間：
    <input type="datetime-local" id="startDate" />
  </label>
  <label>結束時間：
    <input type="datetime-local" id="endDate" />
  </label>
  <button id="btnQuery">查詢區間</button>
  <span id="loadingText" style="margin-left: 10px; color: #666;"></span>
</div>

<div id="chartdiv"></div>

<div class="ai-insight-box">
    {{ ai_analysis|safe }}
</div>

<script>
const initialData = {{ chart_data|safe }};
const coinId = {{ coin_id }};

function toDatetimeLocalString(date) {
  const offset = date.getTimezoneOffset();
  const local = new Date(date.getTime() - offset * 60000);
  return local.toISOString().slice(0, 16);
}

function initDateInputs() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 30);
    document.getElementById('startDate').value = toDatetimeLocalString(start);
    document.getElementById('endDate').value = toDatetimeLocalString(end);
}

// ============================================
//  MACD 數學邏輯區
// ============================================

// 通用的 EMA 計算函數
// data: 原始陣列
// period: 週期
// field: 要計算的欄位名稱 (例如 'close' 或 'dif')
function calculateEMAGeneric(data, period, field) {
    let k = 2 / (period + 1);
    let emaArray = []; // 儲存單純數值
    let resultData = []; // 儲存完整物件
    
    if (data.length > 0) {
        // 初始值通常用 SMA 或第一筆數據，這裡簡化用第一筆
        let firstVal = data[0][field]; 
        if(firstVal === undefined) firstVal = 0;

        let ema = firstVal;
        
        for (let i = 0; i < data.length; i++) {
            let val = data[i][field];
            if(val !== undefined && val !== null) {
                ema = val * k + ema * (1 - k);
            }
            emaArray.push(ema);
            resultData.push({
                date: data[i].date,
                value: ema
            });
        }
    }
    return { values: emaArray, data: resultData };
}

// 計算 MACD
function calculateMACD(data, fastPeriod=12, slowPeriod=26, signalPeriod=9) {
    // 1. 計算 Fast EMA (12)
    const fastEMA = calculateEMAGeneric(data, fastPeriod, "close").values;
    // 2. 計算 Slow EMA (26)
    const slowEMA = calculateEMAGeneric(data, slowPeriod, "close").values;
    
    // 3. 計算 DIF = Fast - Slow
    let difData = [];
    for(let i=0; i<data.length; i++){
        let dif = fastEMA[i] - slowEMA[i];
        difData.push({
            date: data[i].date,
            dif: dif,       // 給下一步計算 EMA 用
            close: data[i].close // 保留收盤價供參考
        });
    }

    // 4. 計算 DEM (Signal Line) = EMA(DIF, 9)
    const demValues = calculateEMAGeneric(difData, signalPeriod, "dif").values;

    // 5. 組合最終資料 (含 Histogram)
    let macdResult = [];
    for(let i=0; i<data.length; i++){
        let dif = difData[i].dif;
        let dem = demValues[i];
        let hist = dif - dem;
        
        macdResult.push({
            date: data[i].date,
            dif: dif,
            dem: dem,
            histogram: hist,
            close: data[i].close
        });
    }
    return macdResult;
}

// 計算交叉訊號 (根據 MACD 結果)
function calculateMACDCrossovers(macdData) {
    let signals = [];
    // 從第 26 筆之後開始判斷較準確，避免初期 EMA 不穩，但這裡簡單從 1 開始
    for (let i = 1; i < macdData.length; i++) {
        let prevDif = macdData[i-1].dif;
        let prevDem = macdData[i-1].dem;
        let currDif = macdData[i].dif;
        let currDem = macdData[i].dem;
        
        // 黃金交叉: DIF 向上突破 DEM
        if (prevDif <= prevDem && currDif > currDem) {
            signals.push({
                date: macdData[i].date,
                value: macdData[i].close, // 訊號畫在 K 線收盤價上
                signalType: "buy",
                description: "MACD 黃金交叉"
            });
        }
        // 死亡交叉: DIF 向下跌破 DEM
        else if (prevDif >= prevDem && currDif < currDem) {
            signals.push({
                date: macdData[i].date,
                value: macdData[i].close,
                signalType: "sell",
                description: "MACD 死亡交叉"
            });
        }
    }
    return signals;
}


am5.ready(function() {
  var root = am5.Root.new("chartdiv");
  root.setThemes([am5themes_Animated.new(root)]);

  var stockChart = root.container.children.push(am5stock.StockChart.new(root, {}));

  // =================================
  // 1. 主面板 (K線圖)
  // =================================
  var mainPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    wheelY: "zoomX",
    height: am5.percent(50), // 調整比例，留空間給 MACD
    layout: root.verticalLayout
  }));

  var dateAxisMain = mainPanel.xAxes.push(am5xy.DateAxis.new(root, {
    baseInterval: { timeUnit: "minute", count: 1 },
    renderer: am5xy.AxisRendererX.new(root, {}),
    tooltip: am5.Tooltip.new(root, {})
  }));

  var valueAxis = mainPanel.yAxes.push(am5xy.ValueAxis.new(root, {
    renderer: am5xy.AxisRendererY.new(root, { pan: "zoom" }),
    tooltip: am5.Tooltip.new(root, {})
  }));

  var candleSeries = mainPanel.series.push(am5xy.CandlestickSeries.new(root, {
    name: "價格",
    clustered: false,
    openValueYField: "open",
    highValueYField: "high",
    lowValueYField: "low",
    valueYField: "close",
    valueXField: "date",
    xAxis: dateAxisMain,
    yAxis: valueAxis
  }));

  // 捲動軸
  mainPanel.set("scrollbarX", am5.Scrollbar.new(root, {
    orientation: "horizontal"
  }));

  // 訊號圖層 (畫在主圖上)
  var signalSeries = mainPanel.series.push(am5xy.LineSeries.new(root, {
      name: "MACD 訊號",
      valueYField: "value",
      valueXField: "date",
      xAxis: dateAxisMain,
      yAxis: valueAxis,
      stroke: undefined 
  }));

  // 設定訊號圖示
  signalSeries.bullets.push(function (root, series, dataItem) {
      var context = dataItem.dataContext;
      var arrowSize = 30;
      var strokeColor = am5.color(0xffffff);
      var strokeWidth = 2;

      if (context.signalType === "buy") {
          return am5.Bullet.new(root, {
              sprite: am5.Triangle.new(root, {
                  fill: am5.color(0x00E676), 
                  stroke: strokeColor,
                  strokeWidth: strokeWidth,
                  width: arrowSize, 
                  height: arrowSize,
                  rotation: 0,
                  centerY: am5.p50, 
                  centerX: am5.p50,
                  tooltipText: "MACD 黃金交叉 (買入)"
              })
          });
      } else if (context.signalType === "sell") {
          return am5.Bullet.new(root, {
              sprite: am5.Triangle.new(root, {
                  fill: am5.color(0xFF1744),
                  stroke: strokeColor,
                  strokeWidth: strokeWidth,
                  width: arrowSize, 
                  height: arrowSize,
                  rotation: 180,
                  centerY: am5.p50, 
                  centerX: am5.p50,
                  tooltipText: "MACD 死亡交叉 (賣出)"
              })
          });
      }
  });

  // =================================
  // 2. MACD 面板 (獨立)
  // =================================
  var macdPanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    height: am5.percent(30), // 佔 30% 高度
    layout: root.verticalLayout
  }));

  var valueAxisMacd = macdPanel.yAxes.push(am5xy.ValueAxis.new(root, {
    renderer: am5xy.AxisRendererY.new(root, { pan: "zoom" })
  }));

  var dateAxisMacd = macdPanel.xAxes.push(am5xy.DateAxis.new(root, {
    baseInterval: { timeUnit: "minute", count: 1 },
    renderer: am5xy.AxisRendererX.new(root, { visible: false }), // 隱藏 X 軸文字，共用主圖的時間軸
    tooltip: am5.Tooltip.new(root, {})
  }));

  // 柱狀圖 (Histogram)
  var histSeries = macdPanel.series.push(am5xy.ColumnSeries.new(root, {
    name: "Histogram",
    valueYField: "histogram",
    valueXField: "date",
    xAxis: dateAxisMacd,
    yAxis: valueAxisMacd,
    clustered: false
  }));

  // 柱狀圖顏色 (正綠負紅)
  histSeries.columns.template.adapters.add("fill", function(fill, target) {
    var dataItem = target.dataItem;
    if (dataItem) {
      return dataItem.get("valueY") >= 0 ? am5.color(0x00C853) : am5.color(0xD50000);
    }
    return fill;
  });
  histSeries.columns.template.adapters.add("stroke", function(fill, target) {
    var dataItem = target.dataItem;
    if (dataItem) {
      return dataItem.get("valueY") >= 0 ? am5.color(0x00C853) : am5.color(0xD50000);
    }
    return fill;
  });

  // DIF 快線 (藍色)
  var difSeries = macdPanel.series.push(am5xy.LineSeries.new(root, {
      name: "DIF",
      valueYField: "dif",
      valueXField: "date",
      xAxis: dateAxisMacd,
      yAxis: valueAxisMacd,
      stroke: am5.color(0x2962FF),
      strokeWidth: 2
  }));

  // DEM 訊號線 (橘色)
  var demSeries = macdPanel.series.push(am5xy.LineSeries.new(root, {
      name: "DEM",
      valueYField: "dem",
      valueXField: "date",
      xAxis: dateAxisMacd,
      yAxis: valueAxisMacd,
      stroke: am5.color(0xFF6D00),
      strokeWidth: 2
  }));

  // =================================
  // 3. 成交量面板
  // =================================
  var volumePanel = stockChart.panels.push(am5stock.StockPanel.new(root, {
    wheelX: "panX",
    height: am5.percent(20), // 佔 20% 高度
    layout: root.verticalLayout
  }));
  var volumeAxis = volumePanel.yAxes.push(am5xy.ValueAxis.new(root, { renderer: am5xy.AxisRendererY.new(root, { inside: true }) }));
  var dateAxisVolume = volumePanel.xAxes.push(am5xy.DateAxis.new(root, { baseInterval: { timeUnit: "minute", count: 1 }, renderer: am5xy.AxisRendererX.new(root, { visible: false }) }));
  var volumeSeries = volumePanel.series.push(am5xy.ColumnSeries.new(root, {
    valueXField: "date", valueYField: "volume", xAxis: dateAxisVolume, yAxis: volumeAxis
  }));
  
  volumeSeries.columns.template.adapters.add("fill", function(fill, target) {
    var dataItem = target.dataItem;
    if (dataItem) { 
        return dataItem.dataContext.close > dataItem.dataContext.open ? am5.color(0xff0000) : am5.color(0x00aa00); 
    }
    return fill;
  });

  // =================================
  // 資料更新與 API 串接
  // =================================
  function updateChartData(data) {
      if (!data || data.length === 0) { alert("無資料"); return; }
      
      // 1. 設定 K 線與成交量
      candleSeries.data.setAll(data);
      volumeSeries.data.setAll(data);

      // 2. 計算 MACD
      let macdData = calculateMACD(data, 12, 26, 9);
      
      // 3. 設定 MACD 面板資料
      difSeries.data.setAll(macdData);
      demSeries.data.setAll(macdData);
      histSeries.data.setAll(macdData);

      // 4. 計算並設定交叉訊號
      let signals = calculateMACDCrossovers(macdData);
      signalSeries.data.setAll(signals);
  }

  async function fetchCoinHistory(coinId, start, end) {
    const url = new URL(`/coin-history/${coinId}/`, window.location.origin);
    url.searchParams.append("start", start.toISOString());
    url.searchParams.append("end", end.toISOString());
    try {
        document.getElementById('loadingText').textContent = "載入中...";
        const resp = await fetch(url);
        const json = await resp.json();
        document.getElementById('loadingText').textContent = "";
        return json.data;
    } catch (e) {
        console.error(e);
        return [];
    }
  }

  if (initialData && initialData.length > 0) { updateChartData(initialData); }
  initDateInputs();
  document.getElementById('btnQuery').addEventListener('click', async () => {
    const start = new Date(document.getElementById('startDate').value);
    const end = new Date(document.getElementById('endDate').value);
    const newData = await fetchCoinHistory(coinId, start, end);
    updateChartData(newData);
  });

});
</script>
</body>
</html>
{% endblock %}