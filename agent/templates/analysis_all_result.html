{% extends "base.html" %}

{% block title %}åˆ†æçµæœ{% endblock %}

{% block content %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Plugin: é¡¯ç¤ºæ•¸å€¼åœ¨åœ–ä¸Š -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
  .chart-container {
    max-width: 300px;
    margin: 30px auto;
  }

  /* æ·¡å…¥å‹•ç•« */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* æ·¡å‡ºå‹•ç•« */
  @keyframes fadeOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }

    to {
      opacity: 0;
      transform: translateY(20px);
    }
  }

  .fade-in {
    opacity: 0;
    animation: fadeIn 0.8s ease-in-out forwards;
  }

  .fade-out {
    animation: fadeOut 0.5s ease-in-out forwards;
  }

  #page-content{
    max-width: 900px;
    margin: 40px auto;
    background-color: #ffffff;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    text-align: left;
  }
  #page-content:hover{
    transform: translateY(-10px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
  }
  @media (max-width: 768px) {
    #page-content {
        padding: 20px;
    }

    h1 {
        font-size: 2em;
    }

    h2 {
        font-size: 1.5em;
    }
  }

  h2 {
      font-size: 1.8em;
      color: #444;
      margin-bottom: 10px;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 5px;
      color: #4CAF50;
  }
</style>


<!-- åˆ†æé é¢é ‚éƒ¨å€å¡Š -->
<div id="page-content" class="container mt-5 fade-in text-center">
<div class="row mb-5">
  <!-- æ•´é«”å®Œæˆåº¦åœ“é¤…åœ– -->
  <div class="col-lg-6 col-12 text-center mb-4 mb-lg-0">
    <h5 class="mb-3 fw-bold text-primary">æ•´é«”å®Œæˆåº¦</h5>
    <hr class="w-25 mx-auto" style="border-top: 3px solid #0d6efd;">
    <div class="d-flex justify-content-center mb-4">
    <canvas id="completionChart" width="300" height="300"></canvas>
    </div>
  </div>
  <!-- å•å·å †ç–Šé•·æ¢åœ– -->
  <div class="col-lg-6 col-12 text-center">
    <h5 class="mb-3 fw-bold text-primary">å„å•å·å®Œæˆåº¦</h5>
    <hr class="w-25 mx-auto" style="border-top: 3px solid #0d6efd;">
    <div class="d-flex justify-content-center mb-4">
    <canvas id="stackedBarChart" width="400" height="300"></canvas>
    </div>
  </div>
</div>


  <!-- äº’å‹•æç¤ºå€ -->
  {% if overall_progress2.answered ==  0 %}
  <div class="mb-3">
    <div id="progressHint" class="alert alert-warning">
      âš  æ‚¨å°šæœ‰å•å·é¡Œç›®æœªå®Œæˆï¼Œå®Œæˆå•å·å¯ç²å¾—æ›´ç²¾æº–çš„ç¸½çµæœåˆ†æã€‚
    </div>
    <a href="{% url 'agent:questionnaire_list' %}" class="btn btn-warning">
      å‰å¾€å®Œæˆå•å·
    </a>
  </div>


{% else %}
<div id="page-content" class="container mt-5 fade-in">
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary">ç¸½åˆ†æçµæœ</h2>
    <hr class="w-25 mx-auto" style="border-top: 3px solid #0d6efd;">
  </div>

  {% if analysis %}
  <div class="card shadow-sm mb-4 border-0 fade-in" style="animation-delay: 0.2s;">
    <div class="card-header bg-primary text-white fw-bold">åˆ†ææ‘˜è¦</div>
    <div class="card-body" style="white-space: pre-wrap;">{{ analysis }}</div>
  </div>
  {% endif %}
</div>


<!-- æ ¸å¿ƒé¢¨éšªé¢å‘é›·é”åœ– -->
 <div class="row justify-content-center">
  <div class="col-md-6 mb-4 d-flex flex-column align-items-center text-center">
    <h5>æ ¸å¿ƒé¢¨éšªé¢å‘é›·é”åœ–</h5>
    <div class="mb-4">
      <canvas id="radarCore" width="300" height="300"></canvas>
    </div>
  </div>
</div>


  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary">é¢¨éšªå±¬æ€§åˆ†æçµæœ<br></h2>
    <hr class="w-25 mx-auto" style="border-top: 3px solid #0d6efd;">
      <small>æ³¨ï¼šæ¡ç”¨å•å·ç¬¬ 2ã€3ã€4ã€9 é¡Œé€²è¡Œåˆ†æ</small>
  </div>

<!-- åˆ†æçµæœ -->
 <hr  class="border-4 border-primary">
<div class="table-responsive mb-4">
  <table class="table table-bordered text-center">
    <tbody>
      <tr>
        <th>æ‚¨çš„é¢¨éšªå±¬æ€§&nbsp;&nbsp;<a href="#more-content" class="more-link"><small>äº†è§£æ›´å¤š...</small></th>
        <th>æ‚¨çš„è³‡ç”¢å»ºè­°é…ç½®&nbsp;&nbsp;<a href="#more-content" class="more-link"><small>äº†è§£æ›´å¤š...</small></a></th>
      </tr>
      <tr>
        <td>{{ risk_type }}</td>
        <td>{{ suggestion }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div class="row mb-5">
  <!-- åœ“é¤…åœ– å·¦å´ -->
  <div class="col-lg-6 col-12 text-center mb-4 mb-lg-0">
    <div class="mb-4">
      <h5 class="mb-2">
        æŠ•è³‡å¹£ç¨®èˆ‡é‡‘é¡
      </h5>
    </div>
    <div class="chart-container" style="max-width: 80%; margin: 0 auto;">
      <canvas id="allocationChart"></canvas>
    </div>
  </div> 
  <!-- å·¦å´ col çµæŸ -->

  <!-- æ¨è–¦å¹£ç¨®è¡¨æ ¼ å³å´ -->
  <div class="col-lg-6 col-12">
    <div class="table-responsive mb-4">
      <table class="table table-bordered text-center">
        <thead class="table-light">
          <tr>
            <th>é¡åˆ¥</th>
            <th>æ¨è–¦å¹£ç¨®</th>
          </tr>
        </thead>
        <tbody>
          {% if recommended_coins %}
            {% for category, coins in recommended_coins.items %}
            <tr>
                <td>{{ category }}</td>
                <td class="text-start">
                    {% if coins %}
                        {% for coin in coins %} &nbsp;&nbsp;
                            <span class="inline-flex items-center mr-2 ">
                                {% if coin.logo_url %}
                                    <img src="{{ coin.logo_url }}" alt="{{ coin.coinname }}" 
                                        style="width:1em; height:1em; vertical-align:middle; margin-right:0.25em; border-radius:50%;">
                                {% endif %}
                                <a href="{% url 'crypto_detail' coin_id=coin.id %}" class="text-blue-500 hover:underline">
                                    {{ coin.coinname }}
                                </a>
                            </span>
                        {% endfor %}
                        <small class="text-end">
                            &nbsp;&nbsp;<a href="{% url 'crypto_list' %}" class="text-blue-500 text-sm">æŸ¥çœ‹æ›´å¤š...</a>
                        </small>
                    {% else %}
                        æš«ç„¡æ¨è–¦
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="2">æš«ç„¡æ¨è–¦</td>
            </tr>
            {% endif %}
        </tbody>
      </table>
    </div>
    <!-- æŠ•è³‡é‡‘é¡è¼¸å…¥èˆ‡è¨ˆç®— -->
    <h3 class="mt-4 text-center">é¸æ“‡æŠ•è³‡å¹£ç¨®èˆ‡é‡‘é¡</h3>
    <div class="mb-3" style="max-width: 300px; margin: 0 auto;">
      <input type="number" id="investmentAmount" class="form-control" placeholder="è«‹è¼¸å…¥æŠ•è³‡é‡‘é¡" />
    </div>

    <div class="mb-3 text-center">
      <label class="form-check-label me-2"><input type="checkbox" class="coinCheckbox" value="ç©©å®šå¹£" checked> ç©©å®šå¹£</label>
      <label class="form-check-label me-2"><input type="checkbox" class="coinCheckbox" value="ä¸»æµå¹£" checked> ä¸»æµå¹£</label>
      <label class="form-check-label me-2"><input type="checkbox" class="coinCheckbox" value="æˆé•·å¹£" checked> æˆé•·å¹£</label>
      <label class="form-check-label me-2"><input type="checkbox" class="coinCheckbox" value="è¿·å› å¹£" checked> è¿·å› å¹£</label>
    </div>

    <div class="text-center mb-4">
      <button class="btn btn-primary" id="calculateBtn">è¨ˆç®—æŠ•å…¥é‡‘é¡</button>
    </div>

    <div id="investmentResult" class="mt-3"></div>

    {{ allocation_data|json_script:"allocation-data" }}
    {{ allocation|json_script:"allocation-percent" }}

  </div>
</div> 

<!-- Accordion -->
 <div class="accordion mt-5 shadow-sm" id="accordionExample">

  <!-- é¢¨éšªå±¬æ€§åˆ†ç´šèªªæ˜ -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingRisk">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRisk"
        aria-expanded="true" aria-controls="collapseRisk">
        é¢¨éšªå±¬æ€§åˆ†ç´šèªªæ˜
      </button>
    </h2>
    <div id="collapseRisk" class="accordion-collapse collapse show" aria-labelledby="headingRisk"
      data-bs-parent="#accordionExample">
      <div class="accordion-body">
        <h6 class="mt-4 mb-2 text-success fw-bold">ğŸ’¡ å»ºè­°è³‡ç”¢é…ç½®ï¼ˆä¾å±¬æ€§è‡ªå‹•èª¿æ•´ï¼‰</h6>
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>é¢¨éšªå±¬æ€§</th>
              <th>ç‰¹æ€§èªªæ˜</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>ä¿å®ˆå‹</td>
              <td>é‡è¦–è³‡ç”¢å®‰å…¨ï¼Œåå¥½ä½é¢¨éšªã€ç©©å®šå›å ±çš„è³‡ç”¢çµ„åˆã€‚</td>
            </tr>
            <tr>
              <td>ç©©å¥å‹</td>
              <td>åœ¨ç©©å®šèˆ‡æˆé•·é–“å–å¾—å¹³è¡¡ï¼Œé©åº¦æ‰¿æ“”é¢¨éšªä»¥è¿½æ±‚å ±é…¬ã€‚</td>
            </tr>
            <tr>
              <td>ç©æ¥µå‹</td>
              <td>è¿½æ±‚é«˜å ±é…¬ï¼Œé¡˜æ„æ‰¿æ“”è¼ƒå¤§æ³¢å‹•ï¼Œåå¥½é«˜æˆé•·å‹è³‡ç”¢ã€‚</td>
            </tr>
          </tbody>
        </table>

        <p class="text-muted mt-3">
          âš ï¸ æœ¬åˆ†æåƒ…ä¾›åƒè€ƒï¼Œä¸¦éæŠ•è³‡å»ºè­°ã€‚è«‹ä¾å€‹äººè²¡å‹™ç‹€æ³èˆ‡é¢¨éšªæ‰¿å—èƒ½åŠ›è¬¹æ…æ±ºç­–ã€‚
        </p>
      </div>
    </div>
  </div>

  <!-- å¹£ç¨®åˆ†é¡èªªæ˜ -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingCoins">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
        data-bs-target="#collapseCoins" aria-expanded="false" aria-controls="collapseCoins">
        å¹£ç¨®åˆ†é¡èªªæ˜
      </button>
    </h2>
    <div id="collapseCoins" class="accordion-collapse collapse" aria-labelledby="headingCoins"
      data-bs-parent="#accordionExample">
      <div class="accordion-body">
        <p class="mb-3 text-secondary">ç‚ºäº†å»ºç«‹æ›´æ¸…æ™°çš„é…ç½®é‚è¼¯ï¼Œç³»çµ±å°‡å¹£ç¨®åŠƒåˆ†ç‚ºä»¥ä¸‹å››å¤§é¡ï¼š</p>
        <table class="table table-bordered align-middle">
          <thead class="table-success">
            <tr>
              <th>åˆ†é¡</th>
              <th>å®šç¾©</th>
              <th>ç‰¹å¾µ / åˆ†é¡ä¾æ“š</th>
              <th>ç”¨é€” / é©åˆæ—ç¾¤</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>ç©©å®šå¹£</td>
              <td>åƒ¹æ ¼èˆ‡æ³•å¹£æ›é‰¤çš„åŠ å¯†è²¨å¹£</td>
              <td>æ³¢å‹•ä½ï¼Œä¾æ³•å¹£ï¼ˆå¦‚ç¾å…ƒï¼‰éŒ¨å®š</td>
              <td>é¿éšªã€è³‡é‡‘åœæ³Šï¼Œé©åˆé¢¨éšªä½è€…</td>
            </tr>
            <tr>
              <td>ä¸»æµå¹£</td>
              <td>å¸‚å€¼é«˜ã€æµå‹•æ€§å¼·çš„åŠ å¯†è²¨å¹£</td>
              <td>å¸‚å€¼æ’åå‰æ®µã€ç”Ÿæ…‹æˆç†Ÿ</td>
              <td>æ ¸å¿ƒé…ç½®ï¼Œé©åˆé•·æœŸç©©å¥æŠ•è³‡è€…</td>
            </tr>
            <tr>
              <td>æˆé•·å¹£</td>
              <td>å…·æŠ€è¡“å‰µæ–°æˆ–æ‡‰ç”¨æ½›åŠ›çš„å¹£ç¨®</td>
              <td>å¸‚å€¼ä¸­ç­‰ã€å…·æˆé•·æ½›åŠ›</td>
              <td>ä¸­é¢¨éšªä¸­å ±é…¬ï¼Œè¿½æ±‚è³‡æœ¬æˆé•·è€…</td>
            </tr>
            <tr>
              <td>è¿·å› å¹£</td>
              <td>ä»¥ç¤¾ç¾¤ç†±åº¦æˆ–è¿·å› æ–‡åŒ–é©…å‹•</td>
              <td>ç¼ºä¹æ‡‰ç”¨ã€åƒ¹æ ¼æ³¢å‹•åŠ‡çƒˆ</td>
              <td>é«˜é¢¨éšªçŸ­ç·šæŠ•æ©Ÿè€…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>


  <br>
  <div class="text-center" style="animation-delay: 0.6s;">
    <a href="{% url 'agent:questionnaire_list' %}" class="btn btn-secondary px-4" id="back-button">
      â† è¿”å›åˆ—è¡¨
    </a>
  </div>
  {% endif %}
    <script> 
  // ========== æ•´é«”å®Œæˆåº¦åœ“é¤…åœ– ==========
  const overallProgress = {{ overall_progress2.percent|default:0 }};
  const ctxDoughnut = document.getElementById('completionChart').getContext('2d');

  new Chart(ctxDoughnut, {
    type: 'doughnut',
    data: {
      labels: ['å·²å®Œæˆ', 'æœªå®Œæˆ'],
      datasets: [{
        data: [overallProgress, 100 - overallProgress],
        backgroundColor: ['#4CAF50', '#E0E0E0'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: {
          display: true,
          labels: { color: '#333' }
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              return context.label + ': ' + context.parsed + '%';
            }
          }
        },
      }
    },
    plugins: [{
      id: 'centerText',
      beforeDraw(chart) {
        const { ctx, width, height } = chart;
        ctx.save();
        const fontSize = (height / 200).toFixed(2);
        ctx.font = fontSize + "em sans-serif";
        ctx.textBaseline = "middle";
        ctx.textAlign = "center";
        const lines = ["å®Œæˆåº¦", overallProgress + "%"];
        const lineHeight = 35;
        const centerX = width / 2;
        const centerY = height / 1.75;
        lines.forEach((line, i) => {
          ctx.fillText(line, centerX, centerY - lineHeight / 2 + i * lineHeight);
        });
        ctx.restore();
      }
    }]
  });

  // ========== å„å•å·å †ç–Šé•·æ¢åœ– ==========
  const progressData = {{ progress_data|safe }};  
  // Django è¼¸å‡ºæ ¼å¼æ‡‰è©²æ˜¯ï¼š
  // [
  //   {"name": "å•å·2", "answered": 5, "unanswered": 3},
  //   {"name": "å•å·3", "answered": 4, "unanswered": 6},
  //   ...
  // ]

  const ctxBar = document.getElementById('stackedBarChart').getContext('2d');
  new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: progressData.map(item => item.name),
      datasets: [
        {
          label: 'å·²å®Œæˆé¡Œæ•¸',
          data: progressData.map(item => item.answered),
          backgroundColor: '#4CAF50'
        },
        {
          label: 'æœªå®Œæˆé¡Œæ•¸',
          data: progressData.map(item => item.unanswered),
          backgroundColor: '#E0E0E0'
        }
      ]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + context.parsed.y + ' é¡Œ';
            }
          }
        }
      },
      scales: {
        x: {
          stacked: true
        },
        y: {
          stacked: true,
          title: { display: true, text: 'é¡Œæ•¸' }
        }
      }
    }
  });
  </script>
  {% if overall_progress2.answered > 0 %}
  <script>

  // æ ¸å¿ƒé›·é”åœ–
  new Chart(document.getElementById('radarCore').getContext('2d'), {
      type: 'radar',
      data: {
          labels: ['æŠ•è³‡ç¶“é©—','é¢¨éšªåå¥½','æŠ•è³‡ç›®æ¨™','å¿ƒç†è¡Œç‚ºå‚¾å‘','æœªä¾†çœ‹æ³•'],
          datasets:[{
              label:'åˆ†æ•¸ (0~100)',
              data:[
                  {{ core_scores_avg.score_investment_exp }},
                  {{ core_scores_avg.score_risk_pref }},
                  {{ core_scores_avg.score_investment_goal }},
                  {{ core_scores_avg.score_psychology }},
                  {{ core_scores_avg.score_q7 }},

              ],
              backgroundColor:'rgba(54, 162, 235, 0.2)',
              borderColor:'rgba(54, 162, 235, 1)',
              borderWidth:2
          }]
      },
      options:{
          responsive: false,          // âŒ é—œé–‰è‡ªå‹•ç¸®æ”¾
          maintainAspectRatio: false,
          scales:{r:{min:0,max:100}}
      }
  })


      // åœ“é¤…åœ– + æŠ•è³‡é‡‘é¡è¨ˆç®—
      document.addEventListener("DOMContentLoaded", function () {
        const allocationLabels = ['ç©©å®šå¹£', 'ä¸»æµå¹£', 'æˆé•·å¹£', 'è¿·å› å¹£'];
        const allocationData = JSON.parse(document.getElementById('allocation-data').textContent);
        const allocationPercent = JSON.parse(document.getElementById('allocation-percent').textContent);

        let totalAmount = 0;

        // å»ºç«‹åœ“é¤…åœ–
        const ctx = document.getElementById('allocationChart').getContext('2d');
        const myChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: allocationLabels,
            datasets: [{
              data: allocationData, // åˆå§‹é¡¯ç¤ºç™¾åˆ†æ¯”
              backgroundColor: ['#6c757d', '#007bff', '#28a745', '#ffc107', '#dc3545'],
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { 
                display: true, 
                onClick: (e) => {},// ä¸åšä»»ä½•äº‹ï¼Œé€™æ¨£é»åœ–ä¾‹å°±ä¸æœƒéš±è—è³‡æ–™
              },
              datalabels: {
                color: '#fff',
                align: 'center',
                font: { size: 16, weight: 'bold' },
                formatter: function (value, context) {
                  const label = context.chart.data.labels[context.dataIndex];
                  const checkedCoins = Array.from(document.querySelectorAll('.coinCheckbox:checked')).map(cb => cb.value);

                  if (!checkedCoins.includes(label) || value === 0) return '';

                  const totalRatio = checkedCoins.reduce((sum, coin) => sum + (allocationPercent[coin] || 0), 0);

                  if (totalAmount === 0) return `${label}\n${Math.round(value)}%`;

                  // è¨ˆç®—å‘ä¸‹å–æ•´é‡‘é¡
                  let allocatedAmounts = [];
                  let sumAllocated = 0;
                  checkedCoins.forEach(coin => {
                    const amt = Math.floor(totalAmount * allocationPercent[coin] / totalRatio);
                    allocatedAmounts.push({ coin, amt });
                    sumAllocated += amt;
                  });

                  // è¨ˆç®—å·®é¡
                  let remainder = totalAmount - sumAllocated;

                  // æ‰¾æœ€å¤§æ¯”ä¾‹å¹£ç¨®
                  if (remainder > 0) {
                    const maxCoin = allocatedAmounts.reduce((prev, curr) =>
                      (allocationPercent[curr.coin] > allocationPercent[prev.coin]) ? curr : prev
                    );
                    maxCoin.amt += remainder;
                  }

                  const coinAmt = allocatedAmounts.find(item => item.coin === label).amt;
                  return coinAmt > 0
                    ? `${label}\n${coinAmt.toLocaleString()} å…ƒ`
                    : `${label}\n${Math.round(value)}%`;

                }
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        // è¨ˆç®—æŒ‰éˆ•äº‹ä»¶
        document.getElementById('calculateBtn').addEventListener('click', () => {
          const amount = parseFloat(document.getElementById('investmentAmount').value);
          if (isNaN(amount) || amount <= 0) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆæŠ•è³‡é‡‘é¡");
            return;
          }

          const checkedCoins = Array.from(document.querySelectorAll('.coinCheckbox:checked')).map(cb => cb.value);
          if (checkedCoins.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€ç¨®å¹£ç¨®");
            return;
          }

          totalAmount = amount;

          // æ›´æ–°åœ“é¤…åœ–è³‡æ–™ï¼Œåªé¡¯ç¤ºå‹¾é¸çš„å¹£ç¨®
          myChart.data.datasets[0].data = allocationLabels.map(label =>
            checkedCoins.includes(label) ? allocationData[allocationLabels.indexOf(label)] : 0
          );
          myChart.update();

          // å‘ä¸‹å–æ•´ + è£œå·®æ³•è¨ˆç®—çµæœæ¸…å–®
          let allocatedAmounts = [];
          let sumAllocated = 0;

          // è¨ˆç®—ç¸½æ¯”ä¾‹ï¼ˆåªåŒ…å«å‹¾é¸å¹£ç¨®ï¼‰
          const totalRatio = checkedCoins.reduce((sum, c) => sum + allocationPercent[c], 0);

          // å…ˆå‘ä¸‹å–æ•´
          checkedCoins.forEach(coin => {
            const amt = Math.floor(amount * allocationPercent[coin] / totalRatio);
            allocatedAmounts.push({ coin, amt });
            sumAllocated += amt;
          });

          // è¨ˆç®—å·®é¡
          let remainder = amount - sumAllocated;

          // è£œåˆ°æœ€å¤§æ¯”ä¾‹å¹£ç¨®
          if (remainder > 0) {
            const maxCoin = allocatedAmounts.reduce((prev, curr) =>
              allocationPercent[curr.coin] > allocationPercent[prev.coin] ? curr : prev
            );
            maxCoin.amt += remainder;
          }

          // é¡¯ç¤ºçµæœ
          let resultHtml = `<h5>æœ¬æ¬¡é è¨ˆæŠ•å…¥é‡‘é¡ï¼š${amount.toLocaleString()} å…ƒ</h5>`;
          resultHtml += "<h5>å„é¡å¹£ç¨®å»ºè­°æŠ•å…¥é‡‘é¡ï¼š</h5><ul style='list-style:none; padding:0;'>";
          allocatedAmounts.forEach(item => {
            resultHtml += `<li>${item.coin}ï¼š${item.amt.toLocaleString()} å…ƒ</li>`;
          });
          resultHtml += "</ul>";
          document.getElementById('investmentResult').innerHTML = resultHtml;

          document.getElementById('investmentAmount').value = '';
        });
      });
      //-----
      // è¿”å›æŒ‰éˆ•æ·¡å‡ºæ•ˆæœ
      document.addEventListener("DOMContentLoaded", function () {
        const backBtn = document.getElementById("back-button");
        const page = document.getElementById("page-content");

        backBtn.addEventListener("click", function (e) {
          e.preventDefault();
          page.classList.remove("fade-in");
          page.classList.add("fade-out");
          setTimeout(() => {
            window.location.href = backBtn.href;
          }, 500);
        });
      });

    </script>
    {% endif %}
    {% endblock %}